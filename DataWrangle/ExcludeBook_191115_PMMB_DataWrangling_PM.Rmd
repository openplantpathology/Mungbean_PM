# Data wrangling
This file is not complete and there are a number of things that need checking
   - Mean squares are only calculated for the triazoles and controls
   - If the years for each trial are input correctly
   - If the disease and yield errors are calculated and that they are shuffled correctly into the data frame
   - AUDPC needs to be checked for starting dates and if trials have been omitted
   - Check that what is generated from this file matches the main file and update
   - write.csv should have row.names = FALSE


## Import Libraries
```{r message=FALSE, warning=FALSE}
# install.packages("openxlsx")
# install.packages("readxl")
# install.packages("tidyr")
# install.packages("agricolae")

library(openxlsx)
library(readxl)
library(tidyr)
library(dplyr)
library(data.table)
library(agricolae)

source("../R/import_data.R")
PM_MB_means <- import_data()

```

## Functions
```{r functions}

fold_data <- function(new_DataFrame, template_DataFrame){
   for(i in colnames(new_DataFrame)){
      if(i == colnames(new_DataFrame)[1]){
         x1 <- vector()}
      
      cnames1 <- as.character(colnames(new_DataFrame))
      cnames2 <- as.character(colnames(template_DataFrame))
      
      x1 <- c(x1,match(i, cnames2, nomatch = NA)) # MAke a index vector for the location of new_DataFrame col names in template_DataFrame
   }
   
   new_DataFrame[cnames2[!(cnames2 %in% cnames1)]] <- NA # adding column names to new_DataFrame not in template_DataFrame
   new_DataFrame <- 
      new_DataFrame[,c(cnames2, cnames1[is.na(x1)])]  # adding column names to new_DataFrame not in template_DataFrame
   return(new_DataFrame)
}
```


## Data wrangling for each trial
### Hermitage 2010

```{r Hermitage_2010}

Herm_10 <-
   as.data.frame(read_xls(
      "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2010/2010 PMmung Herm/2010 PMmung hermitage RAW field book.xls",
      sheet = "For analysis"
   ), stringsAsFactors == FALSE)


Herm_10 <- Herm_10 %>%
   mutate(trade_name = case_when(`Schedule!` == "U/S" ~ NA_character_,
                                 `Schedule!` == "FirstsignC" ~ " ",
                                 TRUE ~ "Kendon"))%>%
   mutate(fungicide = case_when(`Schedule!` == "U/S" ~ "control",
                                 `Schedule!` == "FirstsignC" ~ "carbendazim",
                                 TRUE ~ "sulphur"))%>%
   mutate(dose_ai.ha = case_when(`Schedule!` == "U/S" ~ 0,
                                 `Schedule!` == "FirstsignC" ~ 250,
                                 TRUE ~ 2400))%>%
   mutate(fungicide_application_1 = case_when(`Schedule!` == "Full Sp" ~ as.Date("2010-02-19", format = "%Y-%m-%d"),
                                              `Schedule!` == "Early Sp" ~ as.Date("2010-02-19", format = "%Y-%m-%d"),
                                              `Schedule!` == "FirstsignC" ~ as.Date("2010-03-18", format = "%Y-%m-%d"),
                                              `Schedule!` == "FirstsignS" ~ as.Date("2010-03-18", format = "%Y-%m-%d"),
                                              `Schedule!` == "U/S" ~ as.Date(NA),
                                              TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_2 = case_when(`Schedule!` == "Full Sp" ~ as.Date("2010-02-26", format = "%Y-%m-%d"),
                                              `Schedule!` == "Early Sp" ~ as.Date("2010-02-26", format = "%Y-%m-%d"),
                                              TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_3 = case_when(`Schedule!` == "Full Sp" ~ as.Date("2010-03-05", format = "%Y-%m-%d"),
                                              TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_4 = case_when(`Schedule!` == "Full Sp" ~ as.Date("2010-03-11", format = "%Y-%m-%d"),
                                              TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_5 = case_when(`Schedule!` == "Full Sp" ~ as.Date("2010-03-18", format = "%Y-%m-%d"),
                                              TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_6 = case_when(`Schedule!` == "Full Sp" ~ as.Date("2010-03-25", format = "%Y-%m-%d"),
                                              TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_7 = case_when(`Schedule!` == "Full Sp" ~ as.Date("2010-03-07", format = "%Y-%m-%d"),
                                              TRUE ~ as.Date(NA)))%>%
   mutate(total_fungicide = case_when(`Schedule!` == "Full Sp" ~ 7,
                                      `Schedule!` == "Early Sp" ~ 2,
                                      `Schedule!` == "FirstsignC" ~ 1,
                                      `Schedule!` == "FirstsignS" ~ 1,
                                      `Schedule!` == "U/S" ~ 0,
                                      TRUE ~ 9999))
   

Herm_10_dat <- 
   data.frame(trial_ref = "mung0910/01",
              year = "2010",
              location = "Hermitage",
              host_genotype = Herm_10$`Cultivar!`,
              trial_design = "RB",
              plot_length = Herm_10$`Length (m)`,
              plot_width = 4,
              plant_density = NA,
              row_spacing = 0.25,
              replicate = Herm_10$`Rep!`,
              planting_date = as.Date("2010-01-22"),
              emergence_date = NA,
              flowering_date = NA,
              pod_fill_date = NA,
              mid_late_pod_fill = NA,
              first_sign_disease = as.Date("2010-03-18"),
              trade_name = Herm_10$trade_name,
              fungicide_ai = Herm_10$fungicide,
              dose_ai.ha = Herm_10$dose_ai.ha,
              n_treatment = Herm_10$`Treat!`,
              fungicide_application_1 = Herm_10$fungicide_application_1,
              fungicide_application_2 = Herm_10$fungicide_application_2,
              fungicide_application_3 = Herm_10$fungicide_application_3,
              fungicide_application_4 = Herm_10$fungicide_application_4,
              fungicide_application_5 = Herm_10$fungicide_application_5,
              fungicide_application_6 = Herm_10$fungicide_application_6,
              fungicide_application_7 = Herm_10$fungicide_application_7,
              total_fungicide = Herm_10$total_fungicide,
              harvest_date = as.Date("2010-05-14"),
              final_assessment = as.Date("2010-04-20"),
              PM_final_severity = Herm_10$P.M.13wap,
              rating_scale = "1-9",
              grain_yield.t.ha. = Herm_10$`Kg/ha`,
              #AUDPC = apply(Herm_10[,c("P.M.9wap","P.M.11wap","P.M.13wap")]-1,1, FUN = audpc, dates = c(9*7,11*7,13*7)), # -1 to the data because zero disease = 1 on rating scale
              stringsAsFactors = FALSE
              )

Herm_10_dat <- cbind(Herm_10_dat,
                          AUDPC = apply(data.frame(zero = 1,
                                                   Herm_10[,c("P.M.9wap","P.M.11wap","P.M.13wap")]-1),
                                        1, 
                                        FUN = audpc, 
                                        dates = c((Herm_10_dat$first_sign_disease[1]-7)-
                                                     Herm_10_dat$planting_date[1],
                                                  9*7,11*7,13*7)
                                        )
                          )


Herm_10_m <- Herm_10_dat %>%
   group_by(trial_ref, year, location, host_genotype, trial_design, trade_name,fungicide_ai,dose_ai.ha,n_treatment) %>%
   summarise(plot_length.m. = mean(plot_length, na.rm = TRUE),
              plot_width.m. = mean(plot_width, na.rm = TRUE),
              plant_density = unique(plant_density),
              row_spacing = unique(row_spacing),
              replicates = sum(replicate),
              planting_date = unique(planting_date),
              emergence_date = NA,
              flowering_date = NA,
              pod_fill_date = NA,
              mid_late_pod_fill = NA,
              first_sign_disease = unique(first_sign_disease),
              fungicide_application_1 = unique(fungicide_application_1),
              fungicide_application_2 = unique(fungicide_application_2),
              fungicide_application_3 = unique(fungicide_application_3),
              fungicide_application_4 = unique(fungicide_application_4),
              fungicide_application_5 = unique(fungicide_application_5),
             fungicide_application_6 = unique(fungicide_application_6),
             fungicide_application_6 = unique(fungicide_application_7),
              total_fungicide = unique(total_fungicide),
              harvest_date = unique(harvest_date),
              final_assessment = unique(final_assessment),
              PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
              rating_scale = unique(rating_scale),
              disease_error = sd(PM_final_severity, na.rm = TRUE),
              D_error_type = "stdev",
              grain_yield.t.ha. = mean(grain_yield.t.ha., na.rm = TRUE),
              raw_graded = NA,
              yield_error = sd(grain_yield.t.ha., na.rm = TRUE),
              Y_error_type = "stdev",
              AUDPC.m = mean(AUDPC),
             AUDPC.sd = sd(AUDPC),
              meanSq = anova(lm(grain_yield.t.ha. ~ host_genotype + factor(n_treatment), data = Herm_10_dat))[2,3]
   )




Herm_10_m <- fold_data(Herm_10_m, PM_MB_means)



write.csv(
   as.data.frame(Herm_10_m),
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2010/2010 PMmung Herm/2010 PMmung Hermitage means.csv"
)

```

### Hermitage 2011
```{r Herm_2011}

Herm_11 <-
   as.data.frame(read_xls(
      "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2011/2011 PMmung Herm/pmhermratings2011.xls",
      sheet = "Analyses factor"
   ), stringsAsFactors = FALSE)

Herm_11 <- Herm_11 %>%
   mutate(trade_name = 
             case_when(`Treatment!` == "1 spray AMI-X" ~ "Amistar Xtra",
                       `Treatment!` == "3 spray AMI-X" ~ "Amistar Xtra",
                       `Treatment!` == "1 spray SULPHUR" ~ "Kendon",
                       `Treatment!` == "3 spray SULPHUR" ~ "Kendon",
                       `Treatment!` == "1 spray FOLICUR" ~ "Folicur",
                       TRUE ~ "control"))%>%
   mutate(fungicide_ai = 
             case_when(`Treatment!` == "1 spray AMI-X" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       `Treatment!` == "3 spray AMI-X" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       `Treatment!` == "1 spray SULPHUR" ~ "sulphur",
                       `Treatment!` == "3 spray SULPHUR" ~ "sulphur",
                       `Treatment!` == "1 spray FOLICUR" ~ "tebuconazole",
                       TRUE ~ "control"))%>%
   mutate(dose_ai.ha = 
             case_when(`Treatment!` == "1 spray AMI-X" ~ 120,
                       `Treatment!` == "3 spray AMI-X" ~ 120,
                       `Treatment!` == "1 spray SULPHUR" ~ 3000,
                       `Treatment!` == "3 spray SULPHUR" ~ 3000,
                       `Treatment!` == "1 spray FOLICUR" ~ 62.35,
                       TRUE ~ 0))%>%
   mutate(fungicide_application_1 = 
             case_when(`Treatment!` == "1 spray AMI-X" ~ as.Date("2011-03-28", format = "%Y-%m-%d"),
                       `Treatment!` == "3 spray AMI-X" ~ as.Date("2011-02-28", format = "%Y-%m-%d"),
                       `Treatment!` == "1 spray SULPHUR" ~ as.Date("2011-03-28", format = "%Y-%m-%d"),
                       `Treatment!` == "3 spray SULPHUR" ~ as.Date("2011-02-28", format = "%Y-%m-%d"),
                       `Treatment!` == "1 spray FOLICUR" ~ as.Date("2011-03-28", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_2 = 
             case_when(`Treatment!` == "3 spray AMI-X" ~ as.Date("2011-03-14", format = "%Y-%m-%d"),
                       `Treatment!` == "3 spray SULPHUR" ~ as.Date("2011-03-14", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_3 = 
             case_when(`Treatment!` == "3 spray AMI-X" ~ as.Date("2011-03-14", format = "%Y-%m-%d"),
                       `Treatment!` == "3 spray SULPHUR" ~ as.Date("2011-03-14", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(total_fungicide = 
             case_when(`Treatment!` == "1 spray AMI-X" ~ 1,
                       `Treatment!` == "3 spray AMI-X" ~ 3,
                       `Treatment!` == "1 spray SULPHUR" ~ 1,
                       `Treatment!` == "3 spray SULPHUR" ~ 3,
                       `Treatment!` == "1 spray FOLICUR" ~ 1,
                       TRUE ~ 0))



Herm_11_dat <- 
   data.frame(trial_ref = "mung1011/01",
              year = "2011",
              location = "Hermitage",
              host_genotype = Herm_11$`Cultivar!`,
              trial_design = "RCB",
              plot_length = 11,
              plot_width = 4,
              plant_density = NA,
              row_spacing = 0.75,
              replicate = Herm_11$`Rep!`,
              planting_date = as.Date("2011-01-24", format = "%Y-%m-%d"),
              emergence_date = NA,
              flowering_date = as.Date("2011-03-22", format = "%Y-%m-%d"),
              pod_fill_date = NA,
              mid_late_pod_fill = NA,
              first_sign_disease = as.Date("2011-03-28", format = "%Y-%m-%d"),
              trade_name = as.factor(Herm_11$trade_name),
              fungicide_ai = Herm_11$fungicide_ai,
              dose_ai.ha = Herm_11$dose_ai.ha,
              n_treatment = Herm_11$Tr,
              fungicide_application_1 = Herm_11$fungicide_application_1,
              fungicide_application_2 = Herm_11$fungicide_application_2,
              fungicide_application_3 = Herm_11$fungicide_application_3,
              total_fungicide = Herm_11$total_fungicide,
              harvest_date = as.Date("2011-04-25", format = "%Y-%m-%d"),
              final_assessment = as.Date("2011-04-11", format = "%Y-%m-%d"),
              PM_final_severity = Herm_11$`P.M. 11  w.a.p.`,
              AUDPC = apply(data.frame(zero = rep(1,42),
                                       wap11 = Herm_11[,c("P.M. 11  w.a.p.")]-1),1, 
                            FUN = audpc, dates = c((as.Date("2011-03-28", format = "%Y-%m-%d")-7)- # First sign of disease minus planting date. Gives when there is no disease
                                                      as.Date("2011-01-24", format = "%Y-%m-%d"),
                               77)), # -1 to the data because zero disease = 1 on rating scale
              rating_scale = "1-9",
              grain_yield.t.ha. = Herm_11$`Yld Kg/ha`
              )
   

Herm_11_m <- Herm_11_dat %>%
   group_by(trial_ref, year, location, host_genotype, trial_design, trade_name,fungicide_ai,dose_ai.ha,n_treatment) %>%
   summarise(plot_length.m. = mean(plot_length, na.rm = TRUE),
              plot_width.m. = mean(plot_width, na.rm = TRUE),
              plant_density = unique(plant_density),
              row_spacing = unique(row_spacing),
              replicates = sum(replicate),
              planting_date = unique(planting_date),
              emergence_date = NA,
              flowering_date = unique(flowering_date),
              pod_fill_date = NA,
              mid_late_pod_fill = NA,
              first_sign_disease = unique(first_sign_disease),
              fungicide_application_1 = unique(fungicide_application_1),
              fungicide_application_2 = unique(fungicide_application_2),
              fungicide_application_3 = unique(fungicide_application_3),
              total_fungicide = unique(total_fungicide),
              harvest_date = unique(harvest_date),
              final_assessment = unique(final_assessment),
              PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
              rating_scale = unique(rating_scale),
              disease_error = sd(PM_final_severity, na.rm = TRUE),
              D_error_type = "stdev",
              grain_yield.t.ha. = mean(grain_yield.t.ha./1000, na.rm = TRUE),
              raw_graded = NA,
              yield_error = sd(grain_yield.t.ha./1000, na.rm = TRUE),
              Y_error_type = "stdev",
             AUDPC.m = mean(AUDPC),
             AUDPC.sd = sd(AUDPC),
              meanSq = anova(lm(grain_yield.t.ha./1000 ~ factor(n_treatment) + host_genotype, 
                                data = Herm_11_dat[Herm_11_dat$fungicide_ai == "tebuconazole" | 
                                                        Herm_11_dat$fungicide_ai == "control" ,]))[1,3]
   )


Herm_11_m <- fold_data(Herm_11_m, PM_MB_means)

write.csv(
   as.data.frame(Herm_11_m),
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2011/2011 PMmung Herm/2011 PMmung Herm means.csv"
)

```

### Kingaroy 2011
```{r King_11}
King_11 <-
   as.data.frame(read_xls(
      "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2011/2011 PMmung King/pmKing ratings2011.xls",
      sheet = "analyses"
   ), stringsAsFactors = FALSE)

tmp1 <- do.call(rbind.data.frame, strsplit(King_11$`Treatment!`, " "))
colnames(tmp1) <- c("cultivar" , "spray_n", "spray", "fungicide")
King_11 <- cbind(tmp1, King_11)

King_11 <- King_11 %>%
   mutate(trade_name = 
             case_when(fungicide == "AMIS-X" ~ "Amistar Xtra",
                       fungicide == "SULPHUR" ~ "Kendon",
                       fungicide == "FOLICUR" ~ "Folicur",
                       TRUE ~ "control"))%>%
   mutate(fungicide_ai = 
             case_when(fungicide == "AMIS-X" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       fungicide == "SULPHUR" ~ "sulphur",
                       fungicide == "FOLICUR" ~ "tebuconazole",
                       TRUE ~ "control"))%>%
   mutate(dose_ai.ha = 
             case_when(fungicide == "AMIS-X" ~ 120,
                       fungicide == "SULPHUR" ~ 3000,
                       fungicide == "FOLICUR" ~ 62.35,
                       TRUE ~ 0))%>%
   mutate(fungicide_application_1 = 
             case_when(spray_n == 1 ~ as.Date("2011-03-23", format = "%Y-%m-%d"),
                       spray_n == 2 ~ as.Date("2011-03-23", format = "%Y-%m-%d"),
                       spray_n == 3 ~ as.Date("2011-03-09", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   
   mutate(fungicide_application_2 = 
             case_when(spray_n == 2 ~ as.Date("2011-04-13", format = "%Y-%m-%d"),
                       spray_n == 3 ~ as.Date("2011-03-30", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_3 = 
             case_when(spray_n == 3 ~ as.Date("2011-04-12", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))



King_11_dat <- 
   data.frame(trial_ref = "mung1011/02",
              year = "2011",
              location = "Kingaroy",
              host_genotype = King_11$cultivar,
              trial_design = "RCB",
              plot_length = 11,
              plot_width = 4,
              plant_density = NA,
              row_spacing = 0.75,
              replicate = King_11$`rep!`,
              planting_date = as.Date("2011-02-02", format = "%Y-%m-%d"),
              emergence_date = NA,
              flowering_date = NA,
              pod_fill_date = NA,
              mid_late_pod_fill = NA,
              first_sign_disease = as.Date("2011-03-22", format = "%Y-%m-%d"),
              trade_name = as.factor(King_11$trade_name),
              fungicide_ai = King_11$fungicide_ai,
              dose_ai.ha = King_11$dose_ai.ha,
              n_treatment = King_11$`trt!`,
              fungicide_application_1 = King_11$fungicide_application_1,
              fungicide_application_2 = King_11$fungicide_application_2,
              fungicide_application_3 = King_11$fungicide_application_3,
              total_fungicide = King_11$spray_n,
              harvest_date = as.Date(NA),
              final_assessment = as.Date("2011-05-11", format = "%Y-%m-%d"),
              PM_final_severity = King_11$`14 w.a.p.`,
              rating_scale = "1-9",
              grain_yield.t.ha. = as.numeric(King_11$`Yld kg ha`)
              #AUDPC = apply(King_11[,c("9 w.a.p.", "11 w.a.p.", "12 w.a.p.", "14 w.a.p.")]-1,1, FUN = audpc, dates = c(9*7,11*7,12*7, 14*7))# -1 to the data because zero disease = 1 on rating scale
              )

King_11_dat <- cbind(King_11_dat,
                          AUDPC = apply(data.frame(zero = 1,
                                                   King_11[,c("9 w.a.p.", "11 w.a.p.", 
                                                              "12 w.a.p.", "14 w.a.p.")])-1,
                                        1, 
                                        FUN = audpc, 
                                        dates = c((King_11_dat$first_sign_disease[1]-7)-
                                                     King_11_dat$planting_date[1],
                                           9*7,11*7,12*7, 14*7))
                     )


King_11_m <- King_11_dat %>%
   group_by(trial_ref, year, location, host_genotype, trial_design, trade_name,fungicide_ai,dose_ai.ha,n_treatment) %>%
   summarise(plot_length.m. = mean(plot_length, na.rm = TRUE),
              plot_width.m. = mean(plot_width, na.rm = TRUE),
              plant_density = unique(plant_density),
              row_spacing = unique(row_spacing),
              replicates = sum(replicate),
              planting_date = unique(planting_date),
              emergence_date = NA,
              flowering_date = unique(flowering_date),
              pod_fill_date = NA,
              mid_late_pod_fill = NA,
              first_sign_disease = unique(first_sign_disease),
              fungicide_application_1 = unique(fungicide_application_1),
              fungicide_application_2 = unique(fungicide_application_2),
              fungicide_application_3 = unique(fungicide_application_3),
              total_fungicide = unique(total_fungicide),
              harvest_date = unique(harvest_date),
              final_assessment = unique(final_assessment),
              PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
              rating_scale = unique(rating_scale),
              disease_error = sd(PM_final_severity, na.rm = TRUE),
              D_error_type = "stdev",
              grain_yield.t.ha. = mean(grain_yield.t.ha., na.rm = TRUE)/1000,
              raw_graded = NA,
              yield_error = sd(grain_yield.t.ha./1000, na.rm = TRUE),
              Y_error_type = "stdev",
             AUDPC.m = mean(AUDPC),
             AUDPC.sd = sd(AUDPC),
              meanSq = anova(lm(grain_yield.t.ha./1000 ~ factor(n_treatment) + host_genotype, 
                                data = King_11_dat[King_11_dat$fungicide_ai == "tebuconazole" | 
                                                        King_11_dat$fungicide_ai == "control" ,]))[1,3]
   )


King_11_m <- fold_data(King_11_m, PM_MB_means)


write.csv(
   King_11_m,
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2011/2011 PMmung Herm/2011 PMmung Kingaroy means.csv"
)



```

### Goolhi 2013
#### Convert disease scores
```{r Goolhi_2013}

for(D_assessment in c("16 DAT1", "33DAT1")){

# Import final disease survey
Goolhi.13 <-
   as.data.frame(
      read_xlsx(
         path = "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/AM1305 Fungicides for powdery mildew in mungbean - Goolhi.xlsx",
         sheet = D_assessment,
         range = "A15:AG75",
         col_names = TRUE
      )
   )

Goolhi.13 <- Goolhi.13[order(Goolhi.13[,1],Goolhi.13[,2],Goolhi.13[,3],Goolhi.13[,4]),]


# Replace empty cells / NAs with zeros
for (i in 7:33) {
   Goolhi.13[is.na(Goolhi.13[, i]), i] <- 0
}


# Calculate incidence
#     Sites      1     2     3
# low canopy  c(7:9, 16:18, 25:27)
# mid canopy c(10:12, 19:21, 28:30)
# upp canopy c(13:15, 22:24, 31:33)

incidence1 <-
   vector(mode = "numeric", length = length(Goolhi.13[, 1]))

# Convert disease survey data to 1-9 Incidence rating scale
for (i in seq_along(incidence1)) {
   # incidence = 1
   if (all(Goolhi.13[i, 7:33] == 0)) {
      incidence1[i] <- 1
      next()
   }
   
   # incidence = 2
   if (all(Goolhi.13[i, c(10:15, 19:24, 28, 33)] == 0) &&
       (sum(Goolhi.13[i, c(7:9, 16:18, 25:27)] > 0) /
        length(Goolhi.13[i, c(7:9, 16:18, 25:27)])) <= 0.75) {
      incidence1[i] <- 2
      next()
   }
   
   
   # incidence = 3
   if (all(Goolhi.13[i, c(13:15, 22:24, 31:33)] == 0) &&
       sum(Goolhi.13[i, c(10:12, 19:21, 28:30)] != 0) <= 3 &&
       (sum(Goolhi.13[i, c(7:12, 16:21, 25:30)] > 0) /
        length(Goolhi.13[i, c(7:12, 16:21, 25:30)])) > 0.75) {
      incidence1[i] <- 3
   } else{
      # if it is in the lower half of the canopy and in less than 75% of plants then incidence = 2.5
      if (all(Goolhi.13[i, c(13:15, 22:24, 31:33)] == 0) &&
          sum(Goolhi.13[i, c(10:12, 19:21, 28:30)] != 0) <= 3 &&
          (sum(Goolhi.13[i, c(7:12, 16:21, 25:30)] > 0) /
           length(Goolhi.13[i, c(7:12, 16:21, 25:30)])) <= 0.75) {
         incidence1[i] <- 2.5
         next()
      }
   }
   
   
   # incidence = 4
   if (all(Goolhi.13[i, c(13:15, 22:24, 31:33)] == 0) &&
       sum(Goolhi.13[i, c(10:12, 19:21, 28:30)] != 0) > 3 &&
       (sum(Goolhi.13[i, c(7:12, 16:21, 25:30)] > 0) /
        length(Goolhi.13[i, c(7:12, 16:21, 25:30)])) <= 0.75) {
      incidence1[i] <- 4
      next()
   }
   
   
   # incidence = 5
   if (all(Goolhi.13[i, c(13:15, 22:24, 31:33)] == 0) &&
       sum(Goolhi.13[i, c(10:12, 19:21, 28:30)] != 0) > 3 &&
       (sum(Goolhi.13[i, c(7:12, 16:21, 25:30)] > 0) /
        length(Goolhi.13[i, c(7:12, 16:21, 25:30)])) > 0.75 &&
       any(Goolhi.13[i, c(7:12, 16:21, 25:30)] == 0)) {
      incidence1[i] <- 5
      next()
   }
   
   
   # incidence = 6
   if (all(Goolhi.13[i, c(13:15, 22:24, 31:33)] == 0) &&
       all(Goolhi.13[i, c(7:12, 16:21, 25:30)] != 0)) {
      incidence1[i] <- 6
      next()
   }
   
   
   # incidence = 7
   if (sum(Goolhi.13[i, c(13:15, 22:24, 31:33)] != 0) <= 3 &&
       all(Goolhi.13[i, c(7:12, 16:21, 25:30)] != 0)) {
      incidence1[i] <- 7
      next()
   }
   
   
   # incidence = 8
   if ((sum(Goolhi.13[i, c(13:15, 22:24, 31:33)] != 0) > 3 |
        sum(Goolhi.13[i, c(13:15, 22:24, 31:33)]) <= 200) &&
       all(Goolhi.13[i, c(7:12, 16:21, 25:30)] != 0) &&
       (sum(Goolhi.13[i, 7:33] > 0) /
        length(Goolhi.13[i, 7:33]) > 0.75) &&
       sum(Goolhi.13[i, 7:33]) <= 2000) {
      incidence1[i] <- 8
      next()
   }
   
   
   # incidence = 9
   if (sum(Goolhi.13[i, c(13:15, 22:24, 31:33)] != 0) > 3 &&
       all(Goolhi.13[i, c(7:12, 16:21, 25:30)] != 0) &&
       (sum(Goolhi.13[i, 7:33] > 0) /
        length(Goolhi.13[i, 7:33]) > 0.75) &&
       sum(Goolhi.13[i, 7:33]) > 2000) {
      incidence1[i] <- 9
      next()
   }
   
   # if not in the lower canopy but small colonies in mid and upper canopy
   if (all(Goolhi.13[i, c(7:9, 16:18, 25:27)] == 0) &&
       (sum(Goolhi.13[i, c(10:15, 19:24, 28, 33)] > 0) /
        length(Goolhi.13[i, 7:33]) <= 0.5)) {
      incidence1[i] <- 2.5
      next()
   }
   
   
   # incidence = 7.5
   if (sum(Goolhi.13[i, c(13:15, 22:24, 31:33)] != 0) > 3 &&
       sum(Goolhi.13[i, c(7:12, 16:21, 25:30)] != 0) > 10 &&
       any(Goolhi.13[i, c(7:12, 16:21, 25:30)] == 0) &&
       (sum(Goolhi.13[i, 7:33] > 0) /
        length(Goolhi.13[i, 7:33]) > 0.7) &&
       sum(Goolhi.13[i, 7:33]) <= 2000) {
      incidence1[i] <- 7.5
      next()
   }
   
   # incidence = 6.5
   if (sum(Goolhi.13[i, c(13:15, 22:24, 31:33)] != 0) > 3 &&
       sum(Goolhi.13[i, c(7:12, 16:21, 25:30)] != 0) <= 12 &&
       sum(Goolhi.13[i, c(7:12, 16:21, 25:30)] != 0) >= 10 &&
       (sum(Goolhi.13[i, 7:33] > 0) /
        length(Goolhi.13[i, 7:33]) <= 0.75) &&
       sum(Goolhi.13[i, 7:33]) <= 2000) {
      incidence1[i] <- 6.5
      next()
   }
   
   
   # incidence = 4.5
   if (sum(Goolhi.13[i, c(13:15, 22:24, 31:33)] != 0) > 3 &&
       sum(Goolhi.13[i, c(7:12, 16:21, 25:30)] != 0) < 10 &&
       sum(Goolhi.13[i, c(7:12, 16:21, 25:30)] != 0) > 5 &&
       (sum(Goolhi.13[i, 7:33] > 0) /
        length(Goolhi.13[i, 7:33]) <= 0.75) &&
       sum(Goolhi.13[i, 7:33]) <= 2000) {
      incidence1[i] <- 4.5
      next()
   } else{
      # If none of the conditions are met give the incidence zero
      incidence1[i] <- 0
   }
   
}

# check data to make sure there are no zeros
incidence1
length(Goolhi.13[incidence1 == 0, 1])
Goolhi.13[incidence1 == 0, ]
hist(incidence1)

# Re-format data-frame
if(D_assessment == "16 DAT1"){
Goolhi.13D <- Goolhi.13[,c("Treat", "Rep", "Run", "Plot")]
Goolhi.13D$Inc_16D <-  incidence1

} 

if(D_assessment == "33DAT1"){
Goolhi.13D$Inc_33D <-  incidence1
}
}


# head(Goolhi.13D)
# Goolhi.13D <- Goolhi.13D %>%
#    group_by(Treat) %>%
#    summarise(M.inc = mean(Incidence, na.rm = TRUE),
#              sd.inc = sd(Incidence, na.rm = TRUE))


# write.csv(
#    Goolhi.13D,
#    "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/Mungbean/Past trials/2013/AM1305-Goolhi-Disease_means.csv"
# )

#_____________________
# Read in Harvest data
Goolhi.13Y <-
   as.data.frame(
      read_xlsx(
         path = "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/AM1305 Fungicides for powdery mildew in mungbean - Goolhi.xlsx",
         sheet = "Yield",
         range = "A15:F75",
         col_names = TRUE
      )
   )
Goolhi.13Y <- Goolhi.13Y[order(Goolhi.13Y[,1],Goolhi.13Y[,2],Goolhi.13Y[,3],Goolhi.13Y[,4]),]


# Join disease and Yield data
Goolhi_13 <- left_join(Goolhi.13D, Goolhi.13Y)

```


#### Define treatment data
```{r GoolhiDefine}

Goolhi_13 <- Goolhi_13 %>%
   mutate(trade_name = 
             case_when(Treat == "1" ~ "control",
                       Treat == "2" ~ "Spin-flo",
                       Treat == "3" ~ "Tilt",
                       Treat == "4" ~ "Amistar Xtra",
                       Treat == "5" ~ "Amistar Xtra + adj",
                       Treat == "6" ~ "Cabrio",
                       Treat == "7" ~ "Spin-flo",
                       Treat == "8" ~ "Tilt",
                       Treat == "9" ~ "Amistar Xtra + adj",
                       Treat == "10" ~ "Cabrio",
                       Treat == "11" ~ "Tilt",
                       TRUE ~ "other"))%>%
   mutate(fungicide_ai = 
             case_when(Treat == "1" ~ "control",
                       Treat == "2" ~ "carbendazim",
                       Treat == "3" ~ "propiconazole",
                       Treat == "4" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       Treat == "5" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       Treat == "6" ~ "pyraclostrobin",
                       Treat == "7" ~ "carbendazim",
                       Treat == "8" ~ "propiconazole",
                       Treat == "9" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       Treat == "10" ~ "pyraclostrobin",
                       Treat == "11" ~ "propiconazole",
                       TRUE ~ "other"))%>%
   mutate(dose_ai.ha = 
             case_when(Treat == "1" ~ 0,
                       Treat == "2" ~ 250,
                       Treat == "3" ~ 62.5,
                       Treat == "4" ~ 40,
                       Treat == "5" ~ 40,
                       Treat == "6" ~ 125,
                       Treat == "7" ~ 250,
                       Treat == "8" ~ 62.5,
                       Treat == "9" ~ 40,
                       Treat == "10" ~ 125,
                       Treat == "11" ~ 62.5,
                       TRUE ~ 0))%>%
   mutate(fungicide_application_1 = 
             case_when(Treat == "1" ~ as.Date(NA),
                       Treat == "2" ~ as.Date("2013-03-28", format = "%Y-%m-%d"),
                       Treat == "3" ~ as.Date("2013-03-28", format = "%Y-%m-%d"),
                       Treat == "4" ~ as.Date("2013-03-28", format = "%Y-%m-%d"),
                       Treat == "5" ~ as.Date("2013-03-28", format = "%Y-%m-%d"),
                       Treat == "6" ~ as.Date("2013-03-28", format = "%Y-%m-%d"),
                       Treat == "7" ~ as.Date("2013-03-28", format = "%Y-%m-%d"),
                       Treat == "8" ~ as.Date("2013-03-28", format = "%Y-%m-%d"),
                       Treat == "9" ~ as.Date("2013-03-28", format = "%Y-%m-%d"),
                       Treat == "10" ~ as.Date("2013-03-28", format = "%Y-%m-%d"),
                       Treat == "11" ~ as.Date("2013-03-28", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_2 = 
             case_when(Treat == "7" ~ as.Date("2013-04-13", format = "%Y-%m-%d"),
                       Treat == "8" ~ as.Date("2013-04-13", format = "%Y-%m-%d"),
                       Treat == "9" ~ as.Date("2013-04-13", format = "%Y-%m-%d"),
                       Treat == "10" ~ as.Date("2013-04-13", format = "%Y-%m-%d"),
                       Treat == "11" ~ as.Date("2013-04-13", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_3 = 
             case_when(Treat == "11" ~ as.Date("2013-04-27", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(spray_n = 
             case_when(Treat == "1" ~ 0,
                       Treat == "7" ~ 2,
                       Treat == "8" ~ 2,
                       Treat == "9" ~ 2,
                       Treat == "10" ~ 2,
                       Treat == "11" ~ 3,
                       TRUE ~ 1))

```

#### Input trial data
```{r Goolhis_TrialData}

Goolhi_13_dat <- 
   data.frame(trial_ref = "AM1305",
              year = "2013",
              location = "Goolhi",
              host_genotype = "Crystal",
              trial_design = "RB",
              plot_length = 12,
              plot_width = 4,
              plant_density = NA,
              row_spacing = 0.33,
              replicate = Goolhi_13$Rep,
              planting_date = NA,
              emergence_date = NA,
              flowering_date = as.Date("2013-04-04", format = "%Y-%m-%d"),
              pod_fill_date = as.Date("2013-04-18", format = "%Y-%m-%d"),
              mid_late_pod_fill = NA,
              first_sign_disease = as.Date("2013-03-25", format = "%Y-%m-%d"),
              trade_name = as.factor(Goolhi_13$trade_name),
              fungicide_ai = Goolhi_13$fungicide_ai,
              dose_ai.ha = Goolhi_13$dose_ai.ha,
              n_treatment = Goolhi_13$Treat,
              fungicide_application_1 = Goolhi_13$fungicide_application_1,
              fungicide_application_2 = Goolhi_13$fungicide_application_2,
              fungicide_application_3 = Goolhi_13$fungicide_application_3,
              total_fungicide = Goolhi_13$spray_n,
              harvest_date = as.Date("2013-06-20", format = "%Y-%m-%d"),
              final_assessment = as.Date("2013-04-30", format = "%Y-%m-%d"),
              PM_final_severity = Goolhi_13$Inc_33D,
              rating_scale = "1-9",
              grain_yield.t.ha. = as.numeric(Goolhi_13$`Yield Kg/ha`)/1000
              #AUDPC = apply(Goolhi_13[,c("Inc_16D","Inc_33D")]-1,1, FUN = audpc, dates = c(16,33))# -1 to the data because zero disease = 1 on rating scale
              )

Goolhi_13_dat <- cbind(Goolhi_13_dat,
                          AUDPC = apply(data.frame(zero = 1,
                                                   Goolhi_13[,c("Inc_16D","Inc_33D")]-1),
                                        1, 
                                        FUN = audpc, 
                                        dates = c((Goolhi_13_dat$first_sign_disease[1]-7)-
                                                     Goolhi_13_dat$planting_date[1],
                                                  16,33)
                                        )
                          )
   
```   

#### Calculating the treatment means
```{r Goolhis_means}

Goolhi_13_m <- Goolhi_13_dat %>%
   group_by(trial_ref, year, location, host_genotype, trial_design, 
            trade_name,fungicide_ai,dose_ai.ha,n_treatment) %>%
   summarise(plot_length.m. = mean(plot_length, na.rm = TRUE),
              plot_width.m. = mean(plot_width, na.rm = TRUE),
              plant_density = unique(plant_density),
              row_spacing = unique(row_spacing),
              replicates = sum(replicate),
              planting_date = unique(planting_date),
              emergence_date = NA,
              flowering_date = unique(flowering_date),
              pod_fill_date = unique(pod_fill_date),
              mid_late_pod_fill = unique(mid_late_pod_fill),
              first_sign_disease = unique(first_sign_disease),
              fungicide_application_1 = unique(fungicide_application_1),
              fungicide_application_2 = unique(fungicide_application_2),
              fungicide_application_3 = unique(fungicide_application_3),
              total_fungicide = unique(total_fungicide),
              harvest_date = unique(harvest_date),
              final_assessment = unique(final_assessment),
              PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
              rating_scale = unique(rating_scale),
              disease_error = sd(PM_final_severity, na.rm = TRUE),
              D_error_type = "stdev",
              grain_yield.t.ha. = mean(grain_yield.t.ha., na.rm = TRUE),
              raw_graded = NA,
              yield_error = sd(grain_yield.t.ha., na.rm = TRUE),
              Y_error_type = "stdev",
             AUDPC.m = mean(AUDPC),
             AUDPC.sd = sd(AUDPC),
              meanSq = anova(lm(grain_yield.t.ha. ~ factor(total_fungicide), 
                                data = Goolhi_13_dat[Goolhi_13_dat$fungicide_ai == "propiconazole" | 
                                                        Goolhi_13_dat$fungicide_ai == "control" ,]))[1,3]
   )

#!!!!!!!!!!!!!!!!!! Check to see if errors are calculated
Goolhi_13_m <- fold_data(Goolhi_13_m, PM_MB_means)

Goolhi_13_m <- Goolhi_13_m[Goolhi_13_m$trade_name != "other",]


write.csv(
   Goolhi_13_m,
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/AM1305_Goolhi_means.csv"
)

```

### Mary's Mount 2013
#### Convert disease scores
```{r MarysM_13_Convertdisease}

for(D_assess in c("18 DAT1 18-3-2013","19 DAT1 19-3-2013")){

# Import  disease survey
MarysM.13D <-
   as.data.frame(
      read_xlsx(
         path = "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/AM1304 Fungicides for powdery mildew in mungbean - Marys Mount.xlsx",
         sheet = D_assess,
         range = "A14:DC72",
         col_names = TRUE
      )
   )

colnames(MarysM.13D)[1:4] <- c("Treat", "Rep", "Run", "Plot")
MarysM.13D <- MarysM.13D[order(MarysM.13D[,1],MarysM.13D[,2],MarysM.13D[,3],MarysM.13D[,4]),]

if(D_assess == "18 DAT1 18-3-2013"){
   col_ref <- 33:57
   col_ref2 <- 7:31
}
if(D_assess == "19 DAT1 19-3-2013"){
   col_ref <- 58:107
   col_ref2 <- 7:56
}

# Replace empty cells / NAs with zeros
for (i in c(col_ref2,col_ref)) {
   MarysM.13D[is.na(MarysM.13D[, i]), i] <- 0
}


incidence2 <-
   vector(mode = "numeric", length = length(MarysM.13D[, 1]))


# Convert disease survey data to 1-9 Incidence rating scale
for (i in seq_along(incidence2)) {
   # incidence = 1
   if (all(MarysM.13D[i, col_ref] == 0)) {
      incidence2[i] <- 1
      next()
   }
   
   # incidence = 2
   if (sum(MarysM.13D[i, col_ref] == 2) == 0 &&
       sum(MarysM.13D[i, col_ref] == 1) == 0 &&
       (sum(MarysM.13D[i, col_ref] == 3) /
        length(MarysM.13D[i, col_ref])) <= 0.75) {
      incidence2[i] <- 2
      next()
   }
   
   
   # incidence = 3
   if (sum(MarysM.13D[i, col_ref] == 1) == 0 &&
       sum(MarysM.13D[i, col_ref] == 2) <= 8 &&
       (sum(MarysM.13D[i, col_ref] > 0) /
        length(MarysM.13D[i, col_ref])) > 0.75) {
      incidence2[i] <- 3
   } else{
      # if it is in the lower half of the canopy and in less than 75% of plants then incidence = 2.5
      if (sum(MarysM.13D[i, col_ref] == 1) == 0 &&
          sum(MarysM.13D[i, col_ref] == 2) <= 8 &&
          sum(MarysM.13D[i, col_ref] == 3) > 0 &&
          (sum(MarysM.13D[i, col_ref] > 0) /
           length(MarysM.13D[i, col_ref])) <= 0.75) {
         incidence2[i] <- 2.5
         next()
      }
   }
   
   
   # incidence = 4
   if (sum(MarysM.13D[i, col_ref] == 1) == 0 &&
       sum(MarysM.13D[i, col_ref] == 2) > 0 &&
       (sum(MarysM.13D[i, col_ref] > 0) /
        length(MarysM.13D[i, col_ref])) <= 0.75) {
      incidence2[i] <- 4
      next()
   }
   
   
   # incidence = 5
   if (sum(MarysM.13D[i, col_ref] == 1) == 0 &&
       sum(MarysM.13D[i, col_ref] == 2) > 0 &&
       (sum(MarysM.13D[i, col_ref] > 0) /
        length(MarysM.13D[i, col_ref])) > 0.75) {
      incidence2[i] <- 5
      next()
   }
   
   
   # incidence = 6
   if (sum(MarysM.13D[i, col_ref] == 1) == 0 &&
       sum(MarysM.13D[i, col_ref] >= 2) > 0 &&
       (sum(MarysM.13D[i, col_ref] > 0) /
        length(MarysM.13D[i, col_ref])) > 0.95) {
      incidence2[i] <- 6
      next()
   }
   
   
   # incidence = 7
   if (sum(MarysM.13D[i, col_ref] == 1) <= 8 &&
       sum(MarysM.13D[i, col_ref] >= 2) > 0 &&
       (sum(MarysM.13D[i, col_ref] > 0) /
        length(MarysM.13D[i, col_ref])) > 0.95) {
      incidence2[i] <- 7
      next()
   }
   
   
   # incidence = 8
   if (sum(MarysM.13D[i, col_ref] >= 1) > 0 &&
       (sum(MarysM.13D[i, col_ref] > 0) /
        length(MarysM.13D[i, col_ref])) > 0.75) {
      incidence2[i] <- 8
      next()
   }
   
   
   # incidence = 9
   if (sum(MarysM.13D[i, col_ref] >= 1) > 0 &&
       sum(MarysM.13D[i, col_ref2] >= (10 * 5 * 100 * 0.75)) &&
       # ten leaves from 5 sample sites with a maximum % leaf area infected with PM of 100% * 0.75 as a threshold for leaf drop
       (sum(MarysM.13D[i, col_ref] > 0) /
        length(MarysM.13D[i, col_ref])) > 0.75) {
      incidence2[i] <- 9
      next()
   }
   
   # if there are few (< 10%) leaves with very small infections in all parts of the canopy OR
   # if there is a stray colony on a upper leaf in addition to all lower
   if (sum(MarysM.13D[i, col_ref] == 3) >= 1 &&
       sum(MarysM.13D[i, col_ref] == 1) <= 2 &&
       sum(MarysM.13D[i, col_ref] == 2) <= 2 &&
       sum(MarysM.13D[i, col_ref2]) <= 150) {
      incidence2[i] <- 2.5
      next()
   }
   
   # incidence = 7.5  In the upper canopy with less than 75% plants infected
   if (sum(MarysM.13D[i, col_ref] == 3) > 0 &&
       sum(MarysM.13D[i, col_ref] == 2) > 0 &&
       sum(MarysM.13D[i, col_ref] == 1) > 0 &&
       (sum(MarysM.13D[i, col_ref] > 0) /
        length(MarysM.13D[i, col_ref]) <= 0.75) &&
       sum(MarysM.13D[i, col_ref2]) >= 2000) {
      incidence2[i] <- 7.5
      next()
   }
   #
   # incidence = 6.5
   if (sum(MarysM.13D[i, col_ref] == 1) > 3 &&
       sum(MarysM.13D[i, col_ref] >= 2) > 0 &&
       sum(MarysM.13D[i, col_ref2] <= 500)  &&
       (sum(MarysM.13D[i, col_ref] > 0) /
        length(MarysM.13D[i, col_ref]) >= 0.65)) {
      incidence2[i] <- 6.5
      next()
   }
   #
   #
   # incidence = 4.5 If PM is in the the lower and mid-canopy in less than 75% of plants and one or two in the upper canopy
   if (sum(MarysM.13D[i, col_ref] == 1) <= 3 &&
       sum(MarysM.13D[i, col_ref] >= 2) > 0 &&
       (sum(MarysM.13D[i, col_ref] > 0) /
        length(MarysM.13D[i, col_ref])) <= 0.75) {
      incidence2[i] <- 4.5
      next()
   } else{
      # If none of the conditions are met give the incidence zero
      incidence2[i] <- 0
   }
   
}# End of incidence2 loop

if(any(incidence2 == 0)){
   warning("Code caluculated incidence on '0' which is off the incidence scale")
} 

# Re-format data-frame
if(D_assess == "18 DAT1 18-3-2013"){
MarysM.13D.1 <- MarysM.13D[,c("Treat", "Rep", "Run", "Plot")]
MarysM.13D.1$Inc_18D <-  incidence2
#cat(incidence2,"\n",length(incidence2), sep = ", ")
}
   
if(D_assess == "19 DAT1 19-3-2013"){
   MarysM.13D.1$Inc_19D <-  incidence2
   #cat(incidence2,"\n",length(incidence2), sep = ", ")
}
   
} #end of loop on disease observations



write.csv(
   MarysM.13D.1,
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/AM1304-MaryMount-Disease_means.csv"
)



# read in yield and format
MarysM.13Y <-
   as.data.frame(
      read_xlsx(
         path = "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/AM1304 Fungicides for powdery mildew in mungbean - Marys Mount.xlsx",
         sheet = "42 DAT1 Yield",
         range = "A14:F58",
         col_names = TRUE
      )
   )
dim(MarysM.13Y)
dim(MarysM.13D.1)

MarysM.13Y$Treat <- as.character(MarysM.13Y$Treat)
MarysM.13Y$Rep <- as.character(MarysM.13Y$Rep)


MarysM.13Y <- MarysM.13Y[order(MarysM.13Y[,1],MarysM.13Y[,2],MarysM.13Y[,3],MarysM.13Y[,4]),]

MarysM_13 <- left_join(MarysM.13D.1,MarysM.13Y)
```


#### Define treatment data
```{r MarysDefine}
MarysM_13 <- MarysM_13 %>%
   mutate(trade_name = 
             case_when(Treat == "1" ~ "control",
                       Treat == "2" ~ "Spin-flo",
                       Treat == "3" ~ "Tilt",
                       Treat == "4" ~ "Amistar Xtra",
                       Treat == "5" ~ "Amistar Xtra + adj",
                       Treat == "6" ~ "Cabrio",
                       Treat == "7" ~ "Spin-flo",
                       Treat == "8" ~ "Tilt",
                       Treat == "9" ~ "Amistar Xtra + adj",
                       Treat == "10" ~ "Cabrio",
                       Treat == "11" ~ "Tilt",
                       TRUE ~ "other"))%>%
   mutate(fungicide_ai = 
             case_when(Treat == "1" ~ "control",
                       Treat == "2" ~ "carbendazim",
                       Treat == "3" ~ "propiconazole",
                       Treat == "4" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       Treat == "5" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       Treat == "6" ~ "pyraclostrobin",
                       Treat == "7" ~ "carbendazim",
                       Treat == "8" ~ "propiconazole",
                       Treat == "9" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       Treat == "10" ~ "pyraclostrobin",
                       Treat == "11" ~ "propiconazole",
                       TRUE ~ "other"))%>%
   mutate(dose_ai.ha = 
             case_when(Treat == "1" ~ 0,
                       Treat == "2" ~ 250,
                       Treat == "3" ~ 62.5,
                       Treat == "4" ~ 40,
                       Treat == "5" ~ 40,
                       Treat == "6" ~ 125,
                       Treat == "7" ~ 250,
                       Treat == "8" ~ 62.5,
                       Treat == "9" ~ 40,
                       Treat == "10" ~ 125,
                       Treat == "11" ~ 62.5,
                       TRUE ~ 0))%>%
   mutate(fungicide_application_1 = 
             case_when(Treat == "1" ~ as.Date(NA),
                       Treat == "2" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "3" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "4" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "5" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "6" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "7" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "8" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "9" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "10" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "11" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_2 = 
             case_when(Treat == "7" ~ as.Date("2013-03-18", format = "%Y-%m-%d"),
                       Treat == "8" ~ as.Date("2013-03-18", format = "%Y-%m-%d"),
                       Treat == "9" ~ as.Date("2013-03-18", format = "%Y-%m-%d"),
                       Treat == "10" ~ as.Date("2013-03-18", format = "%Y-%m-%d"),
                       Treat == "11" ~ as.Date("2013-03-18", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_3 = 
             case_when(Treat == "11" ~ as.Date("2013-04-02", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(spray_n = 
             case_when(Treat == "1" ~ 0,
                       Treat == "2" ~ 1,
                       Treat == "3" ~ 1,
                       Treat == "4" ~ 1,
                       Treat == "5" ~ 1,
                       Treat == "6" ~ 1,
                       Treat == "7" ~ 2,
                       Treat == "8" ~ 2,
                       Treat == "9" ~ 2,
                       Treat == "10" ~ 2,
                       Treat == "11" ~ 2, # third spray not applied ?
                       TRUE ~ 0))
```

#### Input trial data
```{r Marys_TrialData}
MarysM_13_dat <- 
   data.frame(trial_ref = "AM1304",
              year = "2013",
              location = "Mary's mount",
              host_genotype = "Crystal",
              trial_design = "RCB",
              plot_length = 12,
              plot_width = 4,
              plant_density = NA,
              row_spacing = 1,
              replicate = MarysM_13$Rep,
              planting_date = NA,
              emergence_date = NA,
              flowering_date = NA,
              pod_fill_date = as.Date("2013-02-28", format = "%Y-%m-%d"),
              mid_late_pod_fill = NA,
              first_sign_disease = as.Date("2013-03-16", format = "%Y-%m-%d"),
              trade_name = as.factor(MarysM_13$trade_name),
              fungicide_ai = MarysM_13$fungicide_ai,
              dose_ai.ha = MarysM_13$dose_ai.ha,
              n_treatment = MarysM_13$Treat,
              fungicide_application_1 = MarysM_13$fungicide_application_1,
              fungicide_application_2 = MarysM_13$fungicide_application_2,
              fungicide_application_3 = MarysM_13$fungicide_application_3,
              total_fungicide = MarysM_13$spray_n,
              harvest_date = as.Date("2013-04-11", format = "%Y-%m-%d"),
              final_assessment = as.Date("2013-03-26", format = "%Y-%m-%d"),
              PM_final_severity = MarysM_13$Inc_19D,
              rating_scale = "1-9",
              grain_yield.t.ha. = as.numeric(MarysM_13$`Yield Kg/ha`)/1000
              #AUDPC = apply(MarysM_13[,c("Inc_18D","Inc_19D")]-1,1, FUN = audpc, dates = c(12,12+19)) # -1 to the data because zero disease = 1 on rating scale
              )

MarysM_13_dat <- cbind(MarysM_13_dat,
                          AUDPC = apply(data.frame(zero = 1,
                                                   MarysM_13[,c("Inc_18D","Inc_19D")]-1),
                                        1, 
                                        FUN = audpc, 
                                        dates = c((MarysM_13_dat$first_sign_disease[1]-7)-
                                                     MarysM_13_dat$planting_date[1],
                                                  12,12+19)
                                        )
                          )
```   

#### Calculating the treatment means
```{r Marys_means}
MarysM_13_m <- MarysM_13_dat %>%
   group_by(trial_ref, year, location, host_genotype, trial_design, 
            trade_name,fungicide_ai,dose_ai.ha,n_treatment) %>%
   summarise(plot_length.m. = mean(plot_length, na.rm = TRUE),
              plot_width.m. = mean(plot_width, na.rm = TRUE),
              plant_density = unique(plant_density),
              row_spacing = unique(row_spacing),
              replicates = length(as.numeric(replicate)),
              planting_date = unique(planting_date),
              emergence_date = NA,
              flowering_date = unique(flowering_date),
              pod_fill_date = unique(pod_fill_date),
              mid_late_pod_fill = unique(mid_late_pod_fill),
              first_sign_disease = unique(first_sign_disease),
              fungicide_application_1 = unique(fungicide_application_1),
              fungicide_application_2 = unique(fungicide_application_2),
              fungicide_application_3 = unique(fungicide_application_3),
              total_fungicide = unique(total_fungicide),
              harvest_date = unique(harvest_date),
              final_assessment = unique(final_assessment),
              PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
              rating_scale = unique(rating_scale),
              disease_error = sd(PM_final_severity, na.rm = TRUE), # why is this not working
              D_error_type = "stdev",
              grain_yield.t.ha. = mean(grain_yield.t.ha., na.rm = TRUE),
              raw_graded = NA,
              yield_error = sd(grain_yield.t.ha., na.rm = TRUE),
              Y_error_type = "stdev",
             AUDPC.m = mean(AUDPC),
             AUDPC.sd = sd(AUDPC),
              meanSq = anova(lm(grain_yield.t.ha. ~ factor(total_fungicide), 
                                data = MarysM_13_dat[MarysM_13_dat$fungicide_ai == "propiconazole" | 
                                                        MarysM_13_dat$fungicide_ai == "control" ,]))[1,3]
             
   )



# For some wierd reason standard deviations are comming back NA in the code above
# Because of n_treatment being converted to a factor I need to wrangle carefully here
Mary_tmp <- MarysM_13_dat %>%
   group_by(n_treatment) %>%
   summarise(disease_error = sd(PM_final_severity, na.rm = TRUE),
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE))

# Remive the existing yield_error columns and replace with new ones
MarysM_13_m <- left_join(MarysM_13_m[,colnames(MarysM_13_m)[c(-29,-33)]], Mary_tmp)

# Remove other plots not in experiment
MarysM_13_m <- MarysM_13_m[MarysM_13_m$trade_name != "other",]


MarysM_13_m$n_treatment <- as.numeric(as.character(MarysM_13_m$n_treatment))
MarysM_13_m <- fold_data(MarysM_13_m, PM_MB_means)



write.csv(
   MarysM_13_m[order(as.numeric(MarysM_13_m$n_treatment)),],
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/AM1304-MarysMount_means.csv",
   row.names = FALSE
)

sd(MarysM_13_dat[MarysM_13_dat$n_treatment == 9,"grain_yield.t.ha."])

```


### Premer 2013
#### Convert disease scores
```{r Premer_13_convert_scores}

for(D_assess in c("19 DAT1 19-3-2013","31 DAT1 31-3-2013")){

# Import final disease survey
Premer.13D <-
   as.data.frame(
      read_xlsx(
         path = "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/AM1303 Fungicides for powdery mildew in mungbean - Premer.xlsx",
         sheet = D_assess,
         range = "A14:DC64",
         col_names = TRUE
      )
   )


colnames(Premer.13D)[1:4] <- c("Treat", "Rep", "Run", "Plot")
Premer.13D <- Premer.13D[order(Premer.13D[,1],Premer.13D[,2],Premer.13D[,3],Premer.13D[,4]),]


# remove Plots not surveyed
for (i in seq_along(Premer.13D[, 1])) {
   if (i == 1) {
      plotsRecorded <- vector(length = length(Premer.13D[, 1]))
   }
   
   plotsRecorded[i] <- all(is.na(Premer.13D[i, 7:56]))
   
   if (i == length(Premer.13D[, 1])) {
      print(!plotsRecorded)
   }
}
# remove Plots not surveyed
Premer.13D <- Premer.13D[!plotsRecorded, ]

incidence3 <-
   vector(mode = "numeric", length = length(Premer.13D[, 1]))


# Convert disease survey data to 1-9 Incidence rating scale
for (i in seq_along(incidence3)) {
   # # NAs
   # if (all(is.na(Premer.13D[i, 58:107]))) {
   #    incidence3[i] <- NA
   #    next()
   # }
   
   # incidence = 1
   if (all(Premer.13D[i, 58:107] == 0)) {
      incidence3[i] <- 1
      next()
   }
   
   # incidence = 2
   if (sum(Premer.13D[i, 58:107] == 2, na.rm = TRUE) == 0 &&
       sum(Premer.13D[i, 58:107] == 1, na.rm = TRUE) == 0 &&
       (sum(Premer.13D[i, 58:107] == 3, na.rm = TRUE) /
        length(Premer.13D[i, 58:107])) <= 0.75) {
      incidence3[i] <- 2
      next()
   }
   
   
   # incidence = 3
   if (sum(Premer.13D[i, 58:107] == 1, na.rm = TRUE) == 0 &&
       sum(Premer.13D[i, 58:107] == 2, na.rm = TRUE) <= 8 &&
       (sum(Premer.13D[i, 58:107] > 0, na.rm = TRUE) /
        length(Premer.13D[i, 58:107])) > 0.75) {
      incidence3[i] <- 3
   } else{
      # if it is in the lower half of the canopy and in less than 75% of plants then incidence = 2.5
      if (sum(Premer.13D[i, 58:107] == 1, na.rm = TRUE) == 0 &&
          sum(Premer.13D[i, 58:107] == 2, na.rm = TRUE) <= 8 &&
          sum(Premer.13D[i, 58:107] == 3, na.rm = TRUE) > 0 &&
          (sum(Premer.13D[i, 58:107] > 0, na.rm = TRUE) /
           length(Premer.13D[i, 58:107])) <= 0.75) {
         incidence3[i] <- 2.5
         next()
      }
   }
   
   
   # incidence = 4
   if (sum(Premer.13D[i, 58:107] == 1, na.rm = TRUE) == 0 &&
       sum(Premer.13D[i, 58:107] == 2, na.rm = TRUE) > 0 &&
       (sum(Premer.13D[i, 58:107] > 0, na.rm = TRUE) /
        length(Premer.13D[i, 58:107])) <= 0.75) {
      incidence3[i] <- 4
      next()
   }
   
   
   # incidence = 5
   if (sum(Premer.13D[i, 58:107] == 1, na.rm = TRUE) == 0 &&
       sum(Premer.13D[i, 58:107] == 2, na.rm = TRUE) > 0 &&
       (sum(Premer.13D[i, 58:107] > 0, na.rm = TRUE) /
        length(Premer.13D[i, 58:107])) > 0.75) {
      incidence3[i] <- 5
      next()
   }
   
   
   # incidence = 6
   if (sum(Premer.13D[i, 58:107] == 1, na.rm = TRUE) == 0 &&
       sum(Premer.13D[i, 58:107] >= 2, na.rm = TRUE) > 0 &&
       (sum(Premer.13D[i, 58:107] > 0, na.rm = TRUE) /
        length(Premer.13D[i, 58:107])) > 0.95) {
      incidence3[i] <- 6
      next()
   }
   
   
   # incidence = 7
   if (sum(Premer.13D[i, 58:107] == 1, na.rm = TRUE) <= 8 &&
       sum(Premer.13D[i, 58:107] >= 2, na.rm = TRUE) > 0 &&
       (sum(Premer.13D[i, 58:107] > 0, na.rm = TRUE) /
        length(Premer.13D[i, 58:107])) > 0.95) {
      incidence3[i] <- 7
      next()
   }
   
   
   # incidence = 8
   if (sum(Premer.13D[i, 58:107] >= 1, na.rm = TRUE) > 0 &&
       (sum(Premer.13D[i, 58:107] > 0, na.rm = TRUE) /
        length(Premer.13D[i, 58:107])) > 0.75) {
      incidence3[i] <- 8
      next()
   }
   
   
   # incidence = 9
   if (sum(Premer.13D[i, 58:107] >= 1) > 0 &&
       sum(Premer.13D[i, 7:56] >= (10 * 5 * 100 * 0.75)) &&
       # ten leaves from 5 sample sites with a maximum % leaf area infected with PM of 100% * 0.75 as a threshold for leaf drop
       (sum(Premer.13D[i, 58:107] > 0) /
        length(Premer.13D[i, 58:107])) > 0.75) {
      incidence3[i] <- 9
      next()
   }
   
   # if there are few (< 10%) leaves with very small infections in all parts of the canopy OR
   # if there is a stray colony on a upper leaf in addition to all lower
   if (sum(Premer.13D[i, 58:107] == 3) >= 1 &&
       sum(Premer.13D[i, 58:107] == 1) <= 2 &&
       sum(Premer.13D[i, 58:107] == 2) <= 2 &&
       sum(Premer.13D[i, 7:56]) <= 150) {
      incidence3[i] <- 2.5
      next()
   }
   
   # incidence = 7.5  In the upper canopy with less than 75% plants infected
   if (sum(Premer.13D[i, 58:107] == 3) >= 0 &&
       sum(Premer.13D[i, 58:107] == 2) > 0 &&
       sum(Premer.13D[i, 58:107] == 1) > 0 &&
       (sum(Premer.13D[i, 58:107] > 0) /
        length(Premer.13D[i, 58:107]) <= 0.75) &&
       sum(Premer.13D[i, 7:56]) >= 150) {
      incidence3[i] <- 7.5
      next()
   }
   #
   # incidence = 6.5
   if (sum(Premer.13D[i, 58:107] == 1) > 3 &&
       sum(Premer.13D[i, 58:107] >= 2) > 0 &&
       sum(Premer.13D[i, 7:56] <= 500)  &&
       (sum(Premer.13D[i, 58:107] > 0) /
        length(Premer.13D[i, 58:107]) >= 0.65)) {
      incidence3[i] <- 6.5
      next()
   }
   #
   #
   # incidence = 4.5 If PM is in the the lower and mid-canopy in less than 75% of plants and one or two in the upper canopy
   if (sum(Premer.13D[i, 58:107] == 1) <= 3 &&
       sum(Premer.13D[i, 58:107] >= 2) > 0 &&
       (sum(Premer.13D[i, 58:107] > 0) /
        length(Premer.13D[i, 58:107])) <= 0.75) {
      incidence3[i] <- 4.5
      next()
   } else{
      # If none of the conditions are met give the incidence zero
      incidence3[i] <- 0
   }
   
}# end incidence loop

if(any(incidence3 == 0)){
   warning("Code caluculated incidence on '0' which is off the incidence scale")}


# Re-format data-frame
if(D_assess == "19 DAT1 19-3-2013"){
   Premer.13D.1 <- Premer.13D[,c("Treat", "Rep", "Run", "Plot")]
   Premer.13D.1$Inc_19D <-  incidence3}
   

if(D_assess == "31 DAT1 31-3-2013"){
   Premer.13D.2 <- Premer.13D[,c("Treat", "Rep", "Run", "Plot")]
   Premer.13D.2$Inc_31D <-  incidence3}

}# end disease assessment loop


# The 19 Days after T1 only assessed the first 6 treatments
# Therefore it will be dropped
#Premer.13D <- left_join(Premer.13D.1,Premer.13D.2)
Premer.13D <- Premer.13D.2


# read in yield and format
Premer.13Y <-
   as.data.frame(
      read_xlsx(
         path = "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/AM1303 Fungicides for powdery mildew in mungbean - Premer.xlsx",
         sheet = "Yield 18-4-2013",
         range = "A14:F58",
         col_names = TRUE
      )
   )
Premer.13Y$Treat <- as.character(Premer.13Y$Treat)

Premer_13 <- left_join(Premer.13D,Premer.13Y)

```

#### Define treatment data
```{r Premer13_define_treat}

Premer_13 <- Premer_13 %>%
   mutate(trade_name = 
             case_when(Treat == "1" ~ "control",
                       Treat == "2" ~ "Spin-flo",
                       Treat == "3" ~ "Tilt",
                       Treat == "4" ~ "Amistar Xtra",
                       Treat == "5" ~ "Amistar Xtra + adj",
                       Treat == "6" ~ "Cabrio",
                       Treat == "7" ~ "Spin-flo",
                       Treat == "8" ~ "Tilt",
                       Treat == "9" ~ "Amistar Xtra + adj",
                       Treat == "10" ~ "Cabrio",
                       Treat == "11" ~ "Tilt",
                       TRUE ~ "other"))%>%
   mutate(fungicide_ai = 
             case_when(Treat == "1" ~ "control",
                       Treat == "2" ~ "carbendazim",
                       Treat == "3" ~ "propiconazole",
                       Treat == "4" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       Treat == "5" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       Treat == "6" ~ "pyraclostrobin",
                       Treat == "7" ~ "carbendazim",
                       Treat == "8" ~ "propiconazole",
                       Treat == "9" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       Treat == "10" ~ "pyraclostrobin",
                       Treat == "11" ~ "propiconazole",
                       TRUE ~ "other"))%>%
   mutate(dose_ai.ha = 
             case_when(Treat == "1" ~ 0,
                       Treat == "2" ~ 250,
                       Treat == "3" ~ 62.5,
                       Treat == "4" ~ 40,
                       Treat == "5" ~ 40,
                       Treat == "6" ~ 125,
                       Treat == "7" ~ 250,
                       Treat == "8" ~ 62.5,
                       Treat == "9" ~ 40,
                       Treat == "10" ~ 125,
                       Treat == "11" ~ 62.5,
                       TRUE ~ 0))%>%
   mutate(fungicide_application_1 = 
             case_when(Treat == "1" ~ as.Date(NA),
                       Treat == "2" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "3" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "4" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "5" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "6" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "7" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "8" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "9" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "10" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       Treat == "11" ~ as.Date("2013-02-28", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_2 = 
             case_when(Treat == "7" ~ as.Date("2013-03-19", format = "%Y-%m-%d"),
                       Treat == "8" ~ as.Date("2013-03-19", format = "%Y-%m-%d"),
                       Treat == "9" ~ as.Date("2013-03-19", format = "%Y-%m-%d"),
                       Treat == "10" ~ as.Date("2013-03-19", format = "%Y-%m-%d"),
                       Treat == "11" ~ as.Date("2013-03-19", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_3 = 
             case_when(Treat == "11" ~ as.Date("2013-03-31", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(spray_n = 
             case_when(Treat == "1" ~ 0,
                       Treat == "2" ~ 1,
                       Treat == "3" ~ 1,
                       Treat == "4" ~ 1,
                       Treat == "5" ~ 1,
                       Treat == "6" ~ 1,
                       Treat == "7" ~ 2,
                       Treat == "8" ~ 2,
                       Treat == "9" ~ 2,
                       Treat == "10" ~ 2,
                       Treat == "11" ~ 3, 
                       TRUE ~ 0))
```


#### Input trial data
```{r Prem13_Trialdat}

Premer_13_dat <- 
   data.frame(trial_ref = "AM1303",
              year = "2013",
              location = "Premer",
              host_genotype = "Crystal",
              trial_design = "RCB",
              plot_length = 12,
              plot_width = 4,
              plant_density = as.Date(NA),
              row_spacing = as.Date(NA),
              replicate = Premer_13$Rep,
              planting_date = as.Date("2013-12-28", format = "%Y-%m-%d"),
              emergence_date = as.Date(NA),
              flowering_date = as.Date("2013-02-28", format = "%Y-%m-%d"),
              pod_fill_date = as.Date(NA),
              mid_late_pod_fill = as.Date(NA),
              first_sign_disease = as.Date("2013-02-28", format = "%Y-%m-%d"),
              trade_name = as.factor(Premer_13$trade_name),
              fungicide_ai = Premer_13$fungicide_ai,
              dose_ai.ha = Premer_13$dose_ai.ha,
              n_treatment = Premer_13$Treat,
              fungicide_application_1 = Premer_13$fungicide_application_1,
              fungicide_application_2 = Premer_13$fungicide_application_2,
              fungicide_application_3 = Premer_13$fungicide_application_3,
              total_fungicide = Premer_13$spray_n,
              harvest_date = as.Date("2013-04-18", format = "%Y-%m-%d"),
              final_assessment = as.Date("2013-03-31", format = "%Y-%m-%d"),
              PM_final_severity = Premer_13$Inc_31D,
              rating_scale = "1-9",
              grain_yield.t.ha. = as.numeric(Premer_13$`Yield kg/ha`)/1000
             # AUDPC = apply(Premer_13[,c("Inc_19D","Inc_31D")]-1,1, FUN = audpc, dates = c(19,12+19)) # -1 to the data because zero disease = 1 on rating scale// Dates are based off days from first sign
              )

Premer_13_dat <- cbind(Premer_13_dat,
                          AUDPC = apply(data.frame(zero = 1,
                                                   Premer_13[,c("Inc_31D")]-1),
                                        1, 
                                        FUN = audpc, 
                                        dates = c((Premer_13_dat$first_sign_disease[1]-7)-
                                                     Premer_13_dat$planting_date[1],
                                                  12+19)
                                        )
                          )

```


#### Calculating the treatment means
```{r Prem13_TreatmentMeans}
Premer_13_m <- Premer_13_dat %>%
   group_by(trial_ref, year, location, host_genotype, trial_design, 
            trade_name,fungicide_ai,dose_ai.ha,n_treatment) %>%
   summarise(plot_length.m. = mean(plot_length, na.rm = TRUE),
              plot_width.m. = mean(plot_width, na.rm = TRUE),
              plant_density = unique(plant_density),
              row_spacing = unique(row_spacing),
              replicates = sum(as.numeric(replicate)),
              planting_date = unique(planting_date),
              emergence_date = NA,
              flowering_date = unique(flowering_date),
              pod_fill_date = unique(pod_fill_date),
              mid_late_pod_fill = unique(mid_late_pod_fill),
              first_sign_disease = unique(first_sign_disease),
              fungicide_application_1 = unique(fungicide_application_1),
              fungicide_application_2 = unique(fungicide_application_2),
              fungicide_application_3 = unique(fungicide_application_3),
              total_fungicide = unique(total_fungicide),
              harvest_date = unique(harvest_date),
              final_assessment = unique(final_assessment),
              PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
              rating_scale = unique(rating_scale),
              disease_error = sd(PM_final_severity, na.rm = TRUE), # why is this not working
              D_error_type = "stdev",
              grain_yield.t.ha. = mean(grain_yield.t.ha., na.rm = TRUE),
              raw_graded = NA,
              yield_error = sd(grain_yield.t.ha., na.rm = TRUE),
              Y_error_type = "stdev",
             AUDPC.m = mean(AUDPC),
             AUDPC.sd = sd(AUDPC),
              meanSq = anova(lm(grain_yield.t.ha. ~ factor(total_fungicide), 
                                data = Premer_13_dat[Premer_13_dat$fungicide_ai == "propiconazole" | 
                                                        Premer_13_dat$fungicide_ai == "control" ,]))[1,3]
   )



# For some wierd reason standard deviations are comming back NA in the code above
# Because of n_treatment being converted to a factor I need to wrangle carefully here
Prem_tmp <- Premer_13_dat %>%
   group_by(n_treatment) %>%
   summarise(disease_error = sd(PM_final_severity, na.rm = TRUE),
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE))

# Remive the existing yield_error columns and replace with new ones
Premer_13_m <- left_join(Premer_13_m[,colnames(Premer_13_m)[c(-29,-33)]], Prem_tmp)

# Remove other plots not in experiment
Premer_13_m <- Premer_13_m[Premer_13_m$trade_name != "other",]


Premer_13_m$n_treatment <- as.numeric(as.character(Premer_13_m$n_treatment))
Premer_13_m <- fold_data(Premer_13_m, PM_MB_means)

write.csv(
   Premer_13_m[order(as.numeric(Premer_13_m$n_treatment)),],
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/BB1305_Millmerran_means.csv",
   row.names = FALSE
)
##########################
# For some wierd reason standard deviations are comming back NA in the code above
Premer_13_m[,c("disease_error","yield_error")] <- 
   Premer_13_dat %>%
   group_by(n_treatment) %>%
   summarise(disease_error = sd(PM_final_severity, na.rm = TRUE),
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE)) %>%
   select(c("disease_error","yield_error"))


Premer_13_m <- fold_data(Premer_13_m, PM_MB_means)

Premer_13_m <- Premer_13_m[Premer_13_m$trade_name != "other",]

write.csv(
   Premer_13_m,
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/AM1303-Premer-Disease_means.csv"
)



```

### Millmerran 2013
#### Convert disease scores
```{r Millm_13_convert_scores}

for(D_assess in c("Assessment Sheet 5.4.2013","Assessment Sheet 24.4.2013")){

# Import final disease survey
Millm_13D <-
   as.data.frame(
      read_xlsx(
         path = "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/BB1305 Fungicides for powdery mildew in mungbean - Millmerran.xlsx",
         sheet = D_assess,
         range = "A12:AH56",
         col_names = TRUE
      )
   )



colnames(Millm_13D)[1:4] <- c("Run", "Plot", "Treat", "Rep")
Millm_13D <- Millm_13D[order(Millm_13D[,1],Millm_13D[,2],Millm_13D[,3],Millm_13D[,4]),]


sum(is.na(Millm_13D[, 5:34]))
# replace NAs with zero Plots not surveyed
for (i in 5:34) {
   for (j in seq_along(Millm_13D[, i])) {
      if (is.na(Millm_13D[j, i])) {
         Millm_13D[j, i] <- 0
      }
   }
}



incidence4 <-
   vector(mode = "numeric", length = length(Millm_13D[, 1]))

# Calculate incidence
#     Sites
# low canopy  c(5:13)
# mid canopy c(15:23)
# upp canopy c(25:33)


# Convert disease survey data to 1-9 Incidence rating scale
for (i in seq_along(incidence4)) {
   # incidence = 1
   if (all(Millm_13D[i, c(5:13, 15:23, 25:33)] == 0)) {
      incidence4[i] <- 1
      next()
   }
   
   # incidence = 2
   if (sum(Millm_13D[i, 5:13] != 0) >= 1 &&
       all(Millm_13D[i, 15:23] == 0) &&
       all(Millm_13D[i, 25:33] == 0) &&
       (sum(Millm_13D[i, c(5:13)] > 0) /
        length(Millm_13D[i, c(5:13)])) <= 0.75) {
      incidence4[i] <- 2
      next()
   }
   
   
   # incidence = 3
   if (sum(Millm_13D[i, 5:13] != 0) >= 1 &&
       sum(Millm_13D[i, 15:23] != 0) <= 3 &&
       sum(Millm_13D[i, 25:33] == 0) == 0 &&
       (sum(Millm_13D[i, c(5:13, 15:23)] > 0) /
        length(Millm_13D[i, c(5:13, 15:23)])) >= 0.75) {
      incidence4[i] <- 3
   } else{
      # if it is in the lower half of the canopy and in less than 75% of plants then incidence = 2.5
      if (sum(Millm_13D[i, 5:13] != 0) >= 1 &&
          sum(Millm_13D[i, 15:23] != 0) <= 3 &&
          sum(Millm_13D[i, 25:33] == 0) == 0 &&
          (sum(Millm_13D[i, c(5:13, 15:23)] > 0) /
           length(Millm_13D[i, c(5:13, 15:23)])) <= 0.75) {
         incidence4[i] <- 2.5
         next()
      }
   }
   
   
   # incidence = 4
   if (sum(Millm_13D[i, 5:13] != 0) >= 1 &&
       sum(Millm_13D[i, 15:23] != 0) >= 1 &&
       all(Millm_13D[i, 25:33] == 0) &&
       (sum(Millm_13D[i, c(5:13, 15:23)] > 0) /
        length(Millm_13D[i, c(5:13, 15:23)])) <= 0.75) {
      incidence4[i] <- 4
      next()
   }
   
   
   # incidence = 5
   if (sum(Millm_13D[i, 5:13] != 0) >= 1 &&
       sum(Millm_13D[i, 15:23] != 0) >= 1 &&
       all(Millm_13D[i, 25:33] == 0) &&
       (sum(Millm_13D[i, c(5:13, 15:23)] > 0) /
        length(Millm_13D[i, c(5:13, 15:23)])) >= 0.75) {
      incidence4[i] <- 5
      next()
   }
   
   
   # incidence = 6
   if (sum(Millm_13D[i, 5:13] != 0) >= 1 &&
       sum(Millm_13D[i, 15:23] != 0) >= 1 &&
       all(Millm_13D[i, 25:33] == 0) &&
       (sum(Millm_13D[i, c(5:13, 15:23)] > 0) /
        length(Millm_13D[i, c(5:13, 15:23)])) >= 0.90) {
      incidence4[i] <- 6
      next()
   }
   
   
   # incidence = 7
   if (sum(Millm_13D[i, 5:13] != 0) >= 1 &&
       sum(Millm_13D[i, 15:23] != 0) >= 1 &&
       sum(Millm_13D[i, 25:33] != 0) <= 3 &&
       (sum(Millm_13D[i, c(5:13, 15:23)] > 0) /
        length(Millm_13D[i, c(5:13, 15:23)])) >= 0.90) {
      incidence4[i] <- 7
      next()
   }
   
   
   # incidence = 8
   if (sum(Millm_13D[i, 5:13] != 0) >= 1 &&
       sum(Millm_13D[i, 15:23] != 0) >= 1 &&
       sum(Millm_13D[i, 25:33] != 0) >= 1 &&
       (sum(Millm_13D[i, c(5:13, 15:23, 25:33)] > 0) /
        length(Millm_13D[i, c(5:13, 15:23, 25:33)])) >= 0.75) {
      incidence4[i] <- 8
      next()
   }
   
   
   # incidence = 9
   if (sum(Millm_13D[i, 5:13] != 0) >= 1 &&
       sum(Millm_13D[i, 15:23] != 0) >= 1 &&
       sum(Millm_13D[i, 25:33] != 0) >= 1 &&
       (sum(Millm_13D[i, c(5:13, 15:23, 25:33)] > 0) /
        length(Millm_13D[i, c(5:13, 15:23, 25:33)])) >= 0.75 &&
       sum(Millm_13D[i, c(5:13, 15:23, 25:33)]) > (9 * 3 * 100) * 0.75) {
      incidence4[i] <- 9
      next()
   }
   
   
   # if there are few (< 10%) leaves with very small infections in all parts of the canopy OR
   # if there is a stray colony on a upper leaf in addition to all lower
   
   if (sum(Millm_13D[i, 15:23] != 0) <= 3 &&
       sum(Millm_13D[i, 25:33] != 0) <= 3 &&
       (sum(Millm_13D[i, c(5:13, 15:23, 25:33)]) /
        length(Millm_13D[i, c(5:13, 15:23, 25:33)]) / 100) <= 0.1) {
      incidence4[i] <- 2.5
      next()
   }
   
   # incidence = 7.5  In the upper canopy with less than 75% plants infected
   if (sum(Millm_13D[i, 5:13] != 0) >= 1 &&
       sum(Millm_13D[i, 15:23] != 0) >= 1 &&
       sum(Millm_13D[i, 25:33] != 0) >= 3 &&
       (sum(Millm_13D[i, c(5:13, 15:23, 25:33)] > 0) /
        length(Millm_13D[i, c(5:13, 15:23, 25:33)])) <= 0.75) {
      incidence4[i] <- 7.5
      next()
   }
   
   # if there are few more colonies(< 10%) leaves with very small infections in all parts of the canopy OR
   # if there is a stray colony on a upper leaf in addition to all lower
   
   if (sum(Millm_13D[i, 15:23] != 0) <= 6 &&
       sum(Millm_13D[i, 25:33] != 0) <= 3 &&
       (sum(Millm_13D[i, c(5:13, 15:23, 25:33)]) /
        length(Millm_13D[i, c(5:13, 15:23, 25:33)]) / 100) <= 0.1) {
      incidence4[i] <- 3.5
      next()
   }
   
   if (sum(Millm_13D[i, 15:23] != 0) >= 1 &&
       sum(Millm_13D[i, 25:33] != 0) <= 3 &&
       (sum(Millm_13D[i, c(5:13, 15:23, 25:33)]) /
        length(Millm_13D[i, c(5:13, 15:23, 25:33)]) / 100) <= 0.5) {
      incidence4[i] <- 6.5
      next()
   }
   else{
      # If none of the conditions are met give the incidence zero
      incidence4[i] <- 0
   }
}
# end incidence loop

if(any(incidence4 == 0)){
   warning("Code caluculated incidence on '0' which is off the incidence scale")}


# Re-format data-frame
if(D_assess == "Assessment Sheet 5.4.2013"){
   Millm_13D.1 <- Millm_13D[,c("Treat", "Rep", "Run", "Plot")]
   Millm_13D.1$Inc_23D <-  incidence4}
   

if(D_assess == "Assessment Sheet 24.4.2013"){
   Millm_13D.2 <- Millm_13D[,c("Treat", "Rep", "Run", "Plot")]
   Millm_13D.2$Inc_42D <-  incidence4}

}# end disease assessment loop


# The 19 Days after T1 only assessed the first 6 treatments
# Therefore it will be dropped
Millm_13D <- left_join(Millm_13D.1, Millm_13D.2)



# read in yield and format
# read in yield and format
Millm.13Y <-
   as.data.frame(
      read_xlsx(
         path = "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/BB1305 Fungicides for powdery mildew in mungbean - Millmerran.xlsx",
         sheet = "Harvest Sheet 6.5.2013",
         range = "A11:F55",
         col_names = TRUE
      )
   )
Millm.13Y$Treatment <- as.character(Millm.13Y$Treatment)
Millm.13Y$Treat <- as.double(Millm.13Y$Treat)
colnames(Millm.13Y)[1:4] <- c("Run", "Plot","TreatY", "Rep")

Millm_13 <- left_join(Millm_13D, Millm.13Y, by = c("Run", "Plot","Treat", "Rep"))


```

#### Define treatment data
```{r Millm_13_define_treat}

Millm_13 <- Millm_13 %>%
   mutate(trade_name = 
             case_when(Treat == "1" ~ "control",
                       Treat == "2" ~ "Spin-flo",
                       Treat == "3" ~ "Tilt",
                       Treat == "4" ~ "Amistar Xtra",
                       Treat == "5" ~ "Amistar Xtra + adj",
                       Treat == "6" ~ "Cabrio",
                       Treat == "7" ~ "Spin-flo",
                       Treat == "8" ~ "Tilt",
                       Treat == "9" ~ "Amistar Xtra + adj",
                       Treat == "10" ~ "Cabrio",
                       Treat == "11" ~ "Tilt",
                       TRUE ~ "other"))%>%
   mutate(fungicide_ai = 
             case_when(Treat == "1" ~ "control",
                       Treat == "2" ~ "carbendazim",
                       Treat == "3" ~ "propiconazole",
                       Treat == "4" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       Treat == "5" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       Treat == "6" ~ "pyraclostrobin",
                       Treat == "7" ~ "carbendazim",
                       Treat == "8" ~ "propiconazole",
                       Treat == "9" ~ "200 g/L azoxystrobin + 80 g/L cyproconazole",
                       Treat == "10" ~ "pyraclostrobin",
                       Treat == "11" ~ "propiconazole",
                       TRUE ~ "other"))%>%
   mutate(dose_ai.ha = 
             case_when(Treat == "1" ~ 0,
                       Treat == "2" ~ 250,
                       Treat == "3" ~ 62.5,
                       Treat == "4" ~ 40,
                       Treat == "5" ~ 40,
                       Treat == "6" ~ 125,
                       Treat == "7" ~ 250,
                       Treat == "8" ~ 62.5,
                       Treat == "9" ~ 40,
                       Treat == "10" ~ 125,
                       Treat == "11" ~ 62.5,
                       TRUE ~ 0))%>%
   mutate(fungicide_application_1 = 
             case_when(Treat == "1" ~ as.Date(NA),
                       Treat == "2" ~ as.Date("2013-03-13", format = "%Y-%m-%d"),
                       Treat == "3" ~ as.Date("2013-03-13", format = "%Y-%m-%d"),
                       Treat == "4" ~ as.Date("2013-03-13", format = "%Y-%m-%d"),
                       Treat == "5" ~ as.Date("2013-03-13", format = "%Y-%m-%d"),
                       Treat == "6" ~ as.Date("2013-03-13", format = "%Y-%m-%d"),
                       Treat == "7" ~ as.Date("2013-03-13", format = "%Y-%m-%d"),
                       Treat == "8" ~ as.Date("2013-03-13", format = "%Y-%m-%d"),
                       Treat == "9" ~ as.Date("2013-03-13", format = "%Y-%m-%d"),
                       Treat == "10" ~ as.Date("2013-03-13", format = "%Y-%m-%d"),
                       Treat == "11" ~ as.Date("2013-03-13", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_2 = 
             case_when(Treat == "7" ~ as.Date("2013-03-21", format = "%Y-%m-%d"),
                       Treat == "8" ~ as.Date("2013-03-21", format = "%Y-%m-%d"),
                       Treat == "9" ~ as.Date("2013-03-21", format = "%Y-%m-%d"),
                       Treat == "10" ~ as.Date("2013-03-21", format = "%Y-%m-%d"),
                       Treat == "11" ~ as.Date("2013-03-21", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_3 = 
             case_when(Treat == "11" ~ as.Date("2013-03-28", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(spray_n = 
             case_when(Treat == "1" ~ 0,
                       Treat == "2" ~ 1,
                       Treat == "3" ~ 1,
                       Treat == "4" ~ 1,
                       Treat == "5" ~ 1,
                       Treat == "6" ~ 1,
                       Treat == "7" ~ 2,
                       Treat == "8" ~ 2,
                       Treat == "9" ~ 2,
                       Treat == "10" ~ 2,
                       Treat == "11" ~ 3, 
                       TRUE ~ 0))
```


#### Input trial data
```{r Millm13_Trialdat}

Millm_13_dat <- 
   data.frame(trial_ref = "BB1305",
              year = "2013",
              location = "Millmerran",
              host_genotype = "Crystal",
              trial_design = "RCB",
              plot_length = 12,
              plot_width = 4,
              plant_density = as.Date(NA),
              row_spacing = 1/3,
              replicate = Millm_13$Rep,
              planting_date = as.Date(NA),
              emergence_date = as.Date(NA),
              flowering_date = as.Date(NA),
              pod_fill_date = as.Date("2013-03-21", format = "%Y-%m-%d"),
              mid_late_pod_fill = as.Date("2013-03-28", format = "%Y-%m-%d"),
              first_sign_disease = as.Date("2013-03-13", format = "%Y-%m-%d"),
              trade_name = as.factor(Millm_13$trade_name),
              fungicide_ai = Millm_13$fungicide_ai,
              dose_ai.ha = Millm_13$dose_ai.ha,
              n_treatment = Millm_13$Treat,
              fungicide_application_1 = Millm_13$fungicide_application_1,
              fungicide_application_2 = Millm_13$fungicide_application_2,
              fungicide_application_3 = Millm_13$fungicide_application_3,
              total_fungicide = Millm_13$spray_n,
              harvest_date = as.Date("2013-05-06", format = "%Y-%m-%d"),
              final_assessment = as.Date("2013-04-24", format = "%Y-%m-%d"),
              PM_final_severity = Millm_13$Inc_42D,
              rating_scale = "1-9",
              grain_yield.t.ha. = as.numeric(Millm_13$`kg/Ha`)/1000
              #AUDPC = apply(Millm_13[,c("Inc_23D","Inc_42D")]-1,1, FUN = audpc, dates = c(23,42)) # -1 to the data because zero disease = 1 on rating scale// Dates are based off days from first sign
              )


Millm_13_dat <- cbind(Millm_13_dat,
                          AUDPC = apply(data.frame(zero = 1,
                                                   Millm_13[,c("Inc_23D","Inc_42D")]-1),
                                        1, 
                                        FUN = audpc, 
                                        dates = c((Millm_13_dat$first_sign_disease[1]-7)-
                                                     Millm_13_dat$planting_date[1],
                                                  23,42)
                                        )
                          )
```


#### Calculating the treatment means
```{r Millm13_TreatmentMeans}
Millm_13_m <- Millm_13_dat %>%
   group_by(trial_ref, year, location, host_genotype, trial_design, 
            trade_name,fungicide_ai,dose_ai.ha,n_treatment) %>%
   summarise(plot_length.m. = mean(plot_length, na.rm = TRUE),
             plot_width.m. = mean(plot_width, na.rm = TRUE),
             plant_density = unique(plant_density),
             row_spacing = unique(row_spacing),
             replicates = length(as.numeric(replicate)),
             planting_date = unique(planting_date),
             emergence_date = NA,
             flowering_date = unique(flowering_date),
             pod_fill_date = unique(pod_fill_date),
             mid_late_pod_fill = unique(mid_late_pod_fill),
             first_sign_disease = unique(first_sign_disease),
             fungicide_application_1 = unique(fungicide_application_1),
             fungicide_application_2 = unique(fungicide_application_2),
             fungicide_application_3 = unique(fungicide_application_3),
             total_fungicide = unique(total_fungicide),
             harvest_date = unique(harvest_date),
             final_assessment = unique(final_assessment),
             PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
             rating_scale = unique(rating_scale),
             disease_error = sd(PM_final_severity, na.rm = TRUE), # why is this not working
             D_error_type = "stdev",
             grain_yield.t.ha. = mean(grain_yield.t.ha., na.rm = TRUE),
             raw_graded = NA,
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE),
             Y_error_type = "stdev",
             AUDPC.m = mean(AUDPC),
             AUDPC.sd = sd(AUDPC),
             meanSq = anova(lm(grain_yield.t.ha. ~ factor(total_fungicide), 
                                data = Millm_13_dat[Millm_13_dat$fungicide_ai == "propiconazole" | 
                                                        Millm_13_dat$fungicide_ai == "control" ,]))[1,3]
   )



# For some wierd reason standard deviations are comming back NA in the code above
# Because of n_treatment being converted to a factor I need to wrangle carefully here
Millm_tmp <- Millm_13_dat %>%
   group_by(n_treatment) %>%
   summarise(disease_error = sd(PM_final_severity, na.rm = TRUE),
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE))

# Remive the existing yield_error columns and replace with new ones
Millm_13_m <- left_join(Millm_13_m[,colnames(Millm_13_m)[c(-29,-33)]], Millm_tmp)

# Remove other plots not in experiment
Millm_13_m <- Millm_13_m[Millm_13_m$trade_name != "other",]


Millm_13_m$n_treatment <- as.numeric(as.character(Millm_13_m$n_treatment))
Millm_13_m <- fold_data(Millm_13_m, PM_MB_means)

write.csv(
   Millm_13_m[order(as.numeric(Millm_13_m$n_treatment)),],
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2013/BB1305_Millmerran_means.csv"
)

```




### Hermitage 2015
```{r Herm_15}

Herm_15 <-
   read.xlsx(
      "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2015 PMmung Herm/Mugbean powdery mildew 2014-15 inc results v2.xlsx",
      sheet = "HRS yield data",
      startRow = 4,
      colNames = TRUE,
      detectDates = TRUE
   )[1:31, 1:9]



Herm_15$Year <- 2015
Herm_15$location <- "Hermitage"

# Disease incidence assessments through the 2016 season
Herm_15.DR  <-
   read.xlsx(
      "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2015 PMmung Herm/Mugbean powdery mildew 2014-15 inc results v2.xlsx",
      sheet = "HRS ratings & graphs",
      startRow = 5,
      colNames = TRUE
   )[1:31, 1:8]

Herm_15$Plot.Length <- as.numeric(Herm_15$Plot.Length)
Herm_15$Plot.Weight <- as.numeric(Herm_15$Plot.Weight)
Herm_15$Plot.weight <- as.numeric(Herm_15$Plot.weight)
Herm_15$`Plot.Yield.(kg/ha)` <-
   as.numeric(Herm_15$`Plot.Yield.(kg/ha)`)
Herm_15$`Plot.Yield.(t/ha)` <-
   as.numeric(Herm_15$`Plot.Yield.(t/ha)`)

# Rename the plot column and remove lines without data
colnames(Herm_15)[3] <- "Plot"
Herm_15.DR <- Herm_15.DR[!is.na(Herm_15.DR$Treatment),]


# rename the disease assesment columns
# For comparing between trials I am forcing the assumption 
#   that the disease did not exist prior to it being spotted in the trial. 
#   Therefore day0 observes zero disease and day1 is first sign
colnames(Herm_15.DR)[4:8] <- c("day0", "day1", "day8", "day15","day22") 
Herm_15.DR$day0 <- as.numeric(Herm_15.DR$day0)
Herm_15.DR$day1 <- as.numeric(Herm_15.DR$day1)
Herm_15.DR$day8 <- as.numeric(Herm_15.DR$day8)
Herm_15.DR$day15 <- as.numeric(Herm_15.DR$day15)
Herm_15.DR$day22 <- as.numeric(Herm_15.DR$day22)



# Merge yield and disease data
Herm_15 <- left_join(Herm_15.DR, Herm_15)

```


#### Define treatment data
```{r Herm_15_Treats}

Herm_15_dat <- Herm_15 %>%
   mutate(n_treatment = 
             case_when(Treatment == "1st sign +1" ~ 4,
                       Treatment == "control" ~ 1,
                       Treatment == "1st sign" ~ 3,
                       Treatment == "1/3C + 1" ~ 6,
                       Treatment == "5wks+2" ~ 2,
                       Treatment == "1/3C" ~ 5,
                       TRUE ~ 9998))%>%
   mutate(trade_name = 
             case_when(Treatment == "control" ~ "control",
                       TRUE ~ "Folicur"))%>%
   mutate(fungicide_ai = 
             case_when(Treatment == "control" ~ "control",
                       TRUE ~ "tebuconazole"))%>%
   mutate(dose_ai.ha = 
             case_when(Treatment == "control" ~ 0,
                       TRUE ~ 62.35))%>%
   mutate(fungicide_application_1 = 
             case_when(Treatment == "1st sign +1" ~ as.Date("2015-03-17", format = "%Y-%m-%d"),
                       Treatment == "control" ~ as.Date(NA),
                       Treatment == "1st sign" ~ as.Date("2015-03-17", format = "%Y-%m-%d"),
                       Treatment == "1/3C + 1" ~ as.Date("2015-03-23", format = "%Y-%m-%d"),
                       Treatment == "5wks+2" ~ as.Date("2015-03-02", format = "%Y-%m-%d"),
                       Treatment == "1/3C" ~ as.Date("2015-03-23", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_2 = 
             case_when(Treatment == "1st sign +1" ~ as.Date("2015-03-31", format = "%Y-%m-%d"),
                       Treatment == "control" ~ as.Date(NA),
                       Treatment == "1/3C + 1" ~ as.Date("2015-04-07", format = "%Y-%m-%d"),
                       Treatment == "5wks+2" ~ as.Date("2015-03-17", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_3 = 
             case_when(Treatment == "5wks+2" ~ as.Date("2015-03-31", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(spray_n = 
             case_when(Treatment == "1st sign +1" ~ 2,
                       Treatment == "control" ~ 0,
                       Treatment == "1st sign" ~ 1,
                       Treatment == "1/3C + 1" ~ 2,
                       Treatment == "5wks+2" ~ 3,
                       Treatment == "1/3C" ~ 1,
                       TRUE ~ 9999))

```


#### Input trial data
```{r Herm15_Trialdat}

Herm_15_dat <- 
   data.frame(trial_ref = "mung1415/01",
              year = "2015",
              location = "Hermitage",
              host_genotype = "Jade",
              trial_design = "RCB",
              plot_length = 12,
              plot_width = 4,
              plant_density = NA,
              row_spacing = 0.75,
              replicate = Herm_15_dat$Rep,
              planting_date = as.Date("2015-01-19", format = "%Y-%m-%d"),
              emergence_date = as.Date("2015-01-24", format = "%Y-%m-%d"),
              flowering_date = as.Date(NA),
              pod_fill_date = as.Date(NA),
              mid_late_pod_fill = as.Date(NA),
              first_sign_disease = as.Date("2015-03-16", format = "%Y-%m-%d"),
              trade_name = as.factor(Herm_15_dat$trade_name),
              fungicide_ai = Herm_15_dat$fungicide_ai,
              dose_ai.ha = Herm_15_dat$dose_ai.ha,
              n_treatment = as.numeric(Herm_15_dat$n_treatment),
              fungicide_application_1 = Herm_15_dat$fungicide_application_1,
              fungicide_application_2 = Herm_15_dat$fungicide_application_2,
              fungicide_application_3 = Herm_15_dat$fungicide_application_3,
              total_fungicide = Herm_15_dat$spray_n,
              harvest_date = as.Date("2015-04-20", format = "%Y-%m-%d"),
              final_assessment = as.Date("2015-04-06", format = "%Y-%m-%d"),
              PM_final_severity = Herm_15_dat$day22,
              rating_scale = "1-9",
              grain_yield.t.ha. = as.numeric(Herm_15_dat$`Plot.Yield.(t/ha)`),
              AUDPC = apply(Herm_15_dat[,c("day0", "day1", "day8", "day15","day22")]-1,1, 
                            FUN = audpc, dates = c(0,1,8,15,22)) # -1 to the data because zero disease = 1 on rating scale// Dates are based off days from first sign
              )

```


#### Calculating treatment means
```{r Herm15_means}
Herm_15_m <- Herm_15_dat %>%
   group_by(host_genotype, n_treatment) %>%
   summarise(trial_ref = unique(trial_ref),
             year = unique(year),
             location = unique(location),
             trial_design = unique(trial_design),
             trade_name = unique(trade_name),
             fungicide_ai = unique(fungicide_ai),
             dose_ai.ha = unique(dose_ai.ha),
             trial_ref = unique(trial_ref),
             plot_length.m. = mean(plot_length, na.rm = TRUE),
             plot_width.m. = mean(plot_width, na.rm = TRUE),
             plant_density = unique(plant_density),
             row_spacing = unique(row_spacing),
             replicates = length(as.numeric(replicate)),
             planting_date = unique(planting_date),
             emergence_date = unique(emergence_date),
             flowering_date = unique(flowering_date),
             pod_fill_date = unique(pod_fill_date),
             mid_late_pod_fill = unique(mid_late_pod_fill),
             first_sign_disease = unique(first_sign_disease),
             fungicide_application_1 = unique(fungicide_application_1),
             fungicide_application_2 = unique(fungicide_application_2),
             fungicide_application_3 = unique(fungicide_application_3),
             total_fungicide = unique(total_fungicide),
             harvest_date = unique(harvest_date),
             final_assessment = unique(final_assessment),
             PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
             rating_scale = unique(rating_scale),
             disease_error = sd(PM_final_severity, na.rm = TRUE), # why is this not working
             D_error_type = "stdev",
             grain_yield.t.ha. = mean(grain_yield.t.ha., na.rm = TRUE),
             raw_graded = NA,
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE),
             Y_error_type = "stdev",
             AUDPC.m = mean(AUDPC),
             AUDPC.sd = sd(AUDPC),
             meanSq = anova(lm(grain_yield.t.ha. ~ factor(n_treatment), data = Herm_15_dat))[1,3]
   )



# For some wierd reason standard deviations are comming back NA in the code above
Herm_15_m[,c("disease_error","yield_error")] <- 
   Herm_15_dat %>%
   group_by(n_treatment) %>%
   summarise(disease_error = sd(PM_final_severity, na.rm = TRUE),
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE)) %>%
   select(c("disease_error","yield_error"))



Herm_15_m <- fold_data(Herm_15_m, PM_MB_means)


write.csv(
   Herm_15_m,
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2015 PMmung Herm/Herm_15_means.csv"
)

Herm_16
```


### Hermitage 2016  
Disease data for Hermitage 2016 only exists as a mean of treatments within the `2016 Mungbean PM trials summary.xlsx` file.  
```{r Herm16_dataimport}
# Yield data from 2016 Hermitage trial with final disease severity
Herm_16 <-
   read.xlsx(
      "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2016/Yeild Data 2016 Kingaroy Hermitage (PaulM adjusted).xlsx",
      sheet = "Hermitage",
      startRow = 1,
      colNames = TRUE
   )[1:28, 1:9]


Herm_16$Year <- 2016
Herm_16$location <- "Hermitage"

Herm_16$Plot <- as.numeric(unlist(strsplit(
   Herm_16$Plot, "P"))[
      seq(from = 2, to = 56, by = 2)])

```

#### Define treatment data
```{r Herm16_treatmentDefine}
Herm_16_dat <- Herm_16 %>%
   mutate(trade_name = 
             case_when(Treatment == "1" ~ "control",
                       TRUE ~ "Folicur"))%>%
   mutate(fungicide_ai = 
             case_when(Treatment == "1" ~ "control",
                       TRUE ~ "tebuconazole"))%>%
   mutate(dose_ai.ha = 
             case_when(Treatment == "1" ~ 0,
                       TRUE ~ 62.35))%>%
   mutate(fungicide_application_1 = 
             case_when(Treatment == "1" ~ as.Date(NA),
                       Treatment == "2" ~ as.Date("2016-03-17", format = "%Y-%m-%d"),
                       Treatment == "3" ~ as.Date("2016-03-17", format = "%Y-%m-%d"),
                       Treatment == "4" ~ as.Date("2016-03-17", format = "%Y-%m-%d"),
                       Treatment == "5" ~ as.Date("2016-03-8", format = "%Y-%m-%d"),
                       Treatment == "6" ~ as.Date("2016-03-8", format = "%Y-%m-%d"),
                       Treatment == "7" ~ as.Date("2016-03-17", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_2 = 
             case_when(Treatment == "1" ~ as.Date(NA),
                       Treatment == "3" ~ as.Date("2016-03-30", format = "%Y-%m-%d"),
                       Treatment == "4" ~ as.Date("2016-03-30", format = "%Y-%m-%d"),
                       Treatment == "6" ~ as.Date("2016-03-22", format = "%Y-%m-%d"),
                       Treatment == "7" ~ as.Date("2016-03-30", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_3 = 
             case_when(Treatment == "4" ~ as.Date("2016-04-13", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(spray_n = 
             case_when(Treatment == "1" ~ 0,
                       Treatment == "2" ~ 1,
                       Treatment == "3" ~ 2,
                       Treatment == "4" ~ 3,
                       Treatment == "5" ~ 1,
                       Treatment == "6" ~ 2,
                       Treatment == "7" ~ 2,
                       TRUE ~ 9999))

```

#### Input trial data
```{r Herm16_Trialdat}

Herm_16_dat <- 
   data.frame(trial_ref = "mung1516/01",
              year = "2016",
              location = "Hermitage",
              host_genotype = "Jade",
              trial_design = "RCB",
              plot_length = 12,
              plot_width = 4,
              plant_density = NA,
              row_spacing = 0.75,
              replicate = Herm_16_dat$rep,
              planting_date = as.Date("2016-02-03", format = "%Y-%m-%d"),
              emergence_date = as.Date("2016-02-12", format = "%Y-%m-%d"),
              flowering_date = as.Date(NA),
              pod_fill_date = as.Date(NA),
              mid_late_pod_fill = as.Date("2016-04-15", format = "%Y-%m-%d"),
              first_sign_disease = as.Date("2016-03-08", format = "%Y-%m-%d"),
              trade_name = as.factor(Herm_16_dat$trade_name),
              fungicide_ai = Herm_16_dat$fungicide_ai,
              dose_ai.ha = Herm_16_dat$dose_ai.ha,
              n_treatment = as.numeric(Herm_16_dat$Treatment),
              fungicide_application_1 = Herm_16_dat$fungicide_application_1,
              fungicide_application_2 = Herm_16_dat$fungicide_application_2,
              fungicide_application_3 = Herm_16_dat$fungicide_application_3,
              total_fungicide = Herm_16_dat$spray_n,
              harvest_date = as.Date("2015-05-06", format = "%Y-%m-%d"),
              final_assessment = as.Date("2015-04-15", format = "%Y-%m-%d"),
              PM_final_severity = NA,
              rating_scale = "1-9",
              grain_yield.t.ha. = as.numeric(Herm_16_dat$`Raw.Adjusted.Yeild./.ha`),
              stringsAsFactors = FALSE)
```


#### Calculating treatment means
```{r Herm16_means}
Herm_16_m <- Herm_16_dat %>%
   group_by(host_genotype, n_treatment) %>%
   summarise(trial_ref = unique(trial_ref),
             year = unique(year),
             location = unique(location),
             trial_design = unique(trial_design),
             trade_name = unique(trade_name),
             fungicide_ai = unique(fungicide_ai),
             dose_ai.ha = unique(dose_ai.ha),
             trial_ref = unique(trial_ref),
             plot_length.m. = mean(plot_length, na.rm = TRUE),
             plot_width.m. = mean(plot_width, na.rm = TRUE),
             plant_density = unique(plant_density),
             row_spacing = unique(row_spacing),
             replicates = length(as.numeric(replicate)),
             planting_date = unique(planting_date),
             emergence_date = unique(emergence_date),
             flowering_date = unique(flowering_date),
             pod_fill_date = unique(pod_fill_date),
             mid_late_pod_fill = unique(mid_late_pod_fill),
             first_sign_disease = unique(first_sign_disease),
             fungicide_application_1 = unique(fungicide_application_1),
             fungicide_application_2 = unique(fungicide_application_2),
             fungicide_application_3 = unique(fungicide_application_3),
             total_fungicide = unique(total_fungicide),
             harvest_date = unique(harvest_date),
             final_assessment = unique(final_assessment),
             #PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
             rating_scale = unique(rating_scale),
             #disease_error = sd(PM_final_severity, na.rm = TRUE), # why is this not working
             #D_error_type = "stdev",
             grain_yield.t.ha. = mean(grain_yield.t.ha., na.rm = TRUE),
             raw_graded = "Yes",
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE),
             Y_error_type = "stdev",
             #AUDPC.m = mean(AUDPC),
             #AUDPC.sd = sd(AUDPC),
             meanSq = anova(lm(grain_yield.t.ha. ~ factor(n_treatment), data = Herm_16_dat))[1,3]
   )

# For some wierd reason standard deviations are comming back NA in the code above
Herm_16_m[,"yield_error"] <- 
   Herm_16_dat %>%
   group_by(n_treatment) %>%
   summarise(yield_error = sd(grain_yield.t.ha., na.rm = TRUE)) %>%
   select(c("yield_error"))



# Mean Disease incidence assessments through the 2016 season
Herm_16.DR  <-
   read.xlsx(
      "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2016/2016 Mungbean PM trials summary.xlsx",
      sheet = "Hermitage_2016",
      startRow = 5,
      colNames = TRUE
   )
names(Herm_16.DR)[1:6] <- c("Treatment", "dae24","dae38","dae48","dae63","Final_Yield_tHa")
names(Herm_16.DR)[6] <- "Final_Yield_tHa"
Herm_16.DR$n_treatment <- c(4,3,7,5,2,6,1)


Herm_16_m <- left_join(Herm_16_m,Herm_16.DR)
Herm_16_m$AUDPC.m <- apply(Herm_16_m[,c("dae24", "dae38", "dae48", "dae63")]-1,1, 
                            FUN = audpc, dates = c(0,14,24,39))


Herm_16_m <- fold_data(Herm_16_m, PM_MB_means)


write.csv(
   Herm_16_m,
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2016/Hermitage/Herm_16_means.csv"
)

```

### Kingaroy 2016  
Disease data for Kingaroy 2016 only exists as a mean of treatments within the `2016 Mungbean PM trials summary.xlsx` file.  
```{r Herm16_dataimport}
# Yield data from 2016 Hermitage trial with final disease severity
King_16 <-
   read.xlsx(
      "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past Trials/2016/Yeild Data 2016 Kingaroy Hermitage (PaulM adjusted).xlsx",
      sheet = "Kingaroy",
      startRow = 1,
      colNames = TRUE
   )[1:28, 1:9]


King_16$Year <- 2016
King_16$location <- "Kingaroy"


King_16$Plot <- as.numeric(unlist(strsplit(
   King_16$Plot, "P"))[
      seq(from = 2, to = 56, by = 2)])


```

#### Define treatment data
```{r King16_treatmentDefine}
King_16_dat <- King_16 %>%
   mutate(trade_name = 
             case_when(Treatment == "1" ~ "control",
                       TRUE ~ "Folicur"))%>%
   mutate(fungicide_ai = 
             case_when(Treatment == "1" ~ "control",
                       TRUE ~ "tebuconazole"))%>%
   mutate(dose_ai.ha = 
             case_when(Treatment == "1" ~ 0,
                       TRUE ~ 62.35))%>%
   mutate(fungicide_application_1 = 
             case_when(Treatment == "1" ~ as.Date(NA),
                       Treatment == "2" ~ as.Date("2016-03-22", format = "%Y-%m-%d"),
                       Treatment == "3" ~ as.Date("2016-03-22", format = "%Y-%m-%d"),
                       Treatment == "4" ~ as.Date("2016-03-22", format = "%Y-%m-%d"),
                       Treatment == "5" ~ as.Date("2016-03-09", format = "%Y-%m-%d"),
                       Treatment == "6" ~ as.Date("2016-03-09", format = "%Y-%m-%d"),
                       Treatment == "7" ~ as.Date("2016-03-22", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_2 = 
             case_when(Treatment == "1" ~ as.Date(NA),
                       Treatment == "3" ~ as.Date("2016-04-05", format = "%Y-%m-%d"),
                       Treatment == "4" ~ as.Date("2016-04-05", format = "%Y-%m-%d"),
                       Treatment == "6" ~ as.Date("2016-03-22", format = "%Y-%m-%d"),
                       Treatment == "7" ~ as.Date("2016-04-05", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_3 = 
             case_when(Treatment == "4" ~ as.Date("2016-04-19", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(spray_n = 
             case_when(Treatment == "1" ~ 0,
                       Treatment == "2" ~ 1,
                       Treatment == "3" ~ 2,
                       Treatment == "4" ~ 3,
                       Treatment == "5" ~ 1,
                       Treatment == "6" ~ 2,
                       Treatment == "7" ~ 2,
                       TRUE ~ 9999))

```

#### Input trial data
```{r King16_Trialdat}

King_16_dat <- 
   data.frame(trial_ref = "mung1516/02",
              year = "2016",
              location = "Kingaroy",
              host_genotype = "Jade",
              trial_design = "RCB",
              plot_length = 12,
              plot_width = 4,
              plant_density = NA,
              row_spacing = 0.75,
              replicate = King_16_dat$rep,
              planting_date = as.Date("2016-02-11", format = "%Y-%m-%d"),
              emergence_date = as.Date("2016-02-19", format = "%Y-%m-%d"),
              flowering_date = as.Date(NA),
              pod_fill_date = as.Date("2016-04-05", format = "%Y-%m-%d"),
              mid_late_pod_fill = as.Date(NA),
              first_sign_disease = as.Date("2016-03-09", format = "%Y-%m-%d"),
              trade_name = as.factor(King_16_dat$trade_name),
              fungicide_ai = King_16_dat$fungicide_ai,
              dose_ai.ha = King_16_dat$dose_ai.ha,
              n_treatment = as.numeric(King_16_dat$Treatment),
              fungicide_application_1 = King_16_dat$fungicide_application_1,
              fungicide_application_2 = King_16_dat$fungicide_application_2,
              fungicide_application_3 = King_16_dat$fungicide_application_3,
              total_fungicide = King_16_dat$spray_n,
              harvest_date = as.Date("2016-05-10", format = "%Y-%m-%d"),
              final_assessment = as.Date("2016-04-19", format = "%Y-%m-%d"),
              PM_final_severity = NA,
              rating_scale = "1-9",
              grain_yield.t.ha. = as.numeric(King_16_dat$`Raw.Adjusted.Yeild./.ha`),
              stringsAsFactors = FALSE)
```


#### Calculating treatment means
```{r King16_means}
King_16_m <- King_16_dat %>%
   group_by(host_genotype, n_treatment) %>%
   summarise(trial_ref = unique(trial_ref),
             year = unique(year),
             location = unique(location),
             trial_design = unique(trial_design),
             trade_name = unique(trade_name),
             fungicide_ai = unique(fungicide_ai),
             dose_ai.ha = unique(dose_ai.ha),
             trial_ref = unique(trial_ref),
             plot_length.m. = mean(plot_length, na.rm = TRUE),
             plot_width.m. = mean(plot_width, na.rm = TRUE),
             plant_density = unique(plant_density),
             row_spacing = unique(row_spacing),
             replicates = length(as.numeric(replicate)),
             planting_date = unique(planting_date),
             emergence_date = unique(emergence_date),
             flowering_date = unique(flowering_date),
             pod_fill_date = unique(pod_fill_date),
             mid_late_pod_fill = unique(mid_late_pod_fill),
             first_sign_disease = unique(first_sign_disease),
             fungicide_application_1 = unique(fungicide_application_1),
             fungicide_application_2 = unique(fungicide_application_2),
             fungicide_application_3 = unique(fungicide_application_3),
             total_fungicide = unique(total_fungicide),
             harvest_date = unique(harvest_date),
             final_assessment = unique(final_assessment),
             #PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
             rating_scale = unique(rating_scale),
             #disease_error = sd(PM_final_severity, na.rm = TRUE), # why is this not working
             #D_error_type = "stdev",
             grain_yield.t.ha. = mean(grain_yield.t.ha., na.rm = TRUE),
             raw_graded = "Yes",
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE),
             Y_error_type = "stdev",
             #AUDPC.m = mean(AUDPC),
             #AUDPC.sd = sd(AUDPC),
             Y_Msquare = anova(lm(grain_yield.t.ha. ~ factor(n_treatment), data = King_16_dat))[1,3]
   )

# For some wierd reason standard deviations are comming back NA in the code above
King_16_m[,"yield_error"] <- 
   King_16_dat %>%
   group_by(n_treatment) %>%
   summarise(yield_error = sd(grain_yield.t.ha., na.rm = TRUE)) %>%
   select(c("yield_error"))



# Mean Disease incidence assessments through the 2016 season
King_16.DR  <-
   read.xlsx(
      "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2016/2016 Mungbean PM trials summary.xlsx",
      sheet = "Kingaroy_2016",
      startRow = 5,
      colNames = TRUE
   )
names(King_16.DR)[1:6] <- c("Treatment", "dae20","dae34","dae46","PM_final_severity","Final_Yield_tHa")
King_16.DR$n_treatment <- c(3,2,7,6,5,4,1)




King_16_m <- left_join(King_16_m,King_16.DR)
King_16_m$AUDPC_m <- apply(King_16_m[,c("dae20", "dae34", "dae46", "PM_final_severity")]-1,1, 
                            FUN = audpc, dates = c(20,34,46,60))
King_16_m$AUDPC_se <- NA


King_16_m <- fold_data(King_16_m, PM_MB_means)
King_16_m <- King_16_m[,!colnames(King_16_m) %in% c('Treatment',"dae20","dae34","dae46","Final_Yield_tHa", "AUDPC.m")]


write.csv(
   King_16_m,
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2016/Kingaroy/King_16_means.csv",
   row.names = FALSE
)

```

### Missen Flats 2017
```{r Missen2017}
# ____________________________________________________________
# _____________   Missen Flats (Fogarty's) 2017     ____________
Fogerty_17 <-
   read.xlsx(
      "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2017/MissenFlats/Fogerty Work File 2017 (Autosaved).xlsx",
      sheet = "Data",
      startRow = 3,
      colNames = TRUE,
      detectDates = TRUE
   )[, 1:43]

#dim(Fogerty_17)   # 162 rows , 43 Columns


# Columns to keep
Fogerty_17 <- Fogerty_17[, c('Plot', 'Rep', 'Row', 'Column', 'Chem.Trt',
                           'Chemical', 'Row.Spacing.(m)', 'Treatment.No',
                           'Treatment', 'Population.plsnts/ha',
                           '2017-03-07', '2017-03-19', '2017-03-24',
                           '2017-04-02', '2017-04-10', '2017-04-18',
                           'Yield.t/ha', 'Grain.Moisture.%', 'Temp.moisture.Taken',
                           '100.grain.wt.Grams')]


Fogerty_17$Treatment.No <- as.numeric(unlist(strsplit(
   Fogerty_17$Treatment.No, "T"))[
      seq(from = 2, to = 324, by = 2)])




# Fog_17_sum <- Fogerty_17 %>%
#    group_by(Treatment, Chemical, `Row.Spacing.(m)`) %>%
#    summarise(
#       m_disease = mean(`2017-04-18`, na.rm = TRUE),
#       sd_disease = sd(`2017-04-18`, na.rm = TRUE),
#       m_Yield = mean(`Yield.t/ha`, na.rm = TRUE),
#       sd_Yield = sd(`Yield.t/ha`, na.rm = TRUE)
#    )
# 
# write.csv(
#    Fog_17_sum,
#    "C:/Users/U8011054/OneDrive - USQ/Cloudstor/Mungbean/Fogerty_17_mean.csv"
# )
# 
# 
# # gather the incidence assessment into long format
# Fogerty_17.1 <-
#    gather(Fogerty_17,
#           key = Incidence_assessment_date,
#           value = Incidence,
#           colnames(Fogerty_17)[c(11:16)])
# #Fogerty_17.1$Severity <- gather(Fogerty_17, key = assessment_date, value = Severity,
# #                                colnames(Fogerty_17)[c(15,18)])
# Fogerty_17.1$location <- "Fogerty"
# 
# 

```

#### Define treatment data
```{r Fog17_treatmentDefine}
Fogerty_17_dat <- Fogerty_17 %>%
   mutate(trade_name = 
             case_when(Chem.Trt == 1 ~ "Folicur",
                       Chem.Trt == 2 ~ "Throttle",
                       Chem.Trt == 3 ~ "Custodia",
                       TRUE ~ "other"))%>%
   mutate(fungicide_ai = 
             as.character(case_when(Chem.Trt == 1 ~ "tebuconazole",
                                    Chem.Trt == 2 ~ "propiconazole",
                                    Chem.Trt == 3 ~ "200 g/L tebuconazole + 120 g/L azoxystrobin",
                                    TRUE ~ "other")))%>%
   mutate(dose_ai.ha = 
             case_when(Chem.Trt == 1 ~ 62,
                       Chem.Trt == 2 ~ 125,
                       Chem.Trt == 3 ~ 60,
                       TRUE ~ 9999))%>%
   mutate(fungicide_application_1 = 
             case_when(Treatment.No == 1 ~ as.Date(NA),
                       Treatment.No == 2 ~ as.Date("2017-02-22", format = "%Y-%m-%d"),
                       Treatment.No == 3 ~ as.Date("2017-03-08", format = "%Y-%m-%d"),
                       Treatment.No == 4 ~ as.Date("2017-03-08", format = "%Y-%m-%d"),
                       Treatment.No == 5 ~ as.Date("2017-03-19", format = "%Y-%m-%d"),
                       Treatment.No == 6 ~ as.Date("2017-03-08", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_2 = 
             case_when(Treatment.No == 4 ~ as.Date("2017-03-24", format = "%Y-%m-%d"),
                       Treatment.No == 6 ~ as.Date("2017-04-02", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(spray_n = 
             case_when(Treatment.No == 1 ~ 0,
                       Treatment.No == 4 ~ 2,
                       Treatment.No == 6 ~ 2,
                       TRUE ~ 1))

```

#### Input trial data
```{r King16_Trialdat}
# Remove zeros
Fogerty_17_dat[Fogerty_17_dat$`2017-03-07` == 0 ,c("2017-03-07")] <- 1


Fogerty_17_dat <- 
   data.frame(trial_ref = "mung1617/02",
              year = "2017",
              location = "Missen Flats",
              host_genotype = "Jade",
              trial_design = "RCB",
              plot_length = 10,
              plot_width = 2,
              plant_density = Fogerty_17_dat$`Population.plsnts/ha`,
              row_spacing = Fogerty_17_dat$`Row.Spacing.(m)`,
              replicate = Fogerty_17_dat$Rep,
              planting_date = as.Date("2017-01-27", format = "%Y-%m-%d"),
              emergence_date = as.Date("2017-02-01", format = "%Y-%m-%d"),
              flowering_date = as.Date(NA),
              pod_fill_date = as.Date(NA),
              mid_late_pod_fill = as.Date(NA),
              first_sign_disease = as.Date("2017-03-07", format = "%Y-%m-%d"),
              trade_name = as.factor(Fogerty_17_dat$trade_name),
              fungicide_ai = as.character(Fogerty_17_dat$fungicide_ai),
              dose_ai.ha = Fogerty_17_dat$dose_ai.ha,
              n_treatment = as.numeric(Fogerty_17_dat$Treatment.No),
              fungicide_application_1 = Fogerty_17_dat$fungicide_application_1,
              fungicide_application_2 = Fogerty_17_dat$fungicide_application_2,
              total_fungicide = Fogerty_17_dat$spray_n,
              harvest_date = as.Date("2017-05-11", format = "%Y-%m-%d"),
              final_assessment = as.Date("2017-04-18", format = "%Y-%m-%d"),
              PM_final_severity = Fogerty_17_dat$`2017-04-18`,
              rating_scale = "1-9",
              grain_yield.t.ha. = as.numeric(Fogerty_17_dat$`Yield.t/ha`),
              AUDPC = apply(Fogerty_17_dat[,c("2017-03-07", "2017-03-19", "2017-03-24", "2017-04-02","2017-04-10","2017-04-18")]-1,1, 
                            FUN = audpc, dates = c(1,12,17,26,34,42)) # -1 to the data because zero disease = 1 on rating scale// Dates are based off days from first sign
              , stringsAsFactors = FALSE)
```

#### Calculating treatment means
```{r Missen17_means}

Fogerty_17_m <- Fogerty_17_dat %>%
   group_by(n_treatment, row_spacing, fungicide_ai) %>%
   summarise(trial_ref = unique(trial_ref),
             year = unique(year),
             location = unique(location),
             host_genotype = unique(host_genotype),
             trial_design = unique(trial_design),
             trade_name = unique(trade_name),
             dose_ai.ha = unique(dose_ai.ha),
             trial_ref = unique(trial_ref),
             plot_length.m. = mean(plot_length, na.rm = TRUE),
             plot_width.m. = mean(plot_width, na.rm = TRUE),
             plant_density = mean(plant_density, na.rm = TRUE),
             replicates = length(as.numeric(replicate)),
             planting_date = unique(planting_date),
             emergence_date = unique(emergence_date),
             flowering_date = unique(flowering_date),
             pod_fill_date = unique(pod_fill_date),
             mid_late_pod_fill = unique(mid_late_pod_fill),
             first_sign_disease = unique(first_sign_disease),
             fungicide_application_1 = unique(fungicide_application_1),
             fungicide_application_2 = unique(fungicide_application_2),
             total_fungicide = unique(total_fungicide),
             harvest_date = unique(harvest_date),
             final_assessment = unique(final_assessment),
             PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
             rating_scale = unique(rating_scale),
             disease_error = sd(PM_final_severity, na.rm = TRUE), # why is this not working
             D_error_type = "stdev",
             grain_yield.t.ha. = mean(grain_yield.t.ha., na.rm = TRUE),
             raw_graded = NA,
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE),
             Y_error_type = "stdev",
             AUDPC.m = mean(AUDPC),
             AUDPC.sd = sd(AUDPC),
             Y_Msquare = anova(lm(grain_yield.t.ha. ~ factor(n_treatment) + fungicide_ai + row_spacing, data = subset(Fogerty_17_dat, trade_name != "Custodia")))[1,3] # of only triazoles
   )

# For some weird reason standard deviations are comming back NA in the code above
Fogerty_17_m[,c("n_treatment","row_spacing", "disease_error","yield_error")] <-
   Fogerty_17_dat %>%
   group_by(n_treatment, row_spacing, fungicide_ai) %>%
   summarise(disease_error = sd(PM_final_severity, na.rm = TRUE),
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE)) %>%
   select(c("n_treatment","row_spacing","disease_error","yield_error"))

Fogerty_17_m[Fogerty_17_m$n_treatment == 1, "fungicide_ai"] <- "control"
Fogerty_17_m[Fogerty_17_m$n_treatment == 1,"dose_ai.ha"] <- NA_real_
Fogerty_17_m[Fogerty_17_m$n_treatment == 1, "trade_name"] <- NA


Fogerty_17_m <- fold_data(Fogerty_17_m, PM_MB_means)

write.csv(
   Fogerty_17_m,
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2017/MissenFlats/Fogerty_17_mean.csv",
   row.names = FALSE
)

```


### Hermitage 2017
```{r Herm_17}

# _____________   Hermitage  2017     ____________
Herm_17 <-
   read.xlsx(
      "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past Trials/2017/Hermitage/Hermitage working file 2017 .xlsx",
      sheet = "Hermitage Trial",
      rows = 3:165,
      cols = 1:38,
      colNames = TRUE,
      detectDates = TRUE
   )

# Adjust the Yield to 12% moisture
Herm_17$`Yield.T/Ha` <-
   (Herm_17$`Yield.T/Ha` / Herm_17$`Moisture%`) * 12

```

#### Define treatment data
```{r Herm_17_treatmentDefine}
Herm_17_dat <- Herm_17 %>%
   mutate(trade_name = 
             case_when(Chemical.Trt == 1 ~ "Folicur",
                       Chemical.Trt == 2 ~ "Throttle",
                       Chemical.Trt == 3 ~ "Custodia",
                       TRUE ~ "other"))%>%
   mutate(fungicide_ai = 
             case_when(Chemical.Trt == 1 ~ "tebuconazole",
                       Chemical.Trt == 2 ~ "propiconazole",
                       Chemical.Trt == 3 ~ "200 g/L tebuconazole + 120 g/L azoxystrobin",
                       TRUE ~ "other"))%>%
   mutate(dose_ai.ha = 
             case_when(Chemical.Trt == 1 ~ 62,
                       Chemical.Trt == 2 ~ 125,
                       Chemical.Trt == 3 ~ 60,
                       TRUE ~ 9999))%>%
   mutate(fungicide_application_1 = 
             case_when(Manage.Trt == "1" ~ as.Date(NA),
                       Manage.Trt == "T2" ~ as.Date("2017-03-13", format = "%Y-%m-%d"),
                       Manage.Trt == "T3" ~ as.Date("2017-03-24", format = "%Y-%m-%d"),
                       Manage.Trt == "T4" ~ as.Date("2017-03-27", format = "%Y-%m-%d"),
                       Manage.Trt == "T5" ~ as.Date("2017-03-27", format = "%Y-%m-%d"),
                       Manage.Trt == "T6" ~ as.Date("2017-04-05", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_2 = 
             case_when(Manage.Trt == "T3" ~ as.Date("2017-04-07", format = "%Y-%m-%d"),
                       Manage.Trt == "T5" ~ as.Date("2017-04-11", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(spray_n = 
             case_when(Manage.Trt == "1" ~ 0,
                       Manage.Trt == "T3" ~ 2,
                       Manage.Trt == "T5" ~ 2,
                       TRUE ~ 1))

```

#### Input trial data
```{r Herm17_Trialdat}
# Remove zeros
#Herm_17_dat[Herm_17_dat$`2017-03-07` == 0 ,c("2017-03-07")] <- 1

Herm_17_dat <- 
   data.frame(trial_ref = "mung1617/01",
              year = "2017",
              location = "Hermitage",
              host_genotype = "Jade",
              trial_design = "RCB",
              plot_length = Herm_17_dat$Plot.Length,
              plot_width = 2,
              plant_density = NA,
              row_spacing = Herm_17_dat$`Row.Spacing.(m)`,
              replicate = Herm_17_dat$Rep,
              planting_date = as.Date("2017-02-13", format = "%Y-%m-%d"),
              emergence_date = as.Date("2017-02-20", format = "%Y-%m-%d"),
              flowering_date = as.Date(NA),
              pod_fill_date = as.Date(NA),
              mid_late_pod_fill = as.Date(NA),
              first_sign_disease = as.Date("2017-03-24", format = "%Y-%m-%d"),
              trade_name = as.factor(Herm_17_dat$trade_name),
              fungicide_ai = Herm_17_dat$fungicide_ai,
              dose_ai.ha = Herm_17_dat$dose_ai.ha,
              n_treatment = as.numeric(unlist(strsplit(Herm_17_dat$Manage.Trt, "T"))[unlist(strsplit(Herm_17_dat$Manage.Trt, "T")) != ""]),
              fungicide_application_1 = Herm_17_dat$fungicide_application_1,
              fungicide_application_2 = Herm_17_dat$fungicide_application_2,
              total_fungicide = Herm_17_dat$spray_n,
              harvest_date = as.Date("2017-06-26", format = "%Y-%m-%d"),
              final_assessment = as.Date("2017-05-11", format = "%Y-%m-%d"),
              PM_final_severity = Herm_17_dat$`I_11/05/2017`,
              rating_scale = "1-9",
              grain_yield.t.ha. = as.numeric(Herm_17_dat$`Yield.T/Ha`)
               # -1 to the data because zero disease = 1 on rating scale// Dates are based off days from first sign
              )


Herm_17_dat <- cbind(Herm_17_dat,
                          AUDPC = apply(data.frame(zero = 1,
                                                   Herm_17[,c("2017-03-24","I_2/04/2017", "I_11/04/2017", "I_18/04/2017", "I_24/04/2017","I_3/05/2017","I_11/05/2017")]-1),
                                        1, 
                                        FUN = audpc, 
                                        dates = c((Herm_17_dat$first_sign_disease[1]-7)-
                                                     Herm_17_dat$planting_date[1],
                                                  39,48,57,64,70,79,87)
                                        )
                          )
Herm_17_m
```


#### Calculating treatment means
```{r Herm17_means}

Herm_17_m <- Herm_17_dat %>%
   group_by(n_treatment, fungicide_ai,row_spacing) %>%
   summarise(trial_ref = unique(trial_ref),
             year = unique(year),
             location = unique(location),
             host_genotype = unique(host_genotype),
             trial_design = unique(trial_design),
             trade_name = unique(trade_name),
             dose_ai.ha = unique(dose_ai.ha),
             trial_ref = unique(trial_ref),
             plot_length.m. = mean(plot_length, na.rm = TRUE),
             plot_width.m. = mean(plot_width, na.rm = TRUE),
             plant_density = mean(plant_density, na.rm = TRUE),
             replicates = length(as.numeric(replicate)),
             planting_date = unique(planting_date),
             emergence_date = unique(emergence_date),
             flowering_date = unique(flowering_date),
             pod_fill_date = unique(pod_fill_date),
             mid_late_pod_fill = unique(mid_late_pod_fill),
             first_sign_disease = unique(first_sign_disease),
             fungicide_application_1 = unique(fungicide_application_1),
             fungicide_application_2 = unique(fungicide_application_2),
             total_fungicide = unique(total_fungicide),
             harvest_date = unique(harvest_date),
             final_assessment = unique(final_assessment),
             PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
             rating_scale = unique(rating_scale),
             disease_error = sd(PM_final_severity, na.rm = TRUE), # why is this not working
             D_error_type = "stdev",
             grain_yield.t.ha. = mean(grain_yield.t.ha., na.rm = TRUE),
             raw_graded = NA,
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE),
             Y_error_type = "stdev",
             AUDPC.m = mean(AUDPC),
             AUDPC.sd = sd(AUDPC),
             Y_Msquare = anova(lm(grain_yield.t.ha. ~ 
                                  factor(n_treatment) + fungicide_ai + row_spacing, 
                               data = subset(Herm_17_dat, trade_name != "Custodia")))[1,3] # of only triazoles
   )


# For some weird reason standard deviations are comming back NA in the code above
Herm_17_m[,c("n_treatment","fungicide_ai","row_spacing", "disease_error","yield_error")] <-
   Herm_17_dat %>%
   group_by(n_treatment, fungicide_ai,row_spacing) %>%
   summarise(disease_error = sd(PM_final_severity, na.rm = TRUE),
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE)) %>%
   select(c("n_treatment","fungicide_ai","row_spacing","disease_error","yield_error"))


Herm_17_m[Herm_17_m$n_treatment == 1, "fungicide_ai"] <- as.factor("control")
Herm_17_m[Herm_17_m$n_treatment == 1,"dose_ai.ha"] <- NA_real_
Herm_17_m[Herm_17_m$n_treatment == 1, "trade_name"] <- NA

Herm_17_m <- fold_data(Herm_17_m, PM_MB_means)

write.csv(
   Herm_17_m,
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2017/Hermitage/Hermitage_17_mean.csv",
   row.names = FALSE
)

```





### Wellcamp 2018
```{r Wellcamp2018}
Well_18 <-
   read.xlsx(
      "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past Trials/2018/Wellcamp/Wellcamp Fungicide x Row Spacing x Plant Population - Experimental Design Fogarty 2018.xlsx",
      sheet = "Data",
      startRow = 1,
      colNames = TRUE
   )

colnames(Well_18)[13:14] <- c("Row.Spacing_ID", "Fungicide_ID")

```



#### Define treatment data
```{r Well_18_treatmentDefine}
Well_18_dat <- Well_18 %>%
   mutate(trade_name = 
             case_when(Fung.Trt == 1 ~ "Folicur",
                       Fung.Trt == 3 ~ "Throttle",
                       Fung.Trt == 2 ~ "Custodia",
                       Fung.Trt == 4 ~ "control",
                       TRUE ~ "other"))%>%
   mutate(fungicide_ai = 
             case_when(Fung.Trt == 1 ~ "tebuconazole",
                       Fung.Trt == 3 ~ "propiconazole",
                       Fung.Trt == 2 ~ "200 g/L tebuconazole + 120 g/L azoxystrobin",
                       Fung.Trt == 4 ~ "control",
                       TRUE ~ "other"))%>%
   mutate(dose_ai.ha = 
             case_when(Fung.Trt == 1 ~ 60,
                       Fung.Trt == 2 ~ 62,
                       Fung.Trt == 3 ~ 125,
                       Fung.Trt == 4 ~ NA_real_,
                       TRUE ~ 9999))%>%
   mutate(Row.Spacing = 
             case_when(Row.Sp.Trt == 1 ~ 0.25,
                       Row.Sp.Trt == 2 ~ 0.5,
                       Row.Sp.Trt == 3 ~ 1,
                       TRUE ~ 9999))%>%
   mutate(fungicide_application_2 = 
             case_when(Fung.Trt <= 3 ~ as.Date("2018-04-16", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_1 = 
             case_when(Fung.Trt == 4 ~ as.Date(NA),
                       Fung.Trt == 1 ~ as.Date("2018-03-28", format = "%Y-%m-%d"),
                       Fung.Trt == 2 ~ as.Date("2018-03-28", format = "%Y-%m-%d"),
                       Fung.Trt == 3 ~ as.Date("2018-03-28", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(spray_n = 
             case_when(Fung.Trt <= 3 ~ 2,
                       TRUE ~ NA_real_))

```

#### Input trial data
```{r Well18_Trialdat}

Well_18_dat <- 
   data.frame(trial_ref = "mung1718/01",
              year = "2018",
              location = "Wellcamp",
              host_genotype = "Jade",
              trial_design = "RCB",
              plot_length = Well_18_dat$Row.Length,
              plot_width = 2,
              plant_density = Well_18_dat$Plant.Pop,
              row_spacing = Well_18_dat$Row.Spacing,
              replicate = Well_18_dat$Rep,
              planting_date = as.Date("2018-02-13", format = "%Y-%m-%d"),
              emergence_date = as.Date(NA),
              flowering_date = as.Date(NA),
              pod_fill_date = as.Date(NA),
              mid_late_pod_fill = as.Date(NA),
              first_sign_disease = as.Date("2018-03-21", format = "%Y-%m-%d"),
              trade_name = as.factor(Well_18_dat$trade_name),
              fungicide_ai = Well_18_dat$fungicide_ai,
              dose_ai.ha = Well_18_dat$dose_ai.ha,
              n_treatment = Well_18_dat$Treatment,
              fungicide_application_1 = Well_18_dat$fungicide_application_1,
              fungicide_application_2 = Well_18_dat$fungicide_application_2,
              total_fungicide = Well_18_dat$spray_n,
              harvest_date = as.Date("2018-05-31", format = "%Y-%m-%d"),
              final_assessment = as.Date("2018-05-02", format = "%Y-%m-%d"),
              PM_final_severity = Well_18_dat$`IR.2-5-18`,
              rating_scale = "1-9",
              grain_yield.t.ha. = as.numeric(Well_18_dat$`Yield./.ha`)
               # -1 to the data because zero disease = 1 on rating scale// Dates are based off days from first sign
              )


Well_18_dat <- cbind(Well_18_dat,
                          AUDPC = apply(data.frame(zero = 1,
                                                   Well_18[,c("IR.23-3-18","IR.5-4-18", "IR.11-4-18", "IR.18-4-18","IR.26-4-18","IR.2-5-18")]-1),
                                        1, 
                                        FUN = audpc, 
                                        dates = c((Well_18_dat$first_sign_disease[1]-7)-
                                                     Well_18_dat$planting_date[1],
                                                  38,51 ,57,64,72,78)
                                        )
                          )

```


#### Calculating treatment means
```{r Well17_means}

Well_18_m <- Well_18_dat %>%
   group_by(host_genotype, n_treatment, row_spacing, fungicide_ai) %>%
   summarise(trial_ref = unique(trial_ref),
             year = unique(year),
             location = unique(location),
             trial_design = unique(trial_design),
             trade_name = unique(trade_name),
             dose_ai.ha = unique(dose_ai.ha),
             trial_ref = unique(trial_ref),
             plot_length.m. = mean(plot_length, na.rm = TRUE),
             plot_width.m. = mean(plot_width, na.rm = TRUE),
             plant_density = mean(plant_density, na.rm = TRUE),
             replicates = length(as.numeric(replicate)),
             planting_date = unique(planting_date),
             emergence_date = unique(emergence_date),
             flowering_date = unique(flowering_date),
             pod_fill_date = unique(pod_fill_date),
             mid_late_pod_fill = unique(mid_late_pod_fill),
             first_sign_disease = unique(first_sign_disease),
             fungicide_application_1 = unique(fungicide_application_1),
             fungicide_application_2 = unique(fungicide_application_2),
             total_fungicide = unique(total_fungicide),
             harvest_date = unique(harvest_date),
             final_assessment = unique(final_assessment),
             PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
             rating_scale = unique(rating_scale),
             disease_error = sd(PM_final_severity, na.rm = TRUE), # why is this not working
             D_error_type = "stdev",
             grain_yield.t.ha. = mean(grain_yield.t.ha., na.rm = TRUE),
             raw_graded = NA,
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE),
             Y_error_type = "stdev",
             AUDPC.m = mean(AUDPC),
             AUDPC.sd = sd(AUDPC),
             Y_Msquare = anova(lm(grain_yield.t.ha. ~ 
                                  factor(n_treatment) + fungicide_ai + row_spacing, 
                               data = subset(Well_18_dat, trade_name != "Custodia")))[1,3] # of only triazoles
   )


# For some weird reason standard deviations are comming back NA in the code above
Well_18_m[,c("n_treatment","row_spacing", "disease_error","yield_error")] <- 
   Well_18_dat %>%
   group_by(n_treatment, row_spacing, fungicide_ai) %>%
   summarise(disease_error = sd(PM_final_severity, na.rm = TRUE),
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE)) %>%
   select(c("disease_error","yield_error"))


Well_18_m <- fold_data(Well_18_m, PM_MB_means)

write.csv(
   Well_18_m,
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2018/Wellcamp/Wellcamp_18_mean.csv",
   row.names = FALSE
)

```


### Hermitage 2019
```{r Herm19}
PM_MB_19 <-
   read.xlsx(
      "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/1901_Herm_PM/1901 Mungbean powdery mildew disease and yeild data.xlsx",
      startRow = 2,
      cols = c(1:21)
   )
?audpc
# Remove these plots as the results can't be trusted
PM_MB_19 <- subset(PM_MB_19, Harvest.Plot.Number != 5)
PM_MB_19 <- subset(PM_MB_19, Harvest.Plot.Number != 6)

# Calculate area under the disease progress curve
PM_MB_19$AUDPC <- apply(data.frame(zero = 1,PM_MB_19[,c("15-4-19.Incedence", "23-4-19.Incedence", "1-5-19.Incedence")]-1),1,FUN = audpc, dates = c(60, 70,78,86))


# Calculate area under the disease progress curve for plots which were not assessed at on 2019-05-01
PM_MB_19[is.na(PM_MB_19$`1-5-19.Incedence`),"AUDPC"] <- 
   apply(data.frame(zero = 1,PM_MB_19[is.na(PM_MB_19$`1-5-19.Incedence`) ,c("15-4-19.Incedence", "23-4-19.Incedence")]-1),1,FUN = audpc, dates = c(60, 70,78))
```

#### Define treatment data
```{r Well_18_treatmentDefine}
Herm_19_dat <- PM_MB_19 %>%
   mutate(fungicide_application_1 = 
             case_when(`T/ment.NUM` == 1 ~ as.Date("2018-04-15", format = "%Y-%m-%d"),
                       `T/ment.NUM` == 2 ~ as.Date("2018-04-15", format = "%Y-%m-%d"),
                       `T/ment.NUM` == 3 ~ as.Date("2018-04-23", format = "%Y-%m-%d"),
                       `T/ment.NUM` == 4 ~ as.Date(NA),
                       TRUE ~ as.Date(NA)))%>%
   mutate(fungicide_application_2 = 
             case_when(`T/ment.NUM` == 2 ~ as.Date("2018-04-29", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(spray_n = 
             case_when(`T/ment.NUM` == 2 ~ 2,
                       `T/ment.NUM` == 1 ~ 1,
                       `T/ment.NUM` == 3 ~ 1,
                       TRUE ~ 0))%>%
   mutate(trial_ref = 
             case_when(TOS.NUM == 1 ~ "mung1819/01",
                       TOS.NUM == 2 ~ "mung1819/02",
                       TRUE ~ NA_character_))%>%
   mutate(planting_date = 
             case_when(TOS.NUM == 1 ~ as.Date("2018-02-04", format = "%Y-%m-%d"),
                       TOS.NUM == 2 ~ as.Date("2018-02-18", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(emergence_date = 
             case_when(TOS.NUM == 1 ~ as.Date("2018-02-11", format = "%Y-%m-%d"),
                       TOS.NUM == 2 ~ as.Date("2018-02-25", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(final_assessment = 
             case_when(TOS.NUM == 1 ~ as.Date("2018-04-24", format = "%Y-%m-%d"),
                       TOS.NUM == 2 ~ as.Date("2018-05-01", format = "%Y-%m-%d"),
                       TRUE ~ as.Date(NA)))%>%
   mutate(PM_final_severity = 
             case_when(is.na(`1-5-19.Incedence`) ~ `23-4-19.Incedence`,
                       TRUE ~ `1-5-19.Incedence`))%>%
   mutate(trade_name = 
             case_when(`T/ment.NUM` == 4 ~ NA_character_,
                       TRUE ~ "Folicur"))%>%
   mutate(fungicide_ai = 
             case_when(`T/ment.NUM` == 4 ~ NA_character_,
                       TRUE ~ "tebuconazole"))%>%
   
   mutate(dose_ai.ha = 
             case_when(`T/ment.NUM` == 4 ~ NA_real_,
                       TRUE ~ 62))%>%
   mutate(meanSq = 
             case_when(TOS.NUM == 1 ~ anova(lm(Yeild/1000 ~ 
                                  factor(`T/ment.NUM`) , 
                               data = PM_MB_19[PM_MB_19$TOS.NUM == 1,]))[1,3],
                       TOS.NUM == 2 ~ anova(lm(Yeild/1000 ~ 
                                  factor(`T/ment.NUM`) , 
                               data = PM_MB_19[PM_MB_19$TOS.NUM == 2,]))[1,3],
                       TRUE ~ NA_real_))

```

#### Input trial data
```{r Herm_19_Trialdat}

Herm_19_dat <- 
   data.frame(trial_ref = Herm_19_dat$trial_ref,
              year = "2019",
              location = "Hermitage",
              host_genotype = "Jade",
              trial_design = "RCB",
              plot_length = Herm_19_dat$Plot.Lengths,
              plot_width = 2,
              plant_density = NA_character_,
              row_spacing = 0.25,
              replicate = Herm_19_dat$Rep.Num,
              planting_date = Herm_19_dat$planting_date,
              emergence_date = Herm_19_dat$emergence_date,
              flowering_date = as.Date(NA),
              pod_fill_date = as.Date(NA),
              mid_late_pod_fill = as.Date(NA),
              first_sign_disease = as.Date("2018-04-12", format = "%Y-%m-%d"),
              trade_name = as.factor(Herm_19_dat$trade_name),
              fungicide_ai = Herm_19_dat$fungicide_ai,
              dose_ai.ha = Herm_19_dat$dose_ai.ha,
              n_treatment = Herm_19_dat$`T/ment.NUM`,
              fungicide_application_1 = Herm_19_dat$fungicide_application_1,
              fungicide_application_2 = Herm_19_dat$fungicide_application_2,
              total_fungicide = Herm_19_dat$spray_n,
              harvest_date = as.Date("2018-05-22", format = "%Y-%m-%d"),
              final_assessment = Herm_19_dat$final_assessment,
              PM_final_severity = Herm_19_dat$PM_final_severity,
              rating_scale = "1-9",
              grain_yield.t.ha. = as.numeric(Herm_19_dat$Yeild)/1000,
              meanSq = Herm_19_dat$meanSq,
              AUDPC = Herm_19_dat$AUDPC
              )

Herm_19_m
```


```{r Herm19_means}

Herm_19_m <- Herm_19_dat %>%
   group_by(trial_ref, n_treatment) %>%
   summarise(year = unique(year),
             location = unique(location),
             host_genotype = "Jade",
             trial_design = unique(trial_design),
             trade_name = unique(trade_name),
             dose_ai.ha = unique(dose_ai.ha),
             plot_length.m. = mean(plot_length, na.rm = TRUE),
             plot_width.m. = mean(plot_width, na.rm = TRUE),
             plant_density = "40k",
             row_spacing = unique(row_spacing),
             replicates = length(as.numeric(replicate)),
             planting_date = unique(planting_date),
             emergence_date = unique(emergence_date),
             flowering_date = unique(flowering_date),
             pod_fill_date = unique(pod_fill_date),
             mid_late_pod_fill = unique(mid_late_pod_fill),
             first_sign_disease = unique(first_sign_disease),
             fungicide_application_1 = unique(fungicide_application_1),
             fungicide_application_2 = unique(fungicide_application_2),
             total_fungicide = unique(total_fungicide),
             fungicide_ai = unique(fungicide_ai),
             harvest_date = unique(harvest_date),
             final_assessment = unique(final_assessment),
             PM_final_severity = mean(PM_final_severity, na.rm = TRUE),
             rating_scale = unique(rating_scale),
             disease_error = sd(PM_final_severity, na.rm = TRUE), # why is this not working
             D_error_type = "stdev",
             grain_yield.t.ha. = mean(grain_yield.t.ha., na.rm = TRUE),
             raw_graded = NA,
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE),
             Y_error_type = "stdev",
             AUDPC.m = mean(AUDPC),
             AUDPC.sd = sd(AUDPC),
             Y_Msquare = unique(meanSq)
   )


# For some weird reason standard deviations are comming back NA in the code above
Herm_19_m[,c("trial_ref","disease_error","yield_error")] <-
   Herm_19_dat %>%
   group_by(trial_ref, n_treatment) %>%
   summarise(disease_error = sd(PM_final_severity, na.rm = TRUE),
             yield_error = sd(grain_yield.t.ha., na.rm = TRUE)) %>%
   select(c("disease_error","yield_error"))


Herm_19_m <- fold_data(Herm_19_m, PM_MB_means)

write.csv(
   Herm_19_m,
   "C:/Users/U8011054/USQ/SCP - Documents/DAW1810/mungbean_powdery-mildew/Past trials/2019/Hermitage_19_mean.csv",
   row.names = FALSE
)

```