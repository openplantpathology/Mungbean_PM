# Preliminary Analysis

```{r PA_Libraries, include=FALSE}
library(tidyverse)
library(bomrang)
library(openxlsx)
library(kableExtra)
library(ggplot2)
library(devtools)
library(reshape2)
library(lme4)
library(theme.usq)
source("R/import_data.R")
#source("./getPPD2.R")
```

## Explore and visualise Data

```{r echo=FALSE, message=FALSE, warning=FALSE, include= FALSE}
# Import data
PM_MB_means <- import_data() # link expires 2021-12-01

#remove the variation in different sulphur formulations
unique(PM_MB_means[
   grep("sulphur",PM_MB_means$fungicide_ai),
   "fungicide_ai"])
PM_MB_means[grep("sulphur",PM_MB_means$fungicide_ai),"fungicide_ai"] <- "sulphur"

```

Various factors have been studied in the previous experiments which may influence the following results. However unless stated the following plots and analyses were made disregarding effects from other factors not mentioned.

   1) Fungicide type  
   
   2) Fungicide dose (varies only slightly within some fungicide types)  
   
   3) Number of fungicide sprays  
   
   4) Timing of fungicide spray/s relative to first sign of disease (ie. when pathogen is present)  
   
   5) Host cultivars (probably is a covariate with season due to changing cultivars over time)  
   
   6) Experiment location  
   
   7) Row spacing  
   
   8) In-crop rainfall  
   
   9) Irrigated vs non-irrigated trials  
   
   10) Mean daily temperature in the weeks following spray application  
   
   11) Final disease rating  
   
   12) Two pathogen species cause PM (new discovery in 2018)  

The data plotted below are from `r length(unique(PM_MB_means$trial_ref))` field trials between (`r first(levels(PM_MB_means$year))` - `r last(levels(PM_MB_means$year))`) of which the details are described in [Studies considered in meta-analysis section](#studies-considered-in-meta-analysis).  
All data explored below are a list of mean values from each treatment applied in each experiment. Some experiments have in-season observations of disease incidence and severity, however here we have summarised the data to show only the end of season observations.    

### Fungicides
#### Fungicide type
Let's explore how many different types of fungicide were used and at what frequency.

```{r Fungicides}
PM_MB_means %>%
   group_by(fungicide_ai, trial_ref) %>%
   summarise() %>%
   count(sort = TRUE) %>%
   rename(Trials = n) %>%
   ggplot(aes(x = reorder(fungicide_ai, Trials), y = Trials)) +
   xlab("Fungicide active ingredient") +
   ylab("N Trials") +
   geom_col() +
   scale_fill_usq() +
   ggtitle(label = "Number of trials in which the\nspecified fungicide was used") +
   scale_colour_usq() +
   theme_usq() +
   coord_flip()
```


   - Tebuconazole and propiconazole could be pooled as a triazole or demethylation inhibitors (DMI) fungicide treatment.  

   - Amistar Xtra and Custodia are both contain strobilurin and triazole, however, they because they contain differing dose ratios (inverted) pooling may not be appropriate.  

   - Perhaps best way forward is to do an analysis of only the triazoles/DMIs. Then do another including azoxystrobin as a comparison.  

The primary focus of this research is the effect of fungicide on mitigating yield loss to disease. To reduce the affect of location and seasonal influences we will investigate the proportion of grain yield saved, relative to the no spray controls.  

First lets investigate the difference in the effect of the type of fungicide on proportion of yield saved. Proportion of yield saved is used in attempt to reduce variation between trials.    

```{r Fungicide_x_nSprays_tble, message=FALSE}
PM_MB_means %>%
   group_by(fungicide_ai, total_fungicide) %>%
   summarise(
      n = length(prop_YG),
      lower_2.5 = quantile(prop_YG, na.rm = T, c(0.025)),
      median = median(prop_YG, na.rm = T),
      mean = mean(prop_YG, na.rm = T),
      upper_97.5 = quantile(prop_YG, na.rm = T, c(0.975))
   ) %>%
   filter(n >= 5) %>% # remove any fungicide groups with less than 5 observations
   arrange(desc(median)) %>%
   kable(caption = "Fungicide effect on proportion of yield gain.") %>%
   kable_styling(fixed_thead = T, full_width = T) %>%
   footnote(general = "Fungicides with less than five observations were omitted from this table")

```

Lets visualise this in a plot for one and two sprays only.  

```{r Fungicide_x_nSprays_tble, message=FALSE}

PM_MB_means %>%
   mutate(fungicide_ai = as.factor(PM_MB_means$fungicide_ai)) %>%
   filter(total_fungicide == 1 | total_fungicide == 2) %>%
   filter(
      fungicide_ai != "pyrazophos" &
         fungicide_ai != "control" &
         fungicide_ai != "benomyl" &
         fungicide_ai != "Acibenzolar-S-methyl") %>%
   mutate(fungicide_ai = factor(fungicide_ai, 
                             levels = c("carbendazim", "pyraclostrobin",
                                        "sulphur", "200 g/L azoxystrobin + 80 g/L cyproconazole",
                                        "tebuconazole", "propiconazole", 
                                        "200 g/L tebuconazole + 120 g/L azoxystrobin"))) %>%
   ggplot(aes(y = prop_YG, x = fungicide_ai)) +
   facet_grid(rows = vars(total_fungicide)) +
   geom_boxplot(aes(fill = fungicide_ai, alpha = 0.5)) +
   geom_hline(aes(yintercept = 0), size = 0.5) +
   labs(y = "Proportion of grain yield saved",
        title = "Grain yield proportion saved\ngrouped by Fungicide type") +
   theme_usq() +
   theme(legend.position = "none") +
   coord_flip()

```

There is a small yield effect when applying fungicide and it is unclear how much a second spray improves yield saved. Interestingly Sulpur sprays might be worth investigating when sprayed twice.  


#### Fungicide Doses  
We should check that all fungicide doses that were used were roughly the same if we are to compare between trials were dose might be different.  

```{r tebuAndPropi_dose}
PM_MB_means %>%
   filter(fungicide_ai == "tebuconazole"|
             fungicide_ai == "propiconazole") %>%
   select(trial_ref,
          year,
          location,
          first_sign_disease,
          fungicide_ai,
          dose_ai.ha,
          total_fungicide) %>%
   ggplot(aes(x = as.factor(dose_ai.ha), fill = fungicide_ai)) +
   xlab("Dose (g ai/ha)") +
   ggtitle(label = "Total number of treatments for each respective tebuconazole dose") +
   geom_bar() +
   facet_grid(rows = vars(fungicide_ai))+
   scale_fill_usq() +
   scale_colour_usq() +
   theme_usq()
```

All trials that used tebuconazole used approximately the same dose. Dose of the active ingredient ranged from 62.35&nbsp;g per hectare to 60&nbsp;g per hectare.  

There is a large amount of variation in the propiconazole dose, lets inspect the difference in yields for each dose.

```{r PropiDoseEffect}
PM_MB_means %>%
   filter(fungicide_ai == "propiconazole") %>%
   ggplot(aes(x = relevel(as.factor(dose_ai.ha),"62.5"), y = prop_YG)) +
   xlab("Dose (g ai/ha)") +
   ggtitle(label = "Yield for each respective propiconazole dose") +
   geom_boxplot() +
   scale_fill_usq() +
   scale_colour_usq() +
   theme_usq()
```

This dose effect should be acknowledged in the meta-analysis. How many treatments of each dose have been investigated per trial?

```{r table_PropiDoses}
table(as.character(PM_MB_means[PM_MB_means$fungicide_ai == "propiconazole",]$trial_ref), 
      PM_MB_means[PM_MB_means$fungicide_ai == "propiconazole",]$dose_ai.ha)
```

Two trials show both doses were applied in the same trial, mung1112/01 and mung1112/02. Let look at the difference in proportion of yield saved in these trials.  

```{r PropiDoses_TrialCompar}

boxplot(prop_YG ~ dose_ai.ha, data = PM_MB_means[(PM_MB_means$trial_ref == "mung1112/01" |
                                                    PM_MB_means$trial_ref == "mung1112/02") &
                                                    PM_MB_means$fungicide_ai == "propiconazole",])
```

This plox plot, however, indicated the previous plot might be skewed by high yielding trials.  



#### Number of fungicide sprays  

Lets look at the frequency of sprays per fungicide.  
```{r Fungicide_x_nSprays}
table(PM_MB_means$fungicide_ai, PM_MB_means$total_fungicide)

```

#### Timing of fungicide sprays  
When are fungicides sprayed in relation to first sign.  

```{r spray_relative2FS}
PM_MB_means %>%
   mutate(s1_DfromFS = fungicide_application_1 - first_sign_disease,
          s2_DfromFS = fungicide_application_2 - first_sign_disease,
          s3_DfromFS = fungicide_application_3 - first_sign_disease,
          s4_DfromFS = fungicide_application_4 - first_sign_disease,
          s5_DfromFS = fungicide_application_5 - first_sign_disease) %>%
   gather(key = spray, value = n_days, s1_DfromFS, s2_DfromFS, s3_DfromFS, s4_DfromFS, s5_DfromFS)%>%
   ggplot(aes(x = spray, y = n_days))+
   geom_violin() +
   scale_x_discrete(labels = c("First\nSpray", "Second\nspray","Third\nspray","Fourth\nspray","Fifth\nspray"))+
   theme_usq()

```



### Mungbean cultivars  
In general, the mungbean varieties have the following resistance to powdery mildew.

   - Berken: Highly susceptible
   
   - Crystal: Susceptible
   
   - Jade: Moderately susceptible

Let's view a stacked bar plot of the number of sprays for both demethylation inhibitors, tebuconazole and propiconazole against each cultivar.

```{r Host_genotype}
PM_MB_means %>%
   filter(fungicide_ai == "tebuconazole"|
             fungicide_ai == "propiconazole")%>%
   group_by(host_genotype, fungicide_ai, trial_ref) %>%
   summarise() %>%
   count() %>%
   rename(Treatments = n) %>%
   ggplot(aes(x = host_genotype, y = Treatments, fill = fungicide_ai)) +
   xlab("Cultivar") +
   ylab("N Trials") +
   ggtitle(label = "Cultivars used in either tebuconazole or propiconazole trials") +
   geom_col() +
   scale_fill_usq() +
   scale_colour_usq() +
   theme_usq()
```


#### Genotype yield variability

Does host cultivar significantly impact the yield? Lets look at the volitility in yields to see if any cultivar yields better or has greater toleratance to powdery mildew. Below we plot distributions of mean trial yields for each cultivar.  

First lets look at overall yields for each cultivar , where trial is not a factor, for all treatments (spray and no spray).  
```{r yield_vol}
# this could be converted into a shiny app as a chunk. Make each input for the function a shiny option
# Outputs the table and graph
source("R/yield_volatility.r") #function to investigate the volatility in yields
# Volitility is the range between the upper and lower 97.5 and 2.5 % quartiles

YV1 <- yield_volatility(genotype_by_trial = FALSE, control_only = FALSE)
YV1[[2]]
YV1[[3]]
```
Now lets look at overall yields for each cultivar, where trial is not a factor, in only the no spray treatments.
```{r yieldVol_control}

YV2 <- yield_volatility(genotype_by_trial = FALSE, control_only = TRUE)
YV2[[2]]
YV2[[3]]

```
Volitility of the cultivars are fairly similar when trial is not considered as a factor (when we inspect plots of all treatments and only spray treatments). Green diamond shows little volatility however this cultivar is only featured in `r length(unique(PM_MB_means[PM_MB_means$host_genotype == "Green Diamond","trial_ref"]))` trials.  


Lets examine the same plots as above but only for the most commonly used trial site, Hermitage.  
```{r yieldVol_Herm}
YV1_herm <- yield_volatility(genotype_by_trial = FALSE, control_only = FALSE, location = "Hermitage")
YV1_herm[[2]]

```
Jade shows a large amount of volitility, excluding Green Diamond, Crystal shows the next least volatility.  

Lets take a closer look at Crystal with spray managment treatments and without.  
```{r YieldVol_Crystal}
YV1_crystal <- yield_volatility(genotype = "Crystal",control_only = FALSE)
YV1_crystal[[2]]
YV1_crystal <- yield_volatility(genotype = "Crystal",control_only = TRUE)
YV1_crystal[[2]]

```
There is a lot of variation between field trials for Crystal, but little variation within field trials.

Lets look at Jade, to see if it differs.
```{r YieldVol_Jade}
YV2_crystal <- yield_volatility("Jade",control_only = FALSE)
YV2_crystal[[2]]
```
For Jade there is high variation between trials and with in. Perhaps indicating lower tolerance. Lets look at the same plot with data only from no spray controls to see if the variation is the same.

```{r YieldVol_JadeControl}
YV3_crystal <- yield_volatility("Jade",control_only = TRUE)
YV3_crystal[[2]]
```
There seems to be a noticible shift in the probability curves between the two plots. Indicating that the tolerance in Jade may not as good as Crystal. A comparison between the fungicide efficacy for reducing powdery mildew severity and fungicide efficacy at mitigating yield loss.  

Overall there seems to be an influence of cultuvar however this variation is not as distinct as the variation between trials.  


### Row spacing  

Some experiments were designed to investigate the effect of row spacing and plant density on powdery mildew disease.
The results showed that the row spacing had no statistically significant effect on powdery mildew, but narrower rows in most cases increased yield significantly. This finding has also been shown by Kerry McKenzie's work as well.
Eight trials used a row spacing of 0.75&nbsp;meters and tebuconazole as an active ingredient (AI).

```{r row_spacing.m}
PM_MB_means %>%
   filter(fungicide_ai == "tebuconazole" | fungicide_ai == "propiconazole") %>%
   group_by(fungicide_ai, row_spacing, trial_ref) %>%
   summarise() %>%
   count() %>%
   rename(Trials = n) %>%
   ggplot(aes(x = as.factor(row_spacing), y = Trials)) +
   xlab("Row Spacing (m)") +
   ylab("N Trials") +
   ggtitle(label = "Trial row spacing using tebuconazole") +
   geom_col(aes(fill = fungicide_ai),
            position = "dodge") +
   scale_fill_usq(name = "Fungicide AI") +
   theme_usq()

PM_MB_means %>%
   filter(fungicide_ai == "tebuconazole",
         row_spacing == 0.75) %>% 
   glimpse()
```

Lets plot the row spacing treatments for the response variables yield and disease severity. The main questions are:  
   - Were there any statistical differences for mungbean yield or powdery mildew severity between row spacing treatments?  
   - Can we pool certain row spacing that have no significant difference?  

```{r RS_severity}
PM_MB_means$fungicide_ai
# Which row spacing leads to the higher disease severity
PM_MB_means %>%
   filter(year == 2017 |
             year == 2018) %>%
   filter(fungicide_ai == "control") %>%
   ggplot(aes(y = PM_final_severity, x = factor(row_spacing))) +
   geom_boxplot() +
   #  geom_smooth()+
 #  scale_y_continuous(limits = c(-5, 15)) +
   theme_usq()+
   ggtitle("Powdery mildew variation between different row spacing")

```

```{r RS_severity_x_trial}
PM_MB_means$fungicide_ai
# Which row spacing leads to the higher disease severity
PM_MB_means %>%
   filter(year == 2017 |
             year == 2018) %>%
   filter(fungicide_ai == "control") %>%
   ggplot(aes(y = PM_final_severity, x = factor(row_spacing))) +
   geom_boxplot() +
   #  geom_smooth()+
 #  scale_y_continuous(limits = c(-5, 15)) +
   theme_usq()+
   facet_grid(cols = vars(location))
   ggtitle("Powdery mildew variation between different row spacing")

```
In the Wellcamp site, wider row spacing reduces PM severity, the other sites it seems there was not enough variation to make a distinction between row spacing treatments.  


```{r RS_yield}
# Which row spacing leads to the higher yeild potential
PM_MB_means %>%
   filter(year == 2017|
             year == 2018) %>%
   #   filter(Fungicide == "control") %>%
   ggplot(aes(
      y = as.numeric(grain_yield.t.ha.),
      x = row_spacing,
      colour = location
   )) +
   geom_smooth(method = "gam") +
   geom_jitter(width = 0.01) +
   #   scale_y_continuous(limits = c(-5,15))+
   theme_usq()+
   ggtitle("Grain yield results for different row spacing at three locations")+
   xlab("Row spacing (m)")+
   ylab("Grain yield - tonne per hectare")



```
The plots seem to imply when yield is limited, presumably by other abiotic factors, there is no effect of row spacing on yield, like in the Hertmitage trial. However, if the average yield is more than approximately 1 t/ha then smaller row spacing has the potential to provide greater yield per hectare.  

Overall row spacing may influence both powdery mildew severity and yield.  

### Yield vs in-season rain  

In crop rain could be a significant factor which contributes to the end of season grain yield. To investigate this effect I will use a linear model (GY ~ SR) where seasonal rainfall represents a specific time frame with respect to planting time. Multiple time frames were tested from 20 days prior to planting, to 100 days after planting.  

The multiple time frames were tested by a loop over the dates at the start of the season (to 90 days after planting) to find which date fits the best linear model for grain weight and in-crop rainfall. The code for this process was moved to be contained within it's own script and can be run as a job as it can take a long time. To speed up the computation I split the script into four, ran the jobs and bound the data into one frame. The output of the script is saved with the prefix `lmInSeasonRainfall` followed by the time windows the model is run. For example `lmInSeasonRainfall_20.40_50.80.csv` holds the model results for start days between 20 and 40 days after planting to end window dates between 50 and 80 days after planting.

```{r rainfall_sum_Sstart}
# The four data files were created from four scripts run as four jobs in Rstudio
# when the four jobs are finished they can be imported and combined into one data.frame
# source(Rainfall_x_cropYield_s-10.09_e30.65.R)
# source(Rainfall_x_cropYield_s-10.09_e65.100.R)
# source(Rainfall_x_cropYield_s10.30_e30.65.R)
# source(Rainfall_x_cropYield_s10.30_e65.10.R)

lm_rain1 <- read.csv("data/lmInSeasonRainfall_-10.09_30.64.csv",stringsAsFactors = FALSE)
lm_rain2 <- read.csv("data/lmInSeasonRainfall_-10.09_65.100.csv",stringsAsFactors = FALSE)
lm_rain3 <- read.csv("data/lmInSeasonRainfall_10.30_30.64.csv",stringsAsFactors = FALSE)
lm_rain4 <- read.csv("data/lmInSeasonRainfall_10.30_65.100.csv",stringsAsFactors = FALSE)

lm_rain <- rbind(lm_rain1,lm_rain2,lm_rain3,lm_rain4)
```

Now we have read in the data from the previously computed models lets find the linear model which has:  
   - The lowest P value  
   - the highest adjusted r squared value  
   
```{r WhichLModel}
lm_rain[which(lm_rain$lm_pval == min(lm_rain$lm_pval)),]
lm_rain[which(lm_rain$lm_rsquared == max(lm_rain$lm_rsquared)),]
lm_rain[which(lm_rain$lm_adj_rsquared == max(lm_rain$lm_adj_rsquared)),]

```


To visualise the model fits we will use a heat map to describe how the models faired in relation to the rainfall windows. log of the p value was used to improve the resolution of small very small p values.  
```{r rainLMpvalue}
ggplot(lm_rain, aes(x = start_day, y = end_day, z = log(lm_pval)))+
   geom_raster(aes(fill = log(lm_pval)), interpolate = TRUE)+
   geom_contour(bins = 15, colour = "white")+
   geom_point(data = lm_rain[which(lm_rain$lm_pval == min(lm_rain$lm_pval)),], aes(x = start_day, y = end_day), colour =" red")+
   scale_fill_distiller(palette ="RdBu", direction = -1) 

```

```{r rainLMrsquared}
ggplot(lm_rain, aes(x = start_day, y = end_day, z = lm_rsquared))+
   geom_raster(aes(fill = lm_rsquared), interpolate = TRUE)+
   geom_contour(bins = 15, colour = "white")+
   geom_point(data = lm_rain[which(lm_rain$lm_rsquared == max(lm_rain$lm_rsquared)),], aes(x = start_day, y = end_day), colour =" red")+
   scale_fill_distiller(palette ="RdBu") 
```

```{r rainLMadjrsquared}
ggplot(lm_rain, aes(x = start_day, y = end_day, z = lm_adj_rsquared))+
   geom_raster(aes(fill = lm_adj_rsquared), interpolate = TRUE)+
   geom_contour(bins = 15, colour = "white")+
   geom_point(data = lm_rain[which(lm_rain$lm_rsquared == max(lm_rain$lm_rsquared)),], aes(x = start_day, y = end_day), colour =" red")+
   scale_fill_distiller(palette ="RdBu") 
```

The approximate period when in-crop rainfall impacts the most on the mean harvest is between 14 - 67 days after planting.




### Season range and first incidence
Mungbean is a summer crop and powdery mildew is requires cool conditions to establish. Therefore the disease can be avoided by planting early in summer or spring, avoiding cooler temperatures at the end of some seasons. Can we visualise when PM is most likely to establish over the calender year.  

I'll build a plot of horizontal lines indicating the season length and use a dot on the line to indicating the day of the year first sign was observed for that trial.  
```{r first_incidence}
# Create the data frame for the plot
season_dates <- PM_MB_means %>%
   group_by(trial_ref)%>%
   summarise(Planting_date = unique(planting_date),
             Harvest_date = unique(harvest_date),
             First_sign_PM = unique(first_sign_disease),
             season_length = as.integer(as.Date(unique(harvest_date)) - as.Date(unique(planting_date)))
             )

# function to extract date from the year
# format should be Universal time format
source("R/year2day.r")


season_dates$Planting_day <- unlist(lapply(season_dates$Planting_date,year2day))
season_dates$Disease_day <- unlist(lapply(season_dates$First_sign_PM,year2day))
season_dates$Harvest_day <- season_dates$Planting_day + season_dates$season_length

season_dates[1,"Planting_day"] <- year2day(as.Date("2012-02-28")-7) # planted in december and emerged in February, Assuming due to lack of rain or recording error. Using 7 days prior to emergence day as planting day


first_day_month <- c(0, 31, 59, 90, 120, 151, 181, 211, 243, 273)
axis_labels_date <- c(format(Sys.Date() - year2day(Sys.Date()) + first_day_month[1], "%b-%d"),  # Jan
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[2], "%b-%d"), # Feb
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[3], "%b-%d"), # March
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[4], "%b-%d"), # April
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[5], "%b-%d"), # May
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[6], "%b-%d"), # June
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[7], "%b-%d"), # July
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[8], "%b-%d"), # August
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[9], "%b-%d"), # Sept
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[10], "%b-%d") # October
                         )

# reorder the factors so they will appear in chronilogical order
# I used First sign because all trials have recorded this
season_dates$trial_ref <- 
   factor(season_dates$trial_ref, 
          levels = levels(season_dates$trial_ref)[rev(order(season_dates$First_sign_PM))])

# Plot
season_dates %>%
   ggplot()+
   geom_pointrange(aes(x = trial_ref, y = Disease_day, ymin = Planting_day, ymax = Harvest_day))+
   scale_y_continuous(
      limits = c(0, max(season_dates$Planting_day + 
                           season_dates$season_length, 
                        na.rm = TRUE)),
      labels = axis_labels_date,
      breaks = first_day_month
   )+
   geom_point(aes(x = trial_ref, y = Disease_day))+
   coord_flip()+
   ggtitle("Season length and when powdery mildew was first spotted\nin each respective trial")
   
```

In most years, regardless of the age of the crop, powdery mildew establishes in March.



#### Effect of Fungicide 
**Fungicide effect on proportional yield gain with respect to time of application**
First lets look at the quantiles for each fungicide irrespective of other factors.
We will focus on proportional yield gain, compared to no treatment control, as this should partially correct for some spatial and seasonal effects.  
```{r fungicide_proportion_yield}
PM_MB_means %>%
   group_by(fungicide_ai) %>%
   summarise(
      n = length(prop_YG),
      lower_2.5 = quantile(prop_YG, na.rm = T, c(0.025)),
      median = median(prop_YG, na.rm = T),
      mean = mean(prop_YG, na.rm = T),
      upper_97.5 = quantile(prop_YG, na.rm = T, c(0.975))
   ) %>%
   filter(n >= 5) %>% # remove any fungicide groups with less than 5 observations
   arrange(desc(median)) %>%
   kable(caption = "Fungicide effect on proportion of yield gain") %>%
   kable_styling(fixed_thead = T, full_width = T)

# plot table as a box plot
PM_MB_means %>%
   filter(
      fungicide_ai == c(
         "200 g/L tebuconazole + 120 g/L azoxystrobin" ,
         "200 g/L azoxystrobin + 80 g/L cyproconazole",
         "tebuconazole",
         "propiconazole",
         "sulphur"
      )
   ) %>%
   ggplot(aes(y = prop_YG, x = fungicide_ai)) +
   geom_boxplot() +
   geom_hline(aes(yintercept = 0), size = 0.5) +
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Proportion of grain yield saved",
        title = "Grain yield proportion saved grouped by\nFungicide type") +
   theme(
      panel.grid.major = element_line(colour = "grey80"),
      panel.grid.minor = element_line(colour = "grey50"),
      panel.background = element_rect(fill = NA)
   ) +
   guides(fill = guide_legend(title = "Fungicide")) +
   coord_flip()
#theme(axis.text.x = element_text(angle = 30, hjust =.6, vjust = 0.83))
#scale_x_continuous(limits = c(-0.3,0.6))

```
There was some hope groups of fungicide could be combined, _i.e._ Propiconazole and Tebeconazole, however it seems that they have different efficacies. Let us look to see if there is anything skewing the above.






Lets run this by a quick linear mixed effect model
```{r Fungicide_lmer}

PM_MB_means$fungicide_ai <-
   factor(
      PM_MB_means$fungicide_ai,
      levels = c(
         "control",
         "Propiconazole",
         "Tebeconazole",
         "Azoxystrobin",
         "200 g/l  Tebuconazole + 120 g/l  Azoxystrobin",
         "Carbendazim",
         "Benomyl",
         "Pyrazophos",
         "Acibenzolar-S-Methyl",
         "Sulphur"
      )
   )

class(PM_MB_means$trial_ref)

PM_MB_lmer.1 <-
   lmer(
      prop_YG ~ fungicide_ai * as.factor(n_treatment) + row_spacing + (1 |trial_ref),
      data = subset(PM_MB_means, 
                    n_treatment == 1 | n_treatment == 2)
   )

summary(PM_MB_lmer.1)

```
There is no significant difference between Fungicides, except for Sulphur which is significantly less effective than Propiconazole. Propiconazole, on average, out performs other fungicides when mitigating yield loss.





We need to also define the relationship between yield loss and disease severity. When exploring this data we should look primarily at the no spray control plots

```{r yield_x_PMseverity}

PM_MB_means %>%
   filter(fungicide == "control") %>%
   ggplot(aes(x = PM_final_severity, y = grain_yield.t.ha.)) +
   geom_point()+
   geom_smooth(method = "lm")

PM_MB_means %>%
   ggplot(aes(x = PM_final_severity, y = prop_YG)) +
   geom_point()+
   geom_smooth(method = "lm")

```


