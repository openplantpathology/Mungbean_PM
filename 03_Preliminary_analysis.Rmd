# Preliminary Analysis

```{r PA_Libraries}
library(dplyr)
library(openxlsx)
library(kableExtra)
library(ggplot2)
library(devtools)
library(lme4)
library(theme.usq)
#source("./getPPD2.R")

```



### Yield saved from fungicide applications  

The data plotted below are from the past field trials (2011 - 2017) described in the aforementioned table. All data are a list of mean values from each treatment applied in each experiment. Various factors have been studied in the previous experiments which may influence the following results. The following variables were disregarded in the plots below.

   1) Fungicide type
   2) Fungicide dose
   3) row spacing
   4) Host cultivars
   5) Experiment location
   6) Final disease rating

```{r echo=FALSE, message=FALSE, warning=FALSE, include= FALSE}
# Import data
PM_MB_means <- read.csv("data/1902 powdery mildew-Mungbean - Collated means.csv")


# Which row spacing leads to the higher disease severity
PM_MB_means %>%
   filter(Year >= 2017)%>%
   filter(Fungicide == "control") %>%
ggplot(aes(y = PM_final_severity, x = row_spacing, colour = Location))+
   geom_point()+
   geom_smooth()+
   scale_y_continuous(limits = c(-5,15))+
   theme_usq()


# Which row spacing leads to the higher yeild potential
PM_MB_means %>%
   filter(Year >= 2017)%>%
#   filter(Fungicide == "control") %>%
ggplot(aes(y = as.numeric(grain_yield.t.ha.), x = row_spacing, colour = Location))+
   geom_jitter(width = 0.01)+
   geom_smooth()+
#   scale_y_continuous(limits = c(-5,15))+
   theme_usq()



```



#### Yield saved 
##### Number of fungicide applications
The following density plots show mean yield saved in relation to how many sprays were applied. 

```{r warning=FALSE, echo=FALSE}
library(ggplot2)
PM_MB_means <- read.csv("./data/1902 powdery mildew-Mungbean - Collated means.csv")


# Making a table of showing the upper and lower percentiles (95%)
quant_PMy <- PM_MB_means %>%
   filter(Fungicide != "control") %>%
   group_by(total_Fungicide) %>%
   summarise(lower = quantile(yield_gain, na.rm = T, c(0.025)),
             upper = quantile(yield_gain, na.rm = T, c(0.975)))
# Density plot of Number of fungicide applications and the resulting yeild saved (as a proportion)
ggplot(subset(PM_MB_means,Fungicide != "control"), aes(yield_gain))+
   geom_density(aes(group = factor(total_Fungicide), fill = factor(total_Fungicide)), alpha = 0.6)+
   geom_vline(xintercept = 0, size =1)+
   labs(x = "Grain yeild saved (t/ha)",
   title = "Density plot of grain yield saved from differing numbers of fungicide applications")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   geom_vline(data = quant_PMy, aes(xintercept = lower, 
               colour = factor(total_Fungicide)),size =0.9, linetype =  "dashed")+
   geom_vline(data = quant_PMy, aes(xintercept = upper, 
               colour = factor(total_Fungicide)),size =0.9, linetype =  "dashed")+
   guides(colour = guide_legend(title="Upper (97.5%) and \nLower (2.5%) percentiles"),
          fill=guide_legend(title="Number of \nFungicide applications"))+
   scale_x_continuous(limits = c(-0.3,0.8))
   
names(quant_PMy) <- c("Number of sprays", "2.5 percentile", "97.5 percentile")
knitr::kable(quant_PMy)
#             col.names = c("Number of sprays", "2.5 percentile", "97.5 percentile"))
#            caption = "The 'upper' and 'lower' percentiles for yeild saved (t/Ha) against the number of Fungicide sprays in a season. Data from 2011-2017 mungbean experimental means. Data ignores factors such as fungicide, dose, season or location of experiment")
# Making a table of showing the upper and lower percentiles (95%)
quant_PM <- PM_MB_means %>%
   filter(Fungicide != "control") %>%
   group_by(total_Fungicide) %>%
   summarise(lower = quantile(prop_YG, na.rm = T, c(0.025)),
             upper = quantile(prop_YG, na.rm = T, c(0.975)))
# Density plot of proportion of yield saved
ggplot(subset(PM_MB_means,Fungicide != "control"), aes(prop_YG))+
   geom_density(aes(group = factor(total_Fungicide), fill = factor(total_Fungicide)), alpha = 0.6)+
   geom_vline(xintercept = 0, size =1)+
   labs(x = "Proportion of grain yeild saved",
   title = "Density plot of the grain yield proportion saved \n by the number of fungicide applications")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   geom_vline(data = quant_PM, aes(xintercept = lower, 
               colour = factor(total_Fungicide)),size =0.9, linetype =  "dashed")+
   geom_vline(data = quant_PM, aes(xintercept = upper, 
               colour = factor(total_Fungicide)),size =0.9, linetype =  "dashed")+
   guides(colour = guide_legend(title="Upper (97.5%) and \nLower (2.5%) percentiles"),
          fill=guide_legend(title="Number of \nFungicide applications"))+
   scale_x_continuous(limits = c(-0.3,0.55))
names(quant_PM) <- c("Number of sprays", "2.5 percentile", "97.5 percentile")
knitr::kable(quant_PM)   
#knitr::kable(quant_PM, 
#             col.names = c("Number of sprays", "2.5 percentile", "97.5 percentile"))
             #caption = "The 'upper' and 'lower' percentiles for proportion of yeild saved against the number of Fungicide sprays in a season. Data from 2011-2017 mungbean experimental means. Data ignores factors such as fungicide, dose, season or location of experiment")
```

\n\n\n\n\n\n\n

#### Timing of Fungicide application
The following density plots show mean yield saved (t/Ha) or proportion yield saved in relation to when the first fungicide spray was applied in relation to when powdery mildew was first seen in the mungbean crop.  

```{r echo = FALSE, message=FALSE, warning=FALSE}
# removing 2017 and control data
# this will help look at when the first application of fungicide is applied in relation to when the disease first appeared
PM_MB_means1 <- PM_MB_means %>%
   filter(Fungicide != "control") %>%
   filter(Year != 2017) %>%
#   filter(total_Fungicide ==1) %>%
   mutate(days_from_1st = as.numeric(as.Date(Fungicide_application_1) - first_sign_disease))
colnames(PM_MB_means)
days_from_fungicid <- function(FSD,F1,F2,F3){
   dF1 <- as.numeric(as.Date(F1) - as.Date(FSD))
   dF2 <- as.numeric(as.Date(F2) - as.Date(FSD))
   dF3 <- as.numeric(as.Date(F3) - as.Date(FSD))
   if(is.na(dF1)){
      return(NA)} else{
   if(between(dF1,lower = -1, upper = 1000)){
      return(dF1)}else{
   if(is.na(dF2)){
      return(dF1)}else{
      if(between(dF2,lower = dF1, upper = -0.1)){
            return(dF2)} else{
               return(dF3)}}
            }}
}
vec1<- vector()
for(i in 1:dim(PM_MB_means1)[1]){
   dF1 <- as.numeric(as.Date(PM_MB_means1$Fungicide_application_1)[i] - as.Date(PM_MB_means1$first_sign_disease)[i])
   dF2 <- as.numeric(as.Date(PM_MB_means1$Fungicide_application_2)[i] - as.Date(PM_MB_means1$first_sign_disease)[i])
   dF3 <- as.numeric(as.Date(PM_MB_means1$Fungicide_application_3)[i] - as.Date(PM_MB_means1$first_sign_disease)[i])
   if(is.na(dF1)){
      vec1 <- c(vec1,dF1)} else{
         if(between(as.numeric(dF1),-1, 1000)){
            vec1 <- c(vec1,dF1)}else{
               if(is.na(dF2)){
                  vec1 <- c(vec1,dF1)}else{
                     if(between(as.numeric(dF2),as.numeric(dF1), -1.1)){
            vec1 <- c(vec1,dF2)} else{
               if(as.numeric(dF3)>=0){
                  vec1 <- c(vec1,dF2)} else{
                     vec1 <- c(vec1,dF3)}}}
            }}
}
PM_MB_means1$spray_diff <- vec1 # gives the 
PM_MB_means1$days_from_1st
#summary(factor(PM_MB_means1$days_from_1st))
# Density plot of proportion of yield saved
ggplot(PM_MB_means1, aes(prop_YG))+
   geom_density(aes(group = cut(PM_MB_means1$days_from_1st, c(-15,-6,-0.5,0.5,2,10,20)), 
                    fill = cut(PM_MB_means1$days_from_1st, c(-15,-6,-0.5,0.5,2,10,20))), alpha = 0.3)+
   geom_vline(xintercept = 0, size =1)+
   labs(x = "Proportion of grain yeild saved",
   title = "Grain yield proportion saved grouped by\nwhen the first fungicide application was made\nrelative to when Powdery Mildew was first seen")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   guides(fill=guide_legend(title="First spray window\nrelative to\nFirst sign of disease"))+
   scale_x_continuous(limits = c(-0.3,0.55))
###########################################3
unique(PM_MB_means1$days_from_1st)
ggplot(PM_MB_means1, aes(prop_YG))+
   geom_density(aes(fill = cut(PM_MB_means1$days_from_1st, c(-41,-20,-15,-12,-0.5,1.5,7,10,12,20))), alpha = 0.5)+
   geom_vline(aes(xintercept = 0), size =0.5)+
   facet_grid(cut(PM_MB_means1$days_from_1st, c(-41,-20,-15,-12,-0.5,1.5,7,10,12,20))~., factor(PM_MB_means1$Fungicide))+
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Proportion of grain yeild saved",
   title = "Grain yield proportion saved grouped by\nwhen the first fungicide application was made\nrelative to when Powdery Mildew was first seen")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   guides(fill=guide_legend(title="Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease"))+
   scale_x_continuous(limits = c(-0.2,0.55))
unique(PM_MB_means1$spray_diff)
ggplot(PM_MB_means1, aes(prop_YG))+
   geom_density(aes(fill = cut(PM_MB_means1$spray_diff, c(-29,-20,-15,-12,-0.5,1.5,7,10,12,20))), alpha = 0.5)+
   geom_vline(aes(xintercept = 0), size =0.5)+
   facet_grid(cut(PM_MB_means1$spray_diff, c(-29,-20,-15,-12,-0.5,1.5,7,10,12,20))~.)+
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Proportion of grain yeild saved",
   title = "Grain yield proportion saved grouped by\nwhen the first fungicide application was made\nrelative to when Powdery Mildew was first seen")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   guides(fill=guide_legend(title="Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease"))+
   scale_x_continuous(limits = c(-0.2,0.55))
# Making a table of showing the upper and lower percentiles (95%)
quant_PM_prop <- PM_MB_means1 %>%
   mutate(cut_daysfrom1st = cut(PM_MB_means1$days_from_1st, c(-15,-6,-0.5,0.5,2,10,20))) %>%
   group_by(cut_daysfrom1st) %>%
   summarise(lower = quantile(prop_YG, na.rm = T, c(0.025)),
             upper = quantile(prop_YG, na.rm = T, c(0.975)))
names(quant_PM_prop) <- c("Days relative to\nfirst incidence", "2.5 percentile", "97.5 percentile")
cat("Lower (2.5) and Upper (97.5) quantiles for the proportion of yield gained, when the first fungicide applied relative to when powdery mildew is first seen")
knitr::kable(quant_PM_prop)   
ggplot(PM_MB_means1, aes(yield_gain))+
   geom_density(aes(fill = cut(PM_MB_means1$days_from_1st, c(-29,-15,-6,-0.5,0.5,2,10,20))), alpha = 0.5)+
   geom_vline(aes(xintercept = 0), size =0.5)+
   facet_grid(cut(PM_MB_means1$days_from_1st, c(-29,-15,-6,-0.5,0.5,2,10,20))~.)+
   scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Grain yield (t/Ha) saved",
   title = "Grain yield (t/Ha) saved, grouped by when the\nfirst fungicide application was made\nrelative to when Powdery Mildew was first seen")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   guides(fill=guide_legend(title="Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease"))+
   scale_x_continuous(limits = c(-0.4,1.2))
# Making a table of showing the upper and lower percentiles (95%)
quant_PM_prop <- PM_MB_means1 %>%
   mutate(cut_daysfrom1st = cut(PM_MB_means1$days_from_1st, c(-29,-20,-15,-6,-0.5,0.5,2,10,20))) %>%
   group_by(cut_daysfrom1st) %>%
   summarise(lower = quantile(yield_gain, na.rm = T, c(0.025)),
             upper = quantile(yield_gain, na.rm = T, c(0.975)))
names(quant_PM_prop) <- c("Days relative to\nfirst incidence", "2.5 percentile", "97.5 percentile")
print("Yield gain quantiles when the first fungicide applied relative to when powdery mildew is first seen, Lower (2.5) and Upper (97.5) quantiles of yeild ")
knitr::kable(quant_PM_prop)  
```



```{r}
PM_MB_means2 <- PM_MB_means1 %>%
   filter(Fungicide == "Tebeconazole")
unique(PM_MB_means2$spray_diff)
ggplot(PM_MB_means2, aes(prop_YG))+
   geom_density(aes(fill = cut(PM_MB_means2$spray_diff, c(-1,2,7,10,12,20))), alpha = 0.5)+
   geom_vline(aes(xintercept = 0), size =0.5)+
   facet_grid(cut(PM_MB_means2$spray_diff, c(1,2,7,10,12,20))~.)+
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Proportion of grain yeild saved",
   title = "Grain yield proportion saved grouped by\nwhen the first fungicide application was made\nrelative to when Powdery Mildew was first seen")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   guides(fill=guide_legend(title="Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease"))+
   scale_x_continuous(limits = c(-0.2,0.55))
#__________________________________________________________________________________________________________
levels(factor(PM_MB_means$Fungicide))
PM_MB_means2 <- PM_MB_means1 %>%
   filter(Fungicide == "Sulphur" |
             Fungicide == "Sulphur (SC)" |
             Fungicide == "Sulphur (Ultra SC)" |
             Fungicide == "Sulphur (WP)")
unique(PM_MB_means2$spray_diff)
ggplot(PM_MB_means2, aes(prop_YG))+
   geom_density(aes(fill = cut(PM_MB_means2$spray_diff, c(-30,-19,-15,-10,-1,2,7,10,12,21))), alpha = 0.5)+
   geom_vline(aes(xintercept = 0), size =0.5)+
   facet_grid(cut(PM_MB_means2$spray_diff, c(-30,-19,-15,-10,-1,2,7,10,12,21))~.)+
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Proportion of grain yeild saved",
   title = "Grain yield proportion saved grouped by\nwhen the first fungicide application was made\nrelative to when Powdery Mildew was first seen")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   guides(fill=guide_legend(title="Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease"))+
   scale_x_continuous(limits = c(-0.3,0.6))
Chemical <- c("Amistar","Carbendazim","Tebeconazole", "propiconazole")
levels(factor(PM_MB_means$Fungicide))
for(Chem in Chemical){
PM_MB_means2 <- PM_MB_means1 %>%
   filter(Fungicide == Chem)
cat(Chem)
cat(unique(PM_MB_means2$spray_diff))
p1 <- ggplot(PM_MB_means2, aes(prop_YG))+
   geom_density(aes(fill = cut(PM_MB_means2$spray_diff, c(-50,-17,-16,-10,-9,-2.5,-2,2,2.5,9,10,16,17,30))), alpha = 0.5)+
   geom_vline(aes(xintercept = 0), size =0.5)+
   facet_grid(cut(PM_MB_means2$spray_diff, c(-50,-17,-16,-10,-9,-2.5,-2,2,2.5,9,10,16,17,30))~.)+
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Proportion of grain yeild saved",
   title = "Grain yield proportion saved grouped by\nwhen the first fungicide application was made\nrelative to when Powdery Mildew was first seen")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   guides(fill=guide_legend(title=paste(Chem,"Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease")))+
   scale_x_continuous(limits = c(-0.3,0.6))
print(p1)
Sys.sleep(10)
}
```