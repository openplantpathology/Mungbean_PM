# Preliminary Analysis

```{r PA_Libraries, include=FALSE}
library(tidyverse)
library(bomrang)
library(openxlsx)
library(kableExtra)
library(ggplot2)
library(devtools)
library(lme4)
library(theme.usq)
source("R/import_data.R")
#source("./getPPD2.R")
```

## Explore and visualise Data

```{r echo=FALSE, message=FALSE, warning=FALSE, include= FALSE}
# Import data
PM_MB_means <- import_data()

#remove the variation in different sulphur formulations
unique(PM_MB_means[
   grep("sulphur",PM_MB_means$fungicide),
   "fungicide"])
PM_MB_means[grep("sulphur",PM_MB_means$fungicide),"fungicide"] <- "sulphur"

```

Various factors have been studied in the previous experiments which may influence the following results. However unless stated the following plots and analyses were made disregarding effects from other factors not mentioned.

   1) Fungicide type  
   
   2) Fungicide dose (varies only slightly within some fungicide types)  
   
   3) Number of fungicide sprays  
   
   4) Timing of fungicide spray/s relative to first sign of disease (ie. when pathogen is present)  
   
   5) Host cultivars (probably is a covariate with season due to changing cultivars over time)  
   
   6) Experiment location  
   
   7) Row spacing  
   
   8) In-crop rainfall  
   
   9) Irrigated vs non-irrigated trials  
   
   10) Mean daily temperature in the weeks following spray application  
   
   11) Final disease rating  
   
   12) Two pathogen species cause PM (new discovery in 2018)


### Fungicides
#### Fungicide type
The data plotted below are from `r length(unique(PM_MB_means$trial_ref))` field trials between (`r first(levels(PM_MB_means$year))` - `r last(levels(PM_MB_means$year))`) of which the details are described in [Studies considered in meta-analysis section](#studies-considered-in-meta-analysis).  
All data explored below are a list of mean values from each treatment applied in each experiment. Some experiments have in-season observations of disease incidence and severity, however here we have summarised the data to show only the end of season observations.    
```{r Fungicides}
PM_MB_means %>%
   group_by(fungicide_ai, trial_ref) %>%
   summarise() %>%
   count(sort = TRUE) %>%
   rename(Trials = n) %>%
   ggplot(aes(x = reorder(fungicide_ai, Trials), y = Trials)) +
   xlab("Fungicide active ingredient") +
   ylab("N Trials") +
   geom_col() +
   scale_fill_usq() +
   ggtitle(label = "Number of trials in which the\nspecified fungicide was used") +
   scale_colour_usq() +
   theme_usq() +
   coord_flip()
```


   - Tebuconazole and propiconazole might be able to be pooled as a triazole fungicide treatment.  

   - Amistar Xtra and Custodia are both contain strobilurin and triazole, however, they because they contain differing dose ratios (inverted) pooling may not be appropriate.  

   - Perhaps best way forward is to do an analysis of only the triazoles/demethylation inhibitors. Then do another including azoxystrobin as a comparison.  

The primary focus of this research is the effect of fungicide on mitigating yield loss to disease. To reduce the affect of location and seasonal influences we will investigate the proportion of grain yield saved, relative to the no spray controls.  

First lets investigate the difference in the effect of fungicide on proportion of yield saved?  

```{r Fungicide_x_nSprays, message=FALSE}
PM_MB_means %>%
   group_by(fungicide, total_fungicide) %>%
   summarise(
      n = length(prop_YG),
      lower_2.5 = quantile(prop_YG, na.rm = T, c(0.025)),
      median = median(prop_YG, na.rm = T),
      mean = mean(prop_YG, na.rm = T),
      upper_97.5 = quantile(prop_YG, na.rm = T, c(0.975))
   ) %>%
   filter(n >= 5) %>% # remove any fungicide groups with less than 5 observations
   arrange(desc(median)) %>%
   kable(caption = "Fungicide effect on proportion of yield gain.") %>%
   kable_styling(fixed_thead = T, full_width = T) %>%
   footnote(general = "Fungicides with less than five observations were omitted from this table")

class(PM_MB_means$fungicide)

PM_MB_means %>%
   mutate(fungicide = as.factor(PM_MB_means$fungicide)) %>%
   filter(total_fungicide == 1 | total_fungicide == 2) %>%
   filter(
      fungicide != "pyrazophos" &
         fungicide != "control" &
         fungicide != "benomyl" &
         fungicide != "Acibenzolar-S-methyl"
   ) %>%
   mutate(fungicide = factor(fungicide, 
                             levels = c("carbendazim", "pyraclostrobin",
                                        "sulphur", "200 g/L azoxystrobin + 80 g/L cyproconazole",
                                        "tebuconazole", "propiconazole", 
                                        "200 g/L tebuconazole + 120 g/L azoxystrobin"))) %>%
   ggplot(aes(y = prop_YG, x = fungicide)) +
   facet_grid(rows = vars(total_fungicide)) +
   geom_boxplot(aes(fill = fungicide, alpha = 0.5)) +
   geom_hline(aes(yintercept = 0), size = 0.5) +
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(y = "Proportion of grain yield saved",
        title = "Grain yield proportion saved\ngrouped by Fungicide type") +
   theme_usq() +
   theme(legend.position = "none") +
   # coord_cartesian() +
   # scale_x_discrete(
   #    limits = c(
   #       "200 g/l  Tebuconazole + 120 g/l  Azoxystrobin",
   #       "Propiconazole",
   #       "Tebeconazole",
   #       "200g/L Azoxystrobin + 80 g/L Cyproconazole",
   #       "Sulphur",
   #       "Carbendazim",
   #       "Pyraclostrobin",
   #       "Azoxystrobin"
   #    )
   # ) +
   #  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3))+
   coord_flip()
#scale_x_continuous(limits = c(-0.3,0.6))


```




#### Fungicide Doses  

All trials that used tebuconazole used approximately the same dose.
Dose of the active ingredient ranged from 62.35&nbsp;g per hectare to 60&nbsp;g per hectare. 

```{r tebu_dose}
PM_MB_means %>%
   filter(fungicide_ai == "tebuconazole") %>%
   select(trial_ref,
          year,
          location,
          first_sign_disease,
          dose_ai.ha,
          total_fungicide) %>%
   ggplot(aes(x = as.factor(dose_ai.ha))) +
   xlab("Dose (g ai/ha)") +
   ggtitle(label = "Total number of treatments for each respective tebuconazole dose") +
   geom_bar() +
   scale_fill_usq() +
   scale_colour_usq() +
   theme_usq()
```

#### Number of fungicide sprays  

#### Timing of fungicide sprays


### Mungbean cultivars  
Host genotype may need to be analysed to determine the effect.

```{r Host_genotype}
PM_MB_means %>%
   filter(fungicide_ai == "tebuconazole",
         row_spacing == 0.75) %>%
   group_by(host_genotype, trial_ref) %>%
   summarise() %>%
   count() %>%
   rename(Treatments = n) %>%
   ggplot(aes(x = host_genotype, y = Treatments)) +
   xlab("Cultivar") +
   ylab("N Trials") +
   ggtitle(label = "Cultivars used in tebuconazole trials with 0.75 m row spacing") +
   geom_col() +
   scale_fill_usq() +
   scale_colour_usq() +
   theme_usq()
```

In general the mungbean varieties have the following resistance to powdery mildew.

   - Berken: Highly susceptible
   
   - Crystal: Susceptible
   
   - Jade: Moderately susceptible

#### Genotype yield variability

Host genotype seems to contribute to the variation in yield. Berken shows higher yields compared to crystal and jade.
```{r yield_vol}
# this could be converted into a shiny app as a chunk. Make each input for the function a shiny option
# Outputs the table and graph
source("R/yield_volatility.r") #function to investigate the volatility in yields
# Volitility is the range between the upper and lower 97.5 and 2.5 % quartiles

YV1 <- yield_volatility(genotype_by_trial = FALSE, control_only = FALSE)
YV1[[2]]
YV1[[3]]
YV2 <- yield_volatility(genotype_by_trial = FALSE, control_only = TRUE)
YV2[[2]]

YV1_herm <- yield_volatility(genotype_by_trial = FALSE, control_only = FALSE, location = "Hermitage")
YV1_herm[[2]]

YV1_crystal <- yield_volatility("Crystal",control_only = FALSE)
YV1_crystal[[2]]

YV2_crystal <- yield_volatility("Crystal",control_only = TRUE)
YV2_crystal[[2]]


YV1_herm_jade <- yield_volatility("Jade",control_only = FALSE, location = "Hermitage")
YV2_jade <- yield_volatility("Jade",control_only = TRUE)

```





### Row spacing  

Some experiments were designed to investigate the effect of row spacing and plant density on powdery mildew disease.
The results showed that the row spacing had no statistically significant effect on powdery mildew, but narrower rows in most cases increased yield significantly. This finding has also been shown by Kerry McKenzie's work as well.
Eight trials used a row spacing of 0.75&nbsp;meters and tebuconazole as an active ingredient (AI).

```{r row_spacing.m}
PM_MB_means %>%
   filter(fungicide_ai == "tebuconazole" | fungicide_ai == "propiconazole") %>%
   group_by(fungicide_ai, row_spacing, trial_ref) %>%
   summarise() %>%
   count() %>%
   rename(Trials = n) %>%
   ggplot(aes(x = as.factor(row_spacing), y = Trials)) +
   xlab("Row Spacing (m)") +
   ylab("N Trials") +
   ggtitle(label = "Trial row spacing using tebuconazole") +
   geom_col(aes(fill = fungicide_ai),
            position = "dodge") +
   scale_fill_usq(name = "Fungicide AI") +
   theme_usq()

PM_MB_means %>%
   filter(fungicide_ai == "tebuconazole",
         row_spacing == 0.75) %>% 
   glimpse()
```

Were there any statistical difference between all row spacing or only some?
Can we pool certain row spacing that have no significant difference?  
From the preliminary analysis, the graphs seem to imply if there is a lower overall yield there is no effect of row spacing on yield.
However, if the average yield is more than approximately 0.6 - 1 t/ha then smaller row spacing has the potential to provide greater yield per hectare.


```{r row_spacing}

# Which row spacing leads to the higher disease severity
PM_MB_means %>%
   filter(year == 2017 |
             year == 2018) %>%
   filter(fungicide == "control") %>%
   ggplot(aes(y = PM_final_severity, x = factor(row_spacing))) +
   geom_boxplot() +
   #  geom_smooth()+
   scale_y_continuous(limits = c(-5, 15)) +
   theme_usq()+
   ggtitle("Powdery mildew variation between different row spacing")


# Which row spacing leads to the higher yeild potential
PM_MB_means %>%
   filter(year == 2017|
             year == 2018) %>%
   #   filter(Fungicide == "control") %>%
   ggplot(aes(
      y = as.numeric(grain_yield.t.ha.),
      x = row_spacing,
      colour = location
   )) +
   geom_smooth(method = "gam") +
   geom_jitter(width = 0.01) +
   #   scale_y_continuous(limits = c(-5,15))+
   theme_usq()+
   ggtitle("Grain yield results for different row spacing at three locations")



```







### Yield vs in-season rain  

In crop rain could be a significant factor which contributes to the end of season grain yield. To investigate any relationship I will loop a linear model over time periods from 20 days prior to planting, to 100 days after planting.

Loop over the dates at the start of the season (to 90 days after planting) to find which date fits the best linear model for grain weight and in-crop rainfall. The code for this process was moved to be contained within it's own script and can be run as a job as it can take a long time. To speed up the computation I split the script into four, ran the jobs and bound the data into one frame. The output of the script is saved with the prefix `lmInSeasonRainfall` followed by the time windows the model is run. For example `lmInSeasonRainfall_20.40_50.80.csv` holds the model results for start days between 20 and 40 days after planting to end window dates between 50 and 80 days after planting.

```{r rainfall_sum_Sstart}
# The four data files were created from four scripts run as four jobs in Rstudio
# when the four jobs are finished they can be imported and combined into one data.frame
# source(Rainfall_x_cropYield_s-10.09_e30.65.R)
# source(Rainfall_x_cropYield_s-10.09_e65.100.R)
# source(Rainfall_x_cropYield_s10.30_e30.65.R)
# source(Rainfall_x_cropYield_s10.30_e65.10.R)

lm_rain1 <- read.csv("data/lmInSeasonRainfall_-10.09_30.64.csv",stringsAsFactors = FALSE)
lm_rain2 <- read.csv("data/lmInSeasonRainfall_-10.09_65.100.csv",stringsAsFactors = FALSE)
lm_rain3 <- read.csv("data/lmInSeasonRainfall_10.30_30.64.csv",stringsAsFactors = FALSE)
lm_rain4 <- read.csv("data/lmInSeasonRainfall_10.30_65.100.csv",stringsAsFactors = FALSE)

lm_rain <- rbind(lm_rain1,lm_rain2,lm_rain3,lm_rain4)

lm_rain[which(lm_rain$lm_pval == min(lm_rain$lm_pval)),]
lm_rain[which(lm_rain$lm_rsquared == max(lm_rain$lm_rsquared)),]
lm_rain[which(lm_rain$lm_adj_rsquared == max(lm_rain$lm_adj_rsquared)),]



ggplot(lm_rain, aes(x = start_day, y = end_day, z = log(lm_pval)))+
   geom_raster(aes(fill = log(lm_pval)), interpolate = TRUE)+
   geom_contour(bins = 15, colour = "white")+
   geom_abline(intercept = 0, slope = 1, colour = "red")+
   geom_point(data = lm_rain[which(lm_rain$lm_pval == min(lm_rain$lm_pval)),], aes(x = start_day, y = end_day), colour =" red")+
   scale_fill_distiller(palette ="RdBu", direction = -1) 



ggplot(lm_rain, aes(x = start_day, y = end_day, z = lm_rsquared))+
   geom_raster(aes(fill = lm_rsquared), interpolate = TRUE)+
   geom_contour(bins = 15, colour = "white")+
   geom_abline(intercept = 0, slope = 1, colour = "red")+
   geom_point(data = lm_rain[which(lm_rain$lm_rsquared == max(lm_rain$lm_rsquared)),], aes(x = start_day, y = end_day), colour =" red")+
   scale_fill_distiller(palette ="RdBu") 



ggplot(lm_rain, aes(x = start_day, y = end_day, z = lm_adj_rsquared))+
   geom_raster(aes(fill = lm_adj_rsquared), interpolate = TRUE)+
   geom_contour(bins = 15, colour = "white")+
   geom_abline(intercept = 0, slope = 1, colour = "red")+
   geom_point(data = lm_rain[which(lm_rain$lm_rsquared == max(lm_rain$lm_rsquared)),], aes(x = start_day, y = end_day), colour =" red")+
   scale_fill_distiller(palette ="RdBu") 


source("R/AUS_rainfall_function.r")
source("R/rainfall_sum_dat.R")

for(i in rain_dat_sum$trial_ref){
dat_rain <- rain_dat_sum[rain_dat_sum$trial_ref == i,]
   
   rain_dat_sum[which(rain_dat_sum$trial_ref == i), "rainfall_sum"] <- 
      AUS_rainfall(StartDate = as.Date(dat_rain$planting_date) +
                   lm_rain[which(lm_rain$lm_adj_rsquared == max(lm_rain$lm_adj_rsquared)), "start_day"],
                EndDate = as.Date(dat_rain$planting_date) +
                   lm_rain[which(lm_rain$lm_adj_rsquared == max(lm_rain$lm_adj_rsquared)), "end_day"],
                latlong = as.vector(unlist(dat_rain[, 5:6])))
}

rain_lm <- lm(rainfall_sum ~ grain_yield, 
                             data = rain_dat_sum[rain_dat_sum$location != "Hermitage",])

summary(rain_lm)

rain_dat_sum %>%
   ggplot(aes(x = grain_yield, y = rainfall_sum, colour = location))+
   geom_point() + 
   geom_abline(intercept = -167.98, slope = 284.44, colour = "red")

resid_rain_lm <- residuals(rain_lm)

```

The approximate period when in-crop rainfall impacts the most on the mean harvest is between 14 - 67 days after planting.




### Season range and first incidence

```{r first_incidence}
# Here I want to build a plot of horizontal lines indicating the season length and
# place a dot on the line to indicating the day of the year first sign was observed for that trial

season_dates <- PM_MB_means %>%
   group_by(trial_ref)%>%
   summarise(Planting_date = unique(planting_date),
             Harvest_date = unique(harvest_date),
             First_sign_PM = unique(first_sign_disease),
             season_length = as.integer(as.Date(unique(harvest_date)) - as.Date(unique(planting_date)))
             )


# function to extract date from the year
# format should be Universal time format
source("R/year2day.r")


season_dates$Planting_day <- unlist(lapply(season_dates$Planting_date,year2day))
season_dates$Disease_day <- unlist(lapply(season_dates$First_sign_PM,year2day))
season_dates$Harvest_day <- season_dates$Planting_day + season_dates$season_length

season_dates[1,"Planting_day"] <- year2day(as.Date("2012-02-28")-7) # planted in december and emerged in February, Assuming due to lack of rain or recording error. Using 7 days prior to emergence day as planting day


first_day_month <- c(0, 31, 59, 90, 120, 151, 181, 211, 243, 273)
axis_labels_date <- c(format(Sys.Date() - year2day(Sys.Date()) + first_day_month[1], "%b-%d"),  # Jan
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[2], "%b-%d"), # Feb
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[3], "%b-%d"), # March
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[4], "%b-%d"), # April
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[5], "%b-%d"), # May
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[6], "%b-%d"), # June
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[7], "%b-%d"), # July
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[8], "%b-%d"), # August
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[9], "%b-%d"), # Sept
                         format(Sys.Date() - year2day(Sys.Date()) + first_day_month[10], "%b-%d") # October
                         )

# reorder the factors so they will appear in chronilogical order
# I used First sign because all trials have recorded this
season_dates$trial_ref <- factor(season_dates$trial_ref, levels = levels(season_dates$trial_ref)[rev(order(season_dates$First_sign_PM))])


season_dates %>%
   ggplot()+
   geom_pointrange(aes(x = trial_ref, y = Disease_day, ymin = Planting_day, ymax = Harvest_day))+
   scale_y_continuous(
      limits = c(0, max(season_dates$Planting_day + 
                           season_dates$season_length, 
                        na.rm = TRUE)),
      labels = axis_labels_date,
      breaks = first_day_month
   )+
   geom_point(aes(x = trial_ref, y = Disease_day))+
   coord_flip()+
   ggtitle("Season length and when powdery mildew was first spotted\nin each respective trial")
   
```







#### Effect of Fungicide 
**on proportional yield gain with respect to time of application**
First lets look at the quantiles for each fungicide irrespective of other factors.
We will focus on proportional yield gain, compared to no treatment control, as this should partially correct for some spatial and seasonal effects.  
```{r fungicide_proportion_yield}
PM_MB_means %>%
   group_by(fungicide) %>%
   summarise(
      n = length(prop_YG),
      lower_2.5 = quantile(prop_YG, na.rm = T, c(0.025)),
      median = median(prop_YG, na.rm = T),
      mean = mean(prop_YG, na.rm = T),
      upper_97.5 = quantile(prop_YG, na.rm = T, c(0.975))
   ) %>%
   filter(n >= 5) %>% # remove any fungicide groups with less than 5 observations
   arrange(desc(median)) %>%
   kable(caption = "Fungicide effect on proportion of yield gain") %>%
   kable_styling(fixed_thead = T, full_width = T)

unique(PM_MB_means$fungicide)
# plot table as a box plot
PM_MB_means %>%
   filter(
      fungicide == c(
         "200 g/L tebuconazole + 120 g/L azoxystrobin" ,
         "200 g/L azoxystrobin + 80 g/L cyproconazole",
         "tebuconazole",
         "propiconazole"
      )
   ) %>%
   ggplot(aes(y = prop_YG, x = fungicide)) +
   geom_boxplot() +
   geom_hline(aes(yintercept = 0), size = 0.5) +
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Proportion of grain yield saved",
        title = "Grain yield proportion saved grouped by\nFungicide type") +
   theme(
      panel.grid.major = element_line(colour = "grey80"),
      panel.grid.minor = element_line(colour = "grey50"),
      panel.background = element_rect(fill = NA)
   ) +
   guides(fill = guide_legend(title = "Fungicide")) +
   coord_cartesian() +
   coord_flip()
#theme(axis.text.x = element_text(angle = 30, hjust =.6, vjust = 0.83))
#scale_x_continuous(limits = c(-0.3,0.6))

```
There was some hope groups of fungicide could be combined, _i.e._ Propiconazole and Tebeconazole, however it seems that they have different efficacies. Let us look to see if there is anything skewing the above.






Lets run this by a quick linear mixed effect model
```{r Fungicide_lmer}
levels(PM_MB_means$Fungicide)

PM_MB_means$Fungicide <-
   factor(
      PM_MB_means$Fungicide,
      levels = c(
         "control",
         "Propiconazole",
         "Tebeconazole",
         "Azoxystrobin",
         "200 g/l  Tebuconazole + 120 g/l  Azoxystrobin",
         "Carbendazim",
         "Benomyl",
         "Pyrazophos",
         "Acibenzolar-S-Methyl",
         "Sulphur",
         "Sulphur (SC)",
         "Sulphur (Ultra SC)",
         "Sulphur (WP)"
      )
   )

PM_MB_lmer.1 <-
   lmer(
      prop_YG ~ Fungicide * as.factor(total_Fungicide) + row_spacing + (1 |
                                                                           Trial_ref),
      data = subset(PM_MB_means, total_Fungicide == 1 |
                       total_Fungicide == 2)
   )

summary(PM_MB_lmer.1)

```
There is no significant difference between Fungicides, except for Sulphur which is significantly less effective than Propiconazole. Propiconazole, on average, out performs other fungicides when mitigating yield loss.


How many trials contain all of the most studied fungicides
```{r Trials_with_top_three_Fungicides}
Tebe_trials <-
   unique(PM_MB_means[PM_MB_means$Fungicide == "Tebeconazole", ]$Trial_ref)
Propi_trials <-
   unique(PM_MB_means[PM_MB_means$Fungicide == "Propiconazole", ]$Trial_ref)
Azoxystrobin_trials <-
   unique(PM_MB_means[PM_MB_means$Fungicide == "Azoxystrobin", ]$Trial_ref)

intersect(intersect(Tebe_trials, Propi_trials)
          , Azoxystrobin_trials)



```




```{r Calculate_cuts, echo=FALSE}
# removing 2017 and control data
# this will help look at when the first application of fungicide is applied in relation to when the disease first appeared
PM_MB_means1 <- PM_MB_means %>%
   filter(Fungicide != "control") %>%
   #   filter(total_Fungicide ==1) %>%
   mutate(days_from_1st = as.numeric(
      as.Date(as.character(Fungicide_application_1), format = "%d/%m/%Y") -
         as.Date(as.character(first_sign_disease), format = "%d/%m/%Y")
   ))




days_from_fungicid <- function(FSD, F1, F2, F3) {
   dF1 <- as.numeric(as.Date(F1) - as.Date(FSD))
   dF2 <- as.numeric(as.Date(F2) - as.Date(FSD))
   dF3 <- as.numeric(as.Date(F3) - as.Date(FSD))
   if (is.na(dF1)) {
      return(NA)
   } else{
      if (between(dF1, lower = -1, upper = 1000)) {
         return(dF1)
      } else{
         if (is.na(dF2)) {
            return(dF1)
         } else{
            if (between(dF2, lower = dF1, upper = -0.1)) {
               return(dF2)
            } else{
               return(dF3)
            }
         }
      }
   }
}
vec1 <- vector()
for (i in 1:dim(PM_MB_means1)[1]) {
   dF1 <-
      as.numeric(
         as.Date(PM_MB_means1$Fungicide_application_1, format = "%d/%m/%Y")[i] -
            as.Date(PM_MB_means1$first_sign_disease, format = "%d/%m/%Y")[i]
      )
   dF2 <-
      as.numeric(
         as.Date(PM_MB_means1$Fungicide_application_2, format = "%d/%m/%Y")[i] -
            as.Date(PM_MB_means1$first_sign_disease, format = "%d/%m/%Y")[i]
      )
   dF3 <-
      as.numeric(
         as.Date(PM_MB_means1$Fungicide_application_3, format = "%d/%m/%Y")[i] -
            as.Date(PM_MB_means1$first_sign_disease, format = "%d/%m/%Y")[i]
      )
   if (is.na(dF1)) {
      vec1 <- c(vec1, dF1)
   } else{
      if (between(as.numeric(dF1), -1, 1000)) {
         vec1 <- c(vec1, dF1)
      } else{
         if (is.na(dF2)) {
            vec1 <- c(vec1, dF1)
         } else{
            if (between(as.numeric(dF2), as.numeric(dF1), -1.1)) {
               vec1 <- c(vec1, dF2)
            } else{
               if (is.na(dF3)) {
                  vec1 <- c(vec1, dF2)
               } else{
                  if (as.numeric(dF3) >= 0) {
                     vec1 <- c(vec1, dF2)
                  } else{
                     vec1 <- c(vec1, dF3)
                  }
               }
            }
         }
      }
   }
}
PM_MB_means1$spray_diff <-
   vec1 # gives the closest fungicide application date to the first sign of disease
#PM_MB_means1$days_from_1st


```

```{r Sulphur_efficacy, echo=FALSE}


# unique(
# PM_MB_means1 %>%
#    group_by(Fungicide) %>%
#    filter(n() >= 5) %>%
#    select(days_from_1st))
# 
# 
# PM_MB_means1 %>%
#    group_by(Fungicide) %>%
#    filter(n() >= 5) %>%
# ggplot(aes(prop_YG))+
#    geom_density(aes(fill = cut(spray_diff, c(-1,2,7,10,12,20))), alpha = 0.5)+
#    geom_vline(aes(xintercept = 0), size =0.5)+
#    facet_grid(rows = vars(cut(spray_diff, c(1,2,7,10,12,20))), cols = vars(Fungicide))+
#    #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
#    labs(x = "Proportion of grain yeild saved",
#    title = "Grain yield proportion saved grouped by\nwhen the first fungicide application was made\nrelative to when Powdery Mildew was first seen")+
#    theme(panel.grid.major = element_line(colour = "grey80"),
#          panel.grid.minor = element_line(colour = "grey50"),
#          panel.background = element_rect(fill = NA))+
#    guides(fill=guide_legend(title="Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease"))+
#    scale_x_continuous(limits = c(-0.2,0.55))
# 
# 

#__________________________________________________________________________________________________________
# levels(factor(PM_MB_means$Fungicide))




# combine Sulphur treatments
PM_MB_means2 <- PM_MB_means1 %>%
   filter(
      Fungicide == "Sulphur" |
         Fungicide == "Sulphur (SC)" |
         Fungicide == "Sulphur (Ultra SC)" |
         Fungicide == "Sulphur (WP)"
   )


unique(PM_MB_means2$spray_diff)


ggplot(PM_MB_means2, aes(prop_YG)) +
   geom_density(aes(fill = cut(
      PM_MB_means2$spray_diff, c(-30, -19, -15, -10, -1, 2, 7, 10, 12, 21)
   )), alpha = 0.5) +
   geom_vline(aes(xintercept = 0), size = 0.5) +
   facet_grid(cut(PM_MB_means2$spray_diff, c(-30, -19, -15, -10, -1, 2, 7, 10, 12, 21)) ~
                 .) +
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Proportion of grain yield saved",
        title = "Grain yield proportion saved grouped by\nwhen the first Sulphur fungicide application was made\nrelative to when Powdery Mildew was first seen") +
   theme(
      panel.grid.major = element_line(colour = "grey80"),
      panel.grid.minor = element_line(colour = "grey50"),
      panel.background = element_rect(fill = NA)
   ) +
   guides(
      fill = guide_legend(title = "Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease")
   ) +
   scale_x_continuous(limits = c(-0.3, 0.6))

```
This plot shows that there is not a good probability that Sulphur will help save yield, even when it is sprayed at the ideal time.

```{r each_fungicide}
Chemical <-
   c("Azoxystrobin", "Carbendazim", "Tebeconazole", "Propiconazole")
levels(factor(PM_MB_means$Fungicide))

# Generates multiple plots for each type of fungicide tested
for (Chem in Chemical) {
   PM_MB_means2 <- PM_MB_means1 %>%
      filter(Fungicide == Chem)
   
   cat(Chem)
   
   # the following code 'spray_group' sets the spray_diff groupings that are used in the plots
   spray_group <- c(min(unique(PM_MB_means2$spray_diff)) - 1,
                    -5, 5,
                    max(unique(PM_MB_means2$spray_diff)) + 1)
   
   spray_group < -c(sort(unique(PM_MB_means2$spray_diff) - 1), max(unique(PM_MB_means2$spray_diff)))
   
   print(spray_group)
   
   p1 <- ggplot(PM_MB_means2, aes(prop_YG)) +
      geom_density(aes(fill = cut(PM_MB_means2$spray_diff, spray_group)), alpha = 0.5) +
      geom_vline(aes(xintercept = 0), size = 0.5) +
      facet_grid(cut(PM_MB_means2$spray_diff, spray_group) ~ .) +
      #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
      labs(x = "Proportion of grain yield saved",
           title = "Grain yield proportion saved grouped by\nwhen the first fungicide application was made\nrelative to when Powdery Mildew was first seen") +
      theme(
         panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA)
      ) +
      guides(fill = guide_legend(
         title = paste(
            Chem,
            "Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease"
         )
      )) +
      scale_x_continuous(limits = c(-1, 1))
   
   print(p1)
   
}
```
It seems the calculation of spray diff does not elucidate any differences between application dates.







### Yield saved 
**Number of fungicide applications**
The following density plots show mean yield saved in relation to how many sprays were applied. 

```{r PA_Yield, warning=FALSE, echo=FALSE}

# Making a table of showing the upper and lower percentiles (95%)
quant_PMy <- PM_MB_means %>%
   filter(fungicide != "control") %>%
   group_by(total_fungicide) %>%
   summarise(
      n = length(yield_gain),
      lower_2.5 = quantile(yield_gain, na.rm = T, c(0.025)),
      median = median(yield_gain, na.rm = T),
      mean = mean(yield_gain, na.rm = T),
      upper_97.5 = quantile(yield_gain, na.rm = T, c(0.975))
   )

# Density plot of Number of fungicide applications and the resulting yeild saved (as a proportion)
ggplot(subset(PM_MB_means, fungicide != "control"), aes(yield_gain)) +
   geom_density(aes(
      group = factor(total_fungicide),
      fill = factor(total_fungicide)
   ), alpha = 0.6) +
   geom_vline(xintercept = 0, size = 1) +
   labs(x = "Grain yield saved (t/ha)",
        title = "Density plot of grain yield saved from differing numbers of fungicide applications") +
   theme(
      panel.grid.major = element_line(colour = "grey80"),
      panel.grid.minor = element_line(colour = "grey50"),
      panel.background = element_rect(fill = NA)
   ) +
   geom_vline(
      data = quant_PMy,
      aes(xintercept = lower_2.5,
          colour = factor(total_fungicide)),
      size = 0.9,
      linetype =  "dashed"
   ) +
   geom_vline(
      data = quant_PMy,
      aes(xintercept = upper_97.5,
          colour = factor(total_fungicide)),
      size = 0.9,
      linetype =  "dashed"
   ) +
   guides(
      colour = guide_legend(title = "Upper (97.5%) and \nLower (2.5%) percentiles"),
      fill = guide_legend(title = "Number of \nFungicide applications")
   ) +
   scale_x_continuous(limits = c(-0.3, 0.8))

kable(quant_PMy,
      caption = "Yield gain for each number of fungicide applications") %>%
   kable_styling(fixed_thead = T, full_width = T)





# Making a table of showing the upper and lower percentiles (95%)
quant_PM <- PM_MB_means %>%
   filter(Fungicide != "control") %>%
   group_by(total_Fungicide) %>%
   summarise(
      lower_2.5 = quantile(prop_YG, na.rm = T, c(0.025)),
      median = median(prop_YG, na.rm = T),
      mean = mean(prop_YG, na.rm = T),
      upper_97.5 = quantile(prop_YG, na.rm = T, c(0.975))
   )




# Density plot of proportion of yield saved
ggplot(subset(PM_MB_means, Fungicide != "control"), aes(prop_YG)) +
   geom_density(aes(
      group = factor(total_Fungicide),
      fill = factor(total_Fungicide)
   ), alpha = 0.6) +
   geom_vline(xintercept = 0, size = 1) +
   labs(x = "Proportion of grain yield saved",
        title = "Density plot of the grain yield proportion saved \n by the number of fungicide applications") +
   theme(
      panel.grid.major = element_line(colour = "grey80"),
      panel.grid.minor = element_line(colour = "grey50"),
      panel.background = element_rect(fill = NA)
   ) +
   geom_vline(
      data = quant_PM,
      aes(xintercept = lower_2.5,
          colour = factor(total_Fungicide)),
      size = 0.9,
      linetype =  "dashed"
   ) +
   geom_vline(
      data = quant_PM,
      aes(xintercept = upper_97.5,
          colour = factor(total_Fungicide)),
      size = 0.9,
      linetype =  "dashed"
   ) +
   guides(
      colour = guide_legend(title = "Upper (97.5%) and \nLower (2.5%) percentiles"),
      fill = guide_legend(title = "Number of \nFungicide applications")
   ) +
   scale_x_continuous(limits = c(-0.3, 0.55))



kable(quant_PM,
      caption = "Proportion of yield gain for each number of fungicide applications") %>%
   kable_styling(fixed_thead = T, full_width = T)
#knitr::kable(quant_PM,
#             col.names = c("Number of sprays", "2.5 percentile", "97.5 percentile"))
#caption = "The 'upper' and 'lower' percentiles for proportion of yeild saved against the number of Fungicide sprays in a season. Data from 2011-2017 mungbean experimental means. Data ignores factors such as fungicide, dose, season or location of experiment")
```

\n\n\n\n\n\n\n

#### Timing of Fungicide application
The following density plots show mean yield saved (t / Ha) or proportion yield saved in relation to when the first fungicide spray was applied in relation to when powdery mildew was first seen in the mungbean crop.

```{r eval = FALSE, message = FALSE, warning = FALSE, include = FALSE}
PM_MB_means %>%
   filter(Fungicide != "control") %>%
   #   filter(total_Fungicide ==1) %>%
   mutate(days_from_1st = as.numeric(
      as.Date(as.character(Fungicide_application_1), format = "%d/%m/%Y") -
         as.Date(as.character(first_sign_disease), format = "%d/%m/%Y")
   ))

```



```{r spray_timing&PropYield}
# What range of
unique(PM_MB_means1$days_from_1st)
PM_MB_means1 %>%
   group_by(cut(
      PM_MB_means1$days_from_1st,
      c(-41, -20, -15, -12, -0.5, 1.5, 7, 10, 12, 20)
   )) %>%
   summarise(
      n = length(prop_YG),
      lower_2.5 = quantile(prop_YG, na.rm = T, c(0.025)),
      median = median(prop_YG, na.rm = T),
      mean = mean(prop_YG, na.rm = T),
      upper_97.5 = quantile(prop_YG, na.rm = T, c(0.975))
   ) %>%
   kable(caption = "Difference in days between first sign of disease and first fungicide application and the effect on proportion of yield gain") %>%
   kable_styling(fixed_thead = T, full_width = T)



ggplot(PM_MB_means1, aes(prop_YG)) +
   geom_density(aes(fill = cut(
      PM_MB_means1$days_from_1st,
      c(-41, -20, -15, -12, -0.5, 1.5, 7, 10, 12, 20)
   )), alpha = 0.5) +
   geom_vline(aes(xintercept = 0), size = 0.5) +
   facet_grid(cut(
      PM_MB_means1$days_from_1st,
      c(-41, -20, -15, -12, -0.5, 1.5, 7, 10, 12, 20)
   ) ~ .) +
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Proportion of grain yield saved",
        title = "Grain yield proportion saved grouped by\nwhen the first fungicide application was made\nrelative to when Powdery Mildew was first seen") +
   theme(
      panel.grid.major = element_line(colour = "grey80"),
      panel.grid.minor = element_line(colour = "grey50"),
      panel.background = element_rect(fill = NA)
   ) +
   guides(
      fill = guide_legend(title = "Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease")
   ) +
   scale_x_continuous(limits = c(-0.2, 0.55))
```



We need to also define the relationship between yield loss and disease severity. When exploring this data we should look primarily at the no spray control plots

```{r yield_x_PMseverity}

PM_MB_means %>%
   filter(fungicide == "control") %>%
   ggplot(aes(x = PM_final_severity, y = grain_yield.t.ha.)) +
   geom_point()+
   geom_smooth(method = "lm")

PM_MB_means %>%
   ggplot(aes(x = PM_final_severity, y = prop_YG)) +
   geom_point()+
   geom_smooth(method = "lm")

```


