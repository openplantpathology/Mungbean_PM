# Preliminary Analysis

```{r PA_Libraries}
library(dplyr)
library(openxlsx)
library(kableExtra)
library(ggplot2)
library(devtools)
library(lme4)
library(theme.usq)
#source("./getPPD2.R")

```



### Yield saved from fungicide applications  

The data plotted below are from the past field trials (2011 - 2017) described in the aforementioned table. All data are a list of mean values from each treatment applied in each experiment. Various factors have been studied in the previous experiments which may influence the following results. The following variables were disregarded in the plots below.

   1) Fungicide type
   2) Fungicide dose
   3) row spacing
   4) Host cultivars
   5) Experiment location
   6) Final disease rating

```{r echo=FALSE, message=FALSE, warning=FALSE, include= FALSE}
# Import data
PM_MB_means <- read.csv("data/1902 powdery mildew-Mungbean - Collated means.csv")
colnames(PM_MB_means)
PM_MB_means$Fungicide_application_1[as.character(PM_MB_means$Fungicide_application_1) == ""] <- NA
PM_MB_means$Fungicide_application_2[as.character(PM_MB_means$Fungicide_application_2) == ""] <- NA
PM_MB_means$Fungicide_application_3[as.character(PM_MB_means$Fungicide_application_3) == ""] <- NA
PM_MB_means$Fungicide_application_4[as.character(PM_MB_means$Fungicide_application_4) == ""] <- NA
PM_MB_means$Fungicide_application_5[as.character(PM_MB_means$Fungicide_application_5) == ""] <- NA
PM_MB_means$Fungicide_application_6[as.character(PM_MB_means$Fungicide_application_6) == ""] <- NA
PM_MB_means$Fungicide_application_7[as.character(PM_MB_means$Fungicide_application_7) == ""] <- NA



# Which row spacing leads to the higher disease severity
PM_MB_means %>%
   filter(Year >= 2017)%>%
   filter(Fungicide == "control") %>%
ggplot(aes(y = PM_final_severity, x = row_spacing, colour = Location))+
   geom_point()+
   geom_smooth()+
   scale_y_continuous(limits = c(-5,15))+
   theme_usq()


# Which row spacing leads to the higher yeild potential
PM_MB_means %>%
   filter(Year >= 2017)%>%
#   filter(Fungicide == "control") %>%
ggplot(aes(y = as.numeric(grain_yield.t.ha.), x = row_spacing, colour = Location))+
   geom_jitter(width = 0.01)+
   geom_smooth()+
#   scale_y_continuous(limits = c(-5,15))+
   theme_usq()



```



### Yield saved 
**Number of fungicide applications**
The following density plots show mean yield saved in relation to how many sprays were applied. 

```{r PA_Yield, warning=FALSE, echo=FALSE}


# Making a table of showing the upper and lower percentiles (95%)
quant_PMy <- PM_MB_means %>%
   filter(Fungicide != "control") %>%
   group_by(total_Fungicide) %>%
   summarise(n = length(yield_gain),
             lower_2.5 = quantile(yield_gain, na.rm = T, c(0.025)),
             median = median(yield_gain, na.rm = T),
             mean = mean(yield_gain, na.rm = T),
             upper_97.5 = quantile(yield_gain, na.rm = T, c(0.975)))

# Density plot of Number of fungicide applications and the resulting yeild saved (as a proportion)
ggplot(subset(PM_MB_means,Fungicide != "control"), aes(yield_gain))+
   geom_density(aes(group = factor(total_Fungicide), fill = factor(total_Fungicide)), alpha = 0.6)+
   geom_vline(xintercept = 0, size =1)+
   labs(x = "Grain yeild saved (t/ha)",
   title = "Density plot of grain yield saved from differing numbers of fungicide applications")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   geom_vline(data = quant_PMy, aes(xintercept = lower_2.5, 
               colour = factor(total_Fungicide)),size =0.9, linetype =  "dashed")+
   geom_vline(data = quant_PMy, aes(xintercept = upper_97.5, 
               colour = factor(total_Fungicide)),size =0.9, linetype =  "dashed")+
   guides(colour = guide_legend(title="Upper (97.5%) and \nLower (2.5%) percentiles"),
          fill=guide_legend(title="Number of \nFungicide applications"))+
   scale_x_continuous(limits = c(-0.3,0.8))
   
kable(quant_PMy,
   caption = "Yeild gain for each number of fungicide applications") %>%
   kable_styling(fixed_thead = T, full_width = T)





# Making a table of showing the upper and lower percentiles (95%)
quant_PM <- PM_MB_means %>%
   filter(Fungicide != "control") %>%
   group_by(total_Fungicide) %>%
   summarise(lower_2.5 = quantile(prop_YG, na.rm = T, c(0.025)),
             median = median(prop_YG, na.rm = T),
             mean = mean(prop_YG, na.rm = T),
             upper_97.5 = quantile(prop_YG, na.rm = T, c(0.975)))




# Density plot of proportion of yield saved
ggplot(subset(PM_MB_means,Fungicide != "control"), aes(prop_YG))+
   geom_density(aes(group = factor(total_Fungicide), fill = factor(total_Fungicide)), alpha = 0.6)+
   geom_vline(xintercept = 0, size =1)+
   labs(x = "Proportion of grain yeild saved",
   title = "Density plot of the grain yield proportion saved \n by the number of fungicide applications")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   geom_vline(data = quant_PM, aes(xintercept = lower_2.5, 
               colour = factor(total_Fungicide)),size =0.9, linetype =  "dashed")+
   geom_vline(data = quant_PM, aes(xintercept = upper_97.5, 
               colour = factor(total_Fungicide)),size =0.9, linetype =  "dashed")+
   guides(colour = guide_legend(title="Upper (97.5%) and \nLower (2.5%) percentiles"),
          fill=guide_legend(title="Number of \nFungicide applications"))+
   scale_x_continuous(limits = c(-0.3,0.55))
   


kable(quant_PM,
   caption = "Proportion of yeild gain for each number of fungicide applications") %>%
   kable_styling(fixed_thead = T, full_width = T)   
#knitr::kable(quant_PM, 
#             col.names = c("Number of sprays", "2.5 percentile", "97.5 percentile"))
             #caption = "The 'upper' and 'lower' percentiles for proportion of yeild saved against the number of Fungicide sprays in a season. Data from 2011-2017 mungbean experimental means. Data ignores factors such as fungicide, dose, season or location of experiment")
```

\n\n\n\n\n\n\n

#### Timing of Fungicide application
The following density plots show mean yield saved (t/Ha) or proportion yield saved in relation to when the first fungicide spray was applied in relation to when powdery mildew was first seen in the mungbean crop.  

```{r echo = FALSE, message=FALSE, warning=FALSE}
# removing 2017 and control data
# this will help look at when the first application of fungicide is applied in relation to when the disease first appeared
PM_MB_means1 <- PM_MB_means %>%
   filter(Fungicide != "control") %>%
#   filter(total_Fungicide ==1) %>%
   mutate(days_from_1st = as.numeric(
      as.Date(as.character(Fungicide_application_1), format = "%d/%m/%Y") -
         as.Date(as.character(first_sign_disease), format = "%d/%m/%Y")))


# What range of 
unique(PM_MB_means1$days_from_1st)
PM_MB_means1 %>%
   group_by(cut(PM_MB_means1$days_from_1st, c(-41,-20,-15,-12,-0.5,1.5,7,10,12,20))) %>%
   summarise(n = length(prop_YG),
             lower_2.5 = quantile(prop_YG, na.rm = T, c(0.025)),
             median = median(prop_YG, na.rm = T),
             mean = mean(prop_YG, na.rm = T),
             upper_97.5 = quantile(prop_YG, na.rm = T, c(0.975))) %>%
   kable(caption = "Difference in days between first sign of disease and first fungicide application and the effect on proportion of yield gain") %>%
   kable_styling(fixed_thead = T, full_width = T)

summarise()
levels(cut(PM_MB_means1$days_from_1st, c(-41,-20,-15,-12,-0.5,1.5,7,10,12,20)))


ggplot(PM_MB_means1, aes(prop_YG))+
   geom_density(aes(fill = cut(PM_MB_means1$days_from_1st, c(-41,-20,-15,-12,-0.5,1.5,7,10,12,20))), alpha = 0.5)+
   geom_vline(aes(xintercept = 0), size =0.5)+
   facet_grid(cut(PM_MB_means1$days_from_1st, c(-41,-20,-15,-12,-0.5,1.5,7,10,12,20))~.)+
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Proportion of grain yeild saved",
   title = "Grain yield proportion saved grouped by\nwhen the first fungicide application was made\nrelative to when Powdery Mildew was first seen")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   guides(fill=guide_legend(title="Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease"))+
   scale_x_continuous(limits = c(-0.2,0.55))
```






```{r}
# removing 2017 and control data
# this will help look at when the first application of fungicide is applied in relation to when the disease first appeared
PM_MB_means1 <- PM_MB_means %>%
   filter(Fungicide != "control") %>%
   filter(Year != 2017) %>%
#   filter(total_Fungicide ==1) %>%
   mutate(days_from_1st = as.numeric(as.Date(Fungicide_application_1) - first_sign_disease))
colnames(PM_MB_means)
days_from_fungicid <- function(FSD,F1,F2,F3){
   dF1 <- as.numeric(as.Date(F1) - as.Date(FSD))
   dF2 <- as.numeric(as.Date(F2) - as.Date(FSD))
   dF3 <- as.numeric(as.Date(F3) - as.Date(FSD))
   if(is.na(dF1)){
      return(NA)} else{
   if(between(dF1,lower = -1, upper = 1000)){
      return(dF1)}else{
   if(is.na(dF2)){
      return(dF1)}else{
      if(between(dF2,lower = dF1, upper = -0.1)){
            return(dF2)} else{
               return(dF3)}}
            }}
}
vec1<- vector()
for(i in 1:dim(PM_MB_means1)[1]){
   dF1 <- as.numeric(as.Date(PM_MB_means1$Fungicide_application_1)[i] - as.Date(PM_MB_means1$first_sign_disease)[i])
   dF2 <- as.numeric(as.Date(PM_MB_means1$Fungicide_application_2)[i] - as.Date(PM_MB_means1$first_sign_disease)[i])
   dF3 <- as.numeric(as.Date(PM_MB_means1$Fungicide_application_3)[i] - as.Date(PM_MB_means1$first_sign_disease)[i])
   if(is.na(dF1)){
      vec1 <- c(vec1,dF1)} else{
         if(between(as.numeric(dF1),-1, 1000)){
            vec1 <- c(vec1,dF1)}else{
               if(is.na(dF2)){
                  vec1 <- c(vec1,dF1)}else{
                     if(between(as.numeric(dF2),as.numeric(dF1), -1.1)){
            vec1 <- c(vec1,dF2)} else{
               if(as.numeric(dF3)>=0){
                  vec1 <- c(vec1,dF2)} else{
                     vec1 <- c(vec1,dF3)}}}
            }}
}
PM_MB_means1$spray_diff <- vec1 # gives the 
PM_MB_means1$days_from_1st
```












#### Effect of Fungicide 
**on proportional yield gain with repect to time of application**
##### Tebeconazole
```{r}
PM_MB_means1 %>%
   group_by(Fungicide) %>%
   filter(n() >= 5) %>% # remove any fungicide groups with less than 5 observations
   summarise(n = length(prop_YG),
             lower_2.5 = quantile(prop_YG, na.rm = T, c(0.025)),
             median = median(prop_YG, na.rm = T),
             mean = mean(prop_YG, na.rm = T),
             upper_97.5 = quantile(prop_YG, na.rm = T, c(0.975))) %>%
   kable(caption = "Fungicide effect on proportion of yield gain") %>%
   kable_styling(fixed_thead = T, full_width = T)

unique(
PM_MB_means1 %>%
   group_by(Fungicide) %>%
   filter(n() >= 5) %>%
   select(days_from_1st))


PM_MB_means1 %>%
   group_by(Fungicide) %>%
   filter(n() >= 5) %>%
ggplot(aes(prop_YG))+
   geom_density(aes(fill = cut(PM_MB_means2$spray_diff, c(-1,2,7,10,12,20))), alpha = 0.5)+
   geom_vline(aes(xintercept = 0), size =0.5)+
   facet_grid(cut(PM_MB_means2$spray_diff, c(1,2,7,10,12,20))~.)+
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Proportion of grain yeild saved",
   title = "Grain yield proportion saved grouped by\nwhen the first fungicide application was made\nrelative to when Powdery Mildew was first seen")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   guides(fill=guide_legend(title="Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease"))+
   scale_x_continuous(limits = c(-0.2,0.55))
#__________________________________________________________________________________________________________
levels(factor(PM_MB_means$Fungicide))
PM_MB_means2 <- PM_MB_means1 %>%
   filter(Fungicide == "Sulphur" |
             Fungicide == "Sulphur (SC)" |
             Fungicide == "Sulphur (Ultra SC)" |
             Fungicide == "Sulphur (WP)")
unique(PM_MB_means2$spray_diff)
ggplot(PM_MB_means2, aes(prop_YG))+
   geom_density(aes(fill = cut(PM_MB_means2$spray_diff, c(-30,-19,-15,-10,-1,2,7,10,12,21))), alpha = 0.5)+
   geom_vline(aes(xintercept = 0), size =0.5)+
   facet_grid(cut(PM_MB_means2$spray_diff, c(-30,-19,-15,-10,-1,2,7,10,12,21))~.)+
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Proportion of grain yeild saved",
   title = "Grain yield proportion saved grouped by\nwhen the first fungicide application was made\nrelative to when Powdery Mildew was first seen")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   guides(fill=guide_legend(title="Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease"))+
   scale_x_continuous(limits = c(-0.3,0.6))
Chemical <- c("Amistar","Carbendazim","Tebeconazole", "propiconazole")
levels(factor(PM_MB_means$Fungicide))
for(Chem in Chemical){
PM_MB_means2 <- PM_MB_means1 %>%
   filter(Fungicide == Chem)
cat(Chem)
cat(unique(PM_MB_means2$spray_diff))
p1 <- ggplot(PM_MB_means2, aes(prop_YG))+
   geom_density(aes(fill = cut(PM_MB_means2$spray_diff, c(-50,-17,-16,-10,-9,-2.5,-2,2,2.5,9,10,16,17,30))), alpha = 0.5)+
   geom_vline(aes(xintercept = 0), size =0.5)+
   facet_grid(cut(PM_MB_means2$spray_diff, c(-50,-17,-16,-10,-9,-2.5,-2,2,2.5,9,10,16,17,30))~.)+
   #scale_fill_discrete(labels = c("15-7 days before","same day","one day after","8-9 days after","13-19 days after"))+
   labs(x = "Proportion of grain yeild saved",
   title = "Grain yield proportion saved grouped by\nwhen the first fungicide application was made\nrelative to when Powdery Mildew was first seen")+
   theme(panel.grid.major = element_line(colour = "grey80"),
         panel.grid.minor = element_line(colour = "grey50"),
         panel.background = element_rect(fill = NA))+
   guides(fill=guide_legend(title=paste(Chem,"Days (binned)\nfirst spray \nwas applied\nrelative to\nFirst sign of disease")))+
   scale_x_continuous(limits = c(-0.3,0.6))
print(p1)
Sys.sleep(10)
}
```