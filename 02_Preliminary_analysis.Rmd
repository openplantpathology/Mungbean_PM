# Preliminary Analysis

```{r PA_Libraries, include=FALSE, message=FALSE}
if (!require("pacman"))
   install.packages("pacman")
pacman::p_load(tidyverse,
               lubridate,
               bomrang,
               openxlsx,
               devtools,
               reshape2,
               lme4,
               kableExtra,
               here)

if (!require("theme.usq"))
   devtools::install_github("adamhsparks/theme.usq")
library(theme.usq)
theme_set(theme_usq()
)
load("cache/ImportDataAndSelectTrials01.Rdata")
```

## Explore and Visualise Data  

The data explored in the `PM_MB_dat` data frame is a list of mean values from each treatment in each respective experiment.
These preliminary analyses will describe the data and then investigate any change in mungbean yields which is attributable to the fungicide treatment.  

### Descriptive statistics  
#### Spatio-temporal variation  

Lets look at how many trials were undertaken each season  

```{r FinalTrialsForInclusion1}
tmp1 <- PM_MB_dat %>%
   filter(fungicide_ai == "tebuconazole" |
             fungicide_ai == "propiconazole")%>%
   distinct(trial_ref, location, year)%>%
   arrange(year)
   table(tmp1$year)
```

Also the location of the trials  

```{r FinalTrialsForInclusion}
   table(tmp1$location)
```

#### Mean yield  

What is the variation in yield over all the trials (including non-DMI fungicide trials) in the no spray control and fungicide treated plots.  

```{r ControlYield_AllTrials}
PM_MB_dat %>%
   filter(fungicide_ai == "control")%>%
   summarise(mean_yield = mean(grain_yield.t.ha.),
             minimum_yield = min(grain_yield.t.ha.),
             maximum_yield = max(grain_yield.t.ha.),
             yield_stdev = sd(grain_yield.t.ha.)) %>%
   kable(align = 'c',
   caption = "Average yield statistics for no spray contol plots"
)
   
```


What is the yield variation in no spray control trials yield over only the DMI fungicide trials.  
```{r ControlYield_DMITrials}
DMITrials <- PM_MB_dat %>%
   filter(fungicide_ai == "tebuconazole" |
             fungicide_ai == "propiconazole")%>%
   distinct(trial_ref)%>%
   pull()

PM_MB_dat %>%
   filter(trial_ref %in% DMITrials)%>%
   filter(fungicide_ai == "control" )%>%
   summarise(mean_yield = mean(grain_yield.t.ha.*1000),
             minimum_yield = min(grain_yield.t.ha.*1000),
             maximum_yield = max(grain_yield.t.ha.*1000),
             yield_sterr = sd(grain_yield.t.ha.*1000)/(sqrt(length(grain_yield.t.ha.))))%>%
   kable(align = 'c',
   caption = "Average yield statistics for control plots in trials which used a DMI fungicide")
   
```

Mean yields in DMI fungicide treated plots
```{r Yield_DMITrials}
PM_MB_dat %>%
   filter(fungicide_ai == "tebuconazole" |
             fungicide_ai == "propiconazole")%>%
   summarise(mean_yield = mean(grain_yield.t.ha.*1000),
             minimum_yield = min(grain_yield.t.ha.*1000),
             maximum_yield = max(grain_yield.t.ha.*1000),
             yield_sterr = sd(grain_yield.t.ha.*1000)/(sqrt(length(grain_yield.t.ha.))))%>%
   kable(align = 'c',
   caption = "Average yield statistics for DMI fungicide treated plots")
   
```


Lets look at the yield gains in each trial compared to the no spray control, we will also calculate the proportional grain yield gains.

```{r Calculate_yield-savings}
for (i in unique(PM_MB_dat$trial_ref)) {
   # Loop code over each trial reference
   dat1 <- PM_MB_dat[PM_MB_dat$trial_ref == i, ]
   
   if (any(is.na(unique(dat1$row_spacing)))) {
      # If there is no recorded row.spacing don't calculate proportional yield, skip to the next trial
      warning(
         unique(dat1$trial_ref),
         " at ",
         unique(dat1$location),
         " in year ",
         unique(dat1$year),
         " has unknown row.spacing (NA)\n 'yield_gain' and 'proportional yield gain' not calculated\n"
      )
      next()
   }
   
   for (j in unique(dat1$row_spacing)) {
      # Loop within trial row_spacing
      dat2 <- dat1[dat1$row_spacing == j, ]
      controlY <-
         mean(dat2[dat2$fungicide_ai == "control", "grain_yield.t.ha."]) #Mean taken as some trials had multiple control reps
      
      # Calculate the yield gain relative to the no spray control (controlY)
      dat2$yield_gain <- dat2$grain_yield.t.ha. - controlY
      dat2$prop_YG <- dat2$yield_gain  /  controlY
      
      # insert NA as yeild_gain and proportional yield gain for the controls
      dat2[dat2$fungicide_ai == "control", c("yield_gain", "prop_YG")] <-
         NA
      
      # Reassign values to row_spacing subset
      dat1[dat1$row_spacing == j, ] <- dat2
   }
   # Reassign values to trial_ref subset
   PM_MB_dat[PM_MB_dat$trial_ref == i, ] <- dat1
}

# ____________________________________________
# calculate yield gain and prop_yield gain for experiments with no row spacing data
dat1 <- PM_MB_dat[PM_MB_dat$trial_ref == "AM1303", ]

controlY <-
   mean(dat1[dat1$fungicide_ai == "control", "grain_yield.t.ha."])

dat1$yield_gain <- dat1$grain_yield.t.ha. - controlY
dat1$prop_YG <- dat1$yield_gain / controlY
dat1[dat1$fungicide_ai == "control", c("yield_gain", "prop_YG")] <-
   c(NA, NA)

PM_MB_dat[PM_MB_dat$trial_ref == "AM1303", ] <- dat1
```

Lets show the yield gains in each trial as a table and plot
```{r YieldGain_table}
PM_MB_dat %>%
   filter(trial_ref %in% DMITrials)%>%  # selects only the trials with DMI fungicide treatments
   filter(fungicide_ai == "tebuconazole" |
             fungicide_ai == "propiconazole")%>%
   group_by(trial_ref, location, year)%>%
   summarise(yield_gain_m = mean(yield_gain),
             yield_gain_se = sd(yield_gain, na.rm = T)/sqrt(n()),
             yg_n = n(),
             .groups = "drop")%>%
   arrange(yield_gain_m)
```

```{r YieldGain_plot}
PM_MB_dat %>%
   filter(trial_ref %in% DMITrials)%>%  
   filter(fungicide_ai == "tebuconazole" |
             fungicide_ai == "propiconazole")%>%
   group_by(trial_ref, location, year)%>%
   summarise(yield_gain_m = mean(yield_gain),
             yield_gain_se = sd(yield_gain, na.rm = T)/sqrt(n()),
             .groups = "drop")%>%
   mutate(trial = paste(location,year,sep = "\n"))%>%
   ggplot(aes(reorder(trial, yield_gain_m), yield_gain_m))+
   geom_bar(stat = "identity")+
   geom_errorbar(width = 0.3 ,aes(ymax = yield_gain_m + yield_gain_se, 
                     ymin = yield_gain_m - yield_gain_se))+
   theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

Various factors have been studied in the previous experiments which may influence the subsequent meta-analysis.
On this page, unless stated, the following plots and analyses were made disregarding other effects.
The following factors are postulated to influence mungbean grain yield and/or powdery mildew mean plot severity.

   1 Fungicide type
   
   2 Fungicide dose (varies only slightly within some fungicide types)
   
   3 Number of fungicide sprays
   
   4 Timing of fungicide spray/s relative to first sign of disease
   
   5 Host cultivar (probably is a co-variate with season due to changing cultivars over time)
   
   6 Experiment location
   
   7 Row spacing
   
   8 Final disease rating / disease pressure
   
The data plotted below are from `r length(unique(PM_MB_dat$trial_ref))` field trials between (`r first(levels(PM_MB_dat$year))` - `r last(levels(PM_MB_dat$year))`) of which the details are described in the [Trials considered for inclusion in meta-analysis section](#Trials-considered-for-inclusion-in-meta-analysis). 

<br>
<br>
<br>

### Fungicides

#### Fungicide type

Before we exclude non-DMI fungicides let's have a look at the efficacy of the other fungicides in comparison to the DMIs.
For this comparison we will focus on the proportional yield saved, relative to the no spray control.
The primary focus of this research is the effect of fungicide on mitigating yield loss due to disease.
We are using proportional yield, relative to the no spray control, to reduce the effect of location and seasonal influences.  

```{r Fungicide_x_nSprays_tble2, message=FALSE}
PM_MB_dat %>%
   group_by(fungicide_ai, total_fungicide) %>%
   summarise(
      n = length(prop_YG),
      lower_2.5 = quantile(prop_YG, na.rm = T, c(0.025)),
      median = median(prop_YG, na.rm = T),
      mean = mean(prop_YG, na.rm = T),
      upper_97.5 = quantile(prop_YG, na.rm = T, c(0.975))
   ) %>%
   filter(n >= 5) %>% # remove any fungicide groups with less than 5 observations
   arrange(desc(median)) %>%
   kable(
      caption = "Fungicide effect on proportion of yield gain.",
      col.names = c(
         "Fungicide active ingredient",
         "Total fungicide applications",
         "n Treatments",
         "2.5% quartile",
         "Median proportional grain yield",
         "Mean proportional grain yield",
         "97.5 % quartile"
      ),
      align = "c"
   ) %>%
   kable_styling(fixed_thead = T, full_width = T) %>%
   column_spec(c(2, 3), width = "1cm") %>%
   footnote(general = "Fungicides with less than five observations were omitted from this table")
```

<br>
<br>
<br>


Let's visualise this in a plot for one and two sprays only.

```{r Fungicide_x_nSprays_tble1, message=FALSE, warning=FALSE}
PM_MB_dat %>%
   mutate(fungicide_ai = as.factor(PM_MB_dat$fungicide_ai)) %>%
   filter(total_fungicide == 1 | total_fungicide == 2) %>%
   filter(
      fungicide_ai != "pyrazophos" &
         fungicide_ai != "control" &
         fungicide_ai != "benomyl" &
         fungicide_ai != "Acibenzolar-S-methyl"
   ) %>%
   mutate(fungicide_ai = factor(
      fungicide_ai,
      levels = c(
         "carbendazim",
         "pyraclostrobin",
         "sulphur",
         "200 g/L azoxystrobin + 80 g/L cyproconazole",
         "tebuconazole",
         "propiconazole",
         "200 g/L tebuconazole + 120 g/L azoxystrobin"
      )
   )) %>%
   ggplot(aes(y = prop_YG, x = fungicide_ai)) +
   facet_grid(rows = vars(total_fungicide)) +
   geom_boxplot(aes(fill = fungicide_ai)) +
   geom_hline(aes(yintercept = 0), size = 0.5) +
   labs(y = "Proportion of grain yield saved",
        title = "Grain yield proportion saved\nfaceted by number of sprays") +
   theme(legend.position = "none") +
   scale_fill_usq() +
   coord_flip()
```

There is a small yield effect among the strobilurin fungicide mixes and the DMI fungicides. 
While there is some differences in the variation between tebuconazole and propiconazole, the medians are very similar. 
I think it is safe to combine these fungicides, with the same mode of action in the meta-analysis.
The follow-up spray seems to show an increase in yield protection.

*****

#### Fungicide Doses{#fungicide-doses}  
From this point on we will investigate only the DMI fungicides, tebuconazole and propiconazole, and disregard all other fungicide modes-of-action.

We should check that all fungicide doses that were used were roughly the same, if we are to compare between trials where dose might be different.

```{r tebuAndPropi_dose}
PM_MB_dat %>%
   filter(fungicide_ai == "tebuconazole" |
             fungicide_ai == "propiconazole") %>%
   select(
      trial_ref,
      year,
      location,
      first_sign_disease,
      fungicide_ai,
      dose_ai.ha,
      total_fungicide
   ) %>%
   ggplot(aes(x = as.factor(dose_ai.ha), fill = fungicide_ai)) +
   xlab("Dose (g ai/ha)") +
   ggtitle(label = "Total number of treatments for each respective tebuconazole\nor propiconazole dose") +
   geom_bar() +
   scale_fill_usq() +
   scale_colour_usq()
```

All trials that used tebuconazole used approximately the same dose.
Dose of the active ingredient ranged from 62.35&nbsp;g per hectare to 60&nbsp;g per hectare.

Doses for propiconazole range from 62.5 to 125, a large variation.
Let's inspect the difference in yields for each dose.

```{r PropiDoseEffect}
PM_MB_dat %>%
   filter(fungicide_ai == "propiconazole") %>%
   ggplot(aes(x = relevel(as.factor(dose_ai.ha), "62.5"), y = prop_YG)) +
   xlab("Dose (g ai/ha)") +
   ggtitle(label = "Yield for each respective propiconazole dose,\nfaceted by number of applications") +
   geom_boxplot(fill = usq_cols("usq charcoal"), alpha = 0.5) +
   ylab("Yield gain proportially\nto the no spray control") +
   facet_grid(cols = vars(total_fungicide))
```

This dose effect should be acknowledged in the meta-analysis.
How many treatments of each dose have been investigated per trial?

```{r table_PropiDoses}
table(as.character(PM_MB_dat[PM_MB_dat$fungicide_ai == "propiconazole",]$trial_ref),
      PM_MB_dat[PM_MB_dat$fungicide_ai == "propiconazole",]$dose_ai.ha)
```

One trial show both doses were applied in the same trial, and mung1112/02.

*****

#### Number of fungicide sprays  

Let's look at the frequency of sprays per fungicide.  
```{r Fungicide_x_nSprays}
table(PM_MB_dat$fungicide_ai, PM_MB_dat$total_fungicide)
```

This table shows that the majority of treatments inspected one and two spray management practices.

*****

#### Timing of fungicide sprays  
The timing of fungicide application can be crucial for maximum disease control and yield loss mitigation. 
The experiments all relied on natural infection and thus infection at a standardised crop maturity stage was not possible. 
To best estimate the effect of fungicide application timing we will use the day when the disease was first found in the field as a reference.
The first sign of disease is a useful reference as it can be assessed with little training for the assessor.

First let's make a plot to visualise when one or more spray management regimes were made in relation to the first sign of disease regardless of fungicide active. 
The plot is faceted by number of spray applications.

```{r spray_relative2FS}
PM_MB_dat %>%
   mutate(
      s1_DfromFS = fungicide_application_1 - first_sign_disease,
      s2_DfromFS = fungicide_application_2 - first_sign_disease,
      s3_DfromFS = fungicide_application_3 - first_sign_disease,
      s4_DfromFS = fungicide_application_4 - first_sign_disease,
      s5_DfromFS = fungicide_application_5 - first_sign_disease
   ) %>%
   gather(
      key = spray,
      value = n_days,
      s1_DfromFS,
      s2_DfromFS,
      s3_DfromFS,
      s4_DfromFS,
      s5_DfromFS
   ) %>%
   drop_na(n_days) %>%
   ggplot(aes(x = spray, y = as.numeric(n_days))) +
   geom_violin() +
   scale_x_discrete(labels = c(
      "First spray",
      "Second spray",
      "Third spray",
      "Fourth spray",
      "Fifth spray"
   )) +
   ylab("Number of days after or before first sign of powdery mildew") +
   ggtitle("Fungicide application timing relative to First Sign of Disease.\n - Faceted by number of applications")+
   facet_grid(cols = vars(total_fungicide)) +
   coord_flip()
```

The plot shows single fungicide applications are mostly made at zero, first sign of disease in the crop. Some were made earlier and some around 10 days later.  
Experiments that tested two spray treatments also tend to make the first application at first sign of disease, and the second spray between 10 and 25 days later.
Three spray treatments seemed to be mostly used in experiments where preventative sprays as the first fungicide application were made.

*****

### Mungbean cultivars

Australian mungbean varieties have the following resistance to powdery mildew.

   - Berken: Highly susceptible
   
   - Crystal: Susceptible
   
   - Jade: Moderately susceptible

Let's view a stacked bar plot of the number of sprays for both demethylation inhibitors, tebuconazole and propiconazole against each cultivar.

```{r Host_genotype}
PM_MB_dat %>%
   filter(fungicide_ai == "tebuconazole" |
             fungicide_ai == "propiconazole") %>%
   group_by(host_genotype, fungicide_ai, trial_ref) %>%
   summarise() %>%
   count() %>%
   rename(Treatments = n) %>%
   ggplot(aes(x = host_genotype, y = Treatments, fill = fungicide_ai)) +
   xlab("Cultivar") +
   ylab("N Trials") +
   ggtitle(label = "Cultivars used in either tebuconazole or propiconazole trials") +
   geom_col() +
   scale_fill_usq(name = "Fungicide AI")
```


### Row spacing  

Some experiments were designed to investigate the effect of row spacing and plant density on powdery mildew disease as well as fungicide timing and efficacy.
The results showed that the row spacing had no statistically significant effect on powdery mildew, but narrower rows in most cases increased yield significantly.
This finding has also been shown by several other researchers' work in Queensland and New South Wales as well.
Eight trials used a row spacing of 0.75&nbsp;meters and tebuconazole as an active ingredient (AI).

```{r row_spacing.m}
PM_MB_dat %>%
   filter(fungicide_ai == "tebuconazole" |
             fungicide_ai == "propiconazole") %>%
   group_by(fungicide_ai, row_spacing, trial_ref) %>%
   summarise() %>%
   count() %>%
   rename(Trials = n) %>%
   ggplot(aes(x = as.factor(row_spacing), y = Trials)) +
   xlab("Row Spacing (m)") +
   ylab("N Trials") +
   ggtitle(label = "Trial row spacing using tebuconazole") +
   geom_col(aes(fill = fungicide_ai),
            position = "dodge") +
   scale_fill_usq(name = "Fungicide AI")
```

Let's plot the row spacing treatments for the response variables yield and disease severity.  
The main questions are:  

   * Were there any statistical differences for mungbean yield or powdery mildew severity between row spacing treatments?  
   
   * If not, can we pool certain row spacing that have no significant difference?  

Lets plot disease severity in boxplots grouped by row spacing treatment.
We are asking here, which row spacing leads to the higher disease severity? 

```{r RS_severity}
# Which row spacing leads to the higher disease severity
PM_MB_dat %>%
   filter(year == 2017 |
             year == 2018) %>%
   filter(fungicide_ai == "control") %>%
   ggplot(aes(y = PM_final_severity, x = factor(row_spacing))) +
   geom_boxplot(fill = usq_cols("usq charcoal"), alpha = 0.5) +
   ylab("Final severity rating") +
   xlab("Row spacing (m)") +
   ggtitle("Powdery mildew severity between different row spacing across all trials")
```

There is little difference here between the row spacing treatments, lets look if there is a trial location effect as disease pressure lead to varying results.  

```{r RS_severity_x_trial}
# Which row spacing leads to the higher disease severity
PM_MB_dat %>%
   filter(year == 2017 |
             year == 2018) %>%
   filter(fungicide_ai == "control") %>%
   ggplot(aes(y = PM_final_severity, x = factor(row_spacing))) +
   geom_boxplot(fill = usq_cols("usq charcoal"), alpha = 0.5) +
   facet_grid(cols = vars(location)) +
   ggtitle("Powdery mildew variation between different row spacing") +
   ylab("Final severity rating") +
   xlab("Row spacing (m)")
```

In the Wellcamp site, wider row spacing reduces PM severity, the other sites it seems there was not enough variation to make a distinction between row spacing treatments.

```{r RS_yield}
# Which row spacing leads to the higher yield potential
PM_MB_dat %>%
   filter(year == 2017 |
             year == 2018) %>%
   ggplot(aes(
      y = as.numeric(grain_yield.t.ha.),
      x = as.factor(row_spacing),
      colour = location
   )) +
   geom_jitter(width = 0.05) +
   ggtitle("Grain yield results for different row spacing at three locations") +
   xlab("Row spacing (m)") +
   ylab("Grain yield (t/ha)") +
   scale_colour_usq()
```

The plots seem to imply when yield is limited, presumably by other abiotic factors, there is no effect of row spacing on yield, like in the Hermitage trial.
However, if the average yield is more than approximately 1 t/ha then smaller row spacing has the potential to provide greater yield per hectare.

Overall row spacing may influence both powdery mildew severity and yield.
However, in the studies that were conducted, no interaction was found between row spacing, powdery mildew severity and yield.
That is, the row spacing appeared to increase yield even if the amount of powdery mildew increased and no relationship could be detected between an interaction of the three.

<br>
<br>
<br>
<br>

### Yield loss in cultivar Jade  

Mungbean Jade shows the best quantitative resistance to powdery mildew.
Based on a GRDC report by Sue Thompson [-@SueThompson2016] we want to know what the yield loss was in on cultivar Jade in the 2016 Trials.
```{r JadeYieldLoss}
PM_MB_dat %>%
   filter(year == "2016",
          host_genotype == "Jade")%>%
   mutate(Treatment = case_when(
      fungicide_ai == "control" ~ "control",
      TRUE ~ "FungicideTreated"))%>%
   group_by(location, Treatment)%>%
   summarise(trial_ref = trial_ref,
             location = location, 
             year = year,
             Yield = mean(grain_yield.t.ha., na.rm = TRUE),
             .groups = "drop")%>%
   distinct()%>%
   pivot_wider(names_from = Treatment, values_from = Yield)%>%
   mutate(Diff = FungicideTreated - control) %>%
   mutate(percent = (Diff/FungicideTreated)*100)%>%
   select(trial_ref, location, year, control, FungicideTreated,percent, Diff)

```

This sequence of graphs show that AUDPC and disease incidence tends not affect yields if the season is a low yielding season, _i.e._ lower than 1 tonne per hectare.
The higher the yield, the greater greater the influence on the disease on the yield especially if the crop is high yielding with AUDPC also being large enough to reduce yield.


### FAO mungbean data

An important consideration for why to carry out work on mungbean diseases is the value the crop provides. 
Lets pull in data from the FAOSTAT website for the area of mungbean crops harvested.

```{r FAO_data_inquiry}
beans <- read.csv(here("data/FAOSTAT_data_7-6-2020.csv"))

str(beans)

beans %>%
   filter(Item == "Beans, dry",
          Element == "Area harvested")%>%
   select(Year,Value)%>%
   ggplot(aes(y = Value, x = Year))+
   geom_point()+
   geom_smooth()

```

```{r}
save(PM_MB_dat, file = here("cache/PreliminaryData.Rdata"))
```

