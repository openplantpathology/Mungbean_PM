# Preliminary Analysis

```{r PA_Libraries, include=FALSE, message=FALSE}
if (!require("pacman"))
   install.packages("pacman")
pacman::p_load(tidyverse,
               lubridate,
               bomrang,
               openxlsx,
               devtools,
               reshape2,
               lme4,
               kableExtra,
               flextable,
               here)

if (!require("theme.usq"))
   devtools::install_github("adamhsparks/theme.usq")
library(theme.usq)
theme_set(theme_usq()
)
load("cache/ImportDataAndSelectTrials01.Rdata")
```

## Trial focused summaries  

The data explored in the `PM_MB_dat` data frame is a clean data frame focusing on trials which met the selection criteria and the treatments testing DMi fungicides (tebuconazole / propiconazole) or no spray controls. 


### Spatio-temporal variation  
#### Trial seasons
Let's look at how many trials were undertaken each season in trials including DMI fungicides.  

```{r FinalTrialsForInclusion1}
tmp1 <- PM_MB_dat %>%
   distinct(trial_ref, location, year) %>%
   arrange(year)
table(tmp1$year)
```
#### Trial locations
The location of the trials including DMI fungicides.  

```{r FinalTrialsForInclusion}
   table(tmp1$location)
```

### Full trial summary
Let's inspect a summary of both powdery mildew severity and grain yield for trials including DMI fungicides.  

```{r Full_Trial_Summary_table, warning= FALSE}
Sev_yield_table <-
   PM_MB_dat %>%
   mutate(PM_sev_control = case_when(fungicide_ai == "control" ~ PM_final_severity,
                                     TRUE ~ NA_real_)) %>%
   mutate(PM_sev_treat = case_when(fungicide_ai != "control" ~ PM_final_severity,
                                   TRUE ~ NA_real_)) %>%
   mutate(PM_y_control = case_when(fungicide_ai == "control" ~ grain_yield.t.ha.,
                                   TRUE ~ NA_real_)) %>%
   mutate(PM_y_treat = case_when(fungicide_ai != "control" ~ grain_yield.t.ha.,
                                 TRUE ~ NA_real_)) %>%
   mutate(trial_ref = str_remove(trial_ref, "mung")) %>%  # remove "mung" prefix from trial_ref
   group_by(trial_ref,
            location,
            year,
            planting_date,
            first_sign_disease) %>%
   summarise(
      n = n(),
      m_PM_sev_control = round(median(PM_sev_control, na.rm = TRUE), digits = 2),
      n_controls = sum(is.na(PM_sev_control) == FALSE),
      min_PM_sev = round(min(PM_sev_treat, na.rm = TRUE), digits = 2),
      max_PM_sev = round(max(PM_sev_treat, na.rm = TRUE), digits = 2),
      m_PM_yield_control = round(mean(PM_y_control, na.rm = TRUE), digits = 3),
      min_PM_yield = round(min(PM_y_treat, na.rm = TRUE), digits = 3),
      max_PM_yield = round(max(PM_y_treat, na.rm = TRUE), digits = 3),
      .groups = "drop"
   ) %>%
   arrange(year) %>%
   mutate(PM_sev_range = paste(min_PM_sev, max_PM_sev, sep = " - ")) %>%
   mutate(yield_range = paste(min_PM_yield, max_PM_yield, sep = " - ")) %>%
   mutate(m_PM_sev_control = paste(m_PM_sev_control, " (", n_controls, ")", sep = "")) %>%
   select(-c(min_PM_sev, max_PM_sev, min_PM_yield, max_PM_yield, n_controls)) %>%
   select(c(1:7, 9, 8, 10)) %>% # order columns
   flextable() %>%
   set_header_labels(
      trial_ref = "Trial code",
      location = "Location",
      year = "Year",
      planting_date = "Sowing date",
      first_sign_disease = "PM onset",
      n = "n",
      m_PM_sev_control = "Control median\nPM severity",
      PM_sev_range = "PM severity\nrange*",
      m_PM_yield_control = "Control\nmean yield*",
      yield_range = "Yield range\n(t / ha)"
   ) %>%
   fontsize(size = 8, part = "body") %>%
   fontsize(size = 10, part = "header") %>%
   align(j = 3:10, align = "center", part = "all") %>%
   autofit() %>%
   width(j = 7:10, width = 1) %>%
   width(j = 3, width = 0.5) %>%
   set_caption(
      "Table 1: Mean yield and severity for trials included in the meta-analysis. Powdery mildew (PM) onset, number of treatments per trial (n), PM median plot severity of the non-fungicide treated plots and the severity range in fungicide treatments, * bracketed numbers refer to the number of pooled control treatments summarised; Mean yield in non-fungicide treated control and the range of yields in the fungicide treatments in tonnes per hectare"
   )
Sev_yield_table
```

Save table to a word document to use in manuscript
```{r eval=FALSE, include=FALSE}
# Save table as a word document
doc <- officer::read_docx()
doc <- body_add_flextable(doc, value = Sev_yield_table)
doc <- officer::body_end_section_landscape(doc)
print(doc, target = "paper/figures/Table1_severity&yield.docx")
```



## Treatment focuses summaries

Various factors have been studied in the previous experiments which may influence the subsequent meta-analysis.
On this page, unless stated, the following plots and analyses were made disregarding other effects.
The following factors are postulated to influence mungbean grain yield and/or powdery mildew mean plot severity.

   1 Fungicide type
   
   2 Fungicide dose (varies only slightly within some fungicide types)
   
   3 Number of fungicide sprays
   
   4 Timing of fungicide spray/s relative to first sign of disease
   
   5 Host cultivar (probably is a co-variate with season due to changing cultivars over time)
   
   6 Experiment location
   
   7 Row spacing
   
   8 Final disease rating / disease pressure
   
The data plotted below are from `r length(unique(PM_MB_dat$trial_ref))` field trials between (`r first(levels(PM_MB_dat$year))` - `r last(levels(PM_MB_dat$year))`) of which the details are described in the [Trials considered for inclusion in meta-analysis section](#Trials-considered-for-inclusion-in-meta-analysis). 

### Fungicide type
#### Powdery mildew severity
```{r TebuVPropi_sev}
n_C <- sum(PM_MB_dat$fungicide_ai == "control")
n_P <- sum(PM_MB_dat$fungicide_ai == "propiconazole")
n_T <- sum(PM_MB_dat$fungicide_ai == "tebuconazole")

PM_MB_dat %>%
   ggplot(aes(y = PM_final_severity, x = as.factor(fungicide_ai))) +
   xlab("Fungicide treatment") +
   ggtitle(label = "Powdery mildew severity for each fungicide active ingredient") +
   labs(caption = paste("Control n:", n_C,
                        "; Propiconazole n:", n_P,
                        "; Tebuconazole n:", n_T, sep = "")) +
   geom_boxplot() +
   scale_fill_usq() +
   scale_colour_usq()
```
#### Yield effect
```{r TebuVPropi_Yi}
PM_MB_dat %>%
   ggplot(aes(y = grain_yield.t.ha., x = as.factor(fungicide_ai))) +
   xlab("Fungicide treatment") +
   ggtitle(label = "Grain yield for each fungicide active ingredient") +
   labs(caption = paste("Control n:", n_C,
                        "; Propiconazole n:", n_P,
                        "; Tebuconazole n:", n_T, sep = "")) +
   geom_boxplot() +
   scale_colour_usq()
```

### Fungicide Doses{#fungicide-doses}  
This analysis focuses only the DMI fungicides, tebuconazole and propiconazole, which were trialled the most often.

We should check that all fungicide doses that were used were roughly the same, if we are to compare between trials where dose might be different.

```{r tebuAndPropi_dose}
PM_MB_dat %>%
   filter(fungicide_ai == "tebuconazole" |
             fungicide_ai == "propiconazole") %>%
   ggplot(aes(x = as.factor(dose_ai.ha), fill = fungicide_ai)) +
   xlab("Dose (g ai/ha)") +
   ggtitle(label = "Total number of treatments for each respective tebuconazole\nor propiconazole dose") +
   geom_bar() +
   scale_fill_usq() +
   scale_colour_usq()
```

All trials that used tebuconazole used approximately the same dose.
Dose of the active ingredient ranged from 62.35&nbsp;g per hectare to 60&nbsp;g per hectare.

Doses for propiconazole range from 62.5 to 125, a large variation.
Let's inspect the difference in yields for each dose.

```{r PropiDoseEffect}
PM_MB_dat %>%
   filter(fungicide_ai == "propiconazole") %>%
   ggplot(aes(x = relevel(as.factor(dose_ai.ha), "62.5"), y = grain_yield.t.ha.)) +
   xlab("Dose (g ai/ha)") +
   labs(label = "Yield for each respective propiconazole dose",
        caption = "Facets indicate the number of applications") +
   geom_boxplot(fill = usq_cols("usq charcoal"), alpha = 0.5) +
   ylab("Grain yield t / ha") +
   facet_grid(cols = vars(total_fungicide))
```

This dose effect should be acknowledged in the meta-analysis.
How many treatments of each dose have been investigated per trial?

```{r table_PropiDoses}
table(as.character(PM_MB_dat[PM_MB_dat$fungicide_ai == "propiconazole",]$trial_ref),
      PM_MB_dat[PM_MB_dat$fungicide_ai == "propiconazole",]$dose_ai.ha)
```

One trial show both doses were applied in the same trial, and mung1112/02.

*****

#### Number of fungicide sprays  

Let's look at the frequency of sprays per fungicide.  
```{r Fungicide_x_nSprays}
table(PM_MB_dat$fungicide_ai, PM_MB_dat$total_fungicide)
```

This table shows that the majority of treatments inspected one and two spray management practices.


*****

### Mungbean cultivars

Australian mungbean varieties have the following resistance to powdery mildew.

   - Berken: Highly susceptible
   
   - Crystal: Susceptible
   
   - Jade: Moderately susceptible

Let's view a stacked bar plot of the number of sprays for both demethylation inhibitors, tebuconazole and propiconazole against each cultivar.

```{r Host_genotype}
PM_MB_dat %>%
   filter(fungicide_ai == "tebuconazole" |
             fungicide_ai == "propiconazole") %>%
   group_by(host_genotype, fungicide_ai, trial_ref) %>%
   summarise() %>%
   count() %>%
   rename(Treatments = n) %>%
   ggplot(aes(x = host_genotype, y = Treatments, fill = fungicide_ai)) +
   xlab("Cultivar") +
   ylab("N Trials") +
   ggtitle(label = "Cultivars used in either tebuconazole or propiconazole trials") +
   geom_col() +
   scale_fill_usq(name = "Fungicide AI")
```


### Row spacing  

Some experiments were designed to investigate the effect of row spacing and plant density on powdery mildew disease as well as fungicide timing and efficacy.
The results showed that the row spacing had no statistically significant effect on powdery mildew, but narrower rows in most cases increased yield significantly.
This finding has also been shown by several other researchers' work in Queensland and New South Wales as well.
Eight trials used a row spacing of 0.75&nbsp;meters and tebuconazole as an active ingredient (AI).

```{r row_spacing.m}
PM_MB_dat %>%
   filter(fungicide_ai == "tebuconazole" |
             fungicide_ai == "propiconazole") %>%
   group_by(fungicide_ai, row_spacing, trial_ref) %>%
   summarise() %>%
   count() %>%
   rename(Trials = n) %>%
   ggplot(aes(x = as.factor(row_spacing), y = Trials)) +
   xlab("Row Spacing (m)") +
   ylab("N Trials") +
   ggtitle(label = "Trial row spacing using tebuconazole") +
   geom_col(aes(fill = fungicide_ai),
            position = "dodge") +
   scale_fill_usq(name = "Fungicide AI")
```

Let's plot the row spacing treatments for the response variables yield and disease severity.  
The main questions are:  

   * Were there any statistical differences for mungbean yield or powdery mildew severity between row spacing treatments?  
   
   * If not, can we pool certain row spacing that have no significant difference?  

Let's plot disease severity in boxplots grouped by row spacing treatment.
We are asking here, which row spacing leads to the higher disease severity? 

```{r RS_severity}
# Which row spacing leads to the higher disease severity
PM_MB_dat %>%
   filter(year == 2017 |
             year == 2018) %>%
   filter(fungicide_ai == "control") %>%
   ggplot(aes(y = PM_final_severity, x = factor(row_spacing))) +
   geom_boxplot(fill = usq_cols("usq charcoal"), alpha = 0.5) +
   ylab("Final severity rating") +
   xlab("Row spacing (m)") +
   ggtitle("Powdery mildew severity between different row spacing across all trials")
```

There is little difference here between the row spacing treatments, Let's look if there is a trial location effect as disease pressure lead to varying results.  

```{r RS_severity_x_trial}
# Which row spacing leads to the higher disease severity
PM_MB_dat %>%
   filter(year == 2017 |
             year == 2018) %>%
   filter(fungicide_ai == "control") %>%
   ggplot(aes(y = PM_final_severity, x = factor(row_spacing))) +
   geom_boxplot(fill = usq_cols("usq charcoal"), alpha = 0.5) +
   facet_grid(cols = vars(location)) +
   ggtitle("Powdery mildew variation between different row spacing") +
   ylab("Final severity rating") +
   xlab("Row spacing (m)")
```

In the Wellcamp site, wider row spacing reduces PM severity, the other sites it seems there was not enough variation to make a distinction between row spacing treatments.

```{r RS_yield}
# Which row spacing leads to the higher yield potential
PM_MB_dat %>%
   filter(year == 2017 |
             year == 2018) %>%
   ggplot(aes(
      y = as.numeric(grain_yield.t.ha.),
      x = as.factor(row_spacing),
      colour = location
   )) +
   geom_jitter(width = 0.05) +
   ggtitle("Grain yield results for different row spacing at three locations") +
   xlab("Row spacing (m)") +
   ylab("Grain yield (t/ha)") +
   scale_colour_usq()
```

The plots seem to imply when yield is limited, presumably by other abiotic factors, there is no effect of row spacing on yield, like in the Hermitage trial.
However, if the average yield is more than approximately 1 t/ha then smaller row spacing has the potential to provide greater yield per hectare.

Overall row spacing may influence both powdery mildew severity and yield.
However, in the studies that were conducted, no interaction was found between row spacing, powdery mildew severity and yield.
That is, the row spacing appeared to increase yield even if the amount of powdery mildew increased and no relationship could be detected between an interaction of the three.

<br>
<br>
<br>
<br>

### Yield loss in cultivar Jade  

Mungbean Jade shows the best quantitative resistance to powdery mildew.
Based on a GRDC report by Sue Thompson [-@SueThompson2016] we want to know what the yield loss was in on cultivar Jade in the 2016 Trials.

```{r JadeYieldLoss}
PM_MB_dat %>%
   filter(year == "2016",
          host_genotype == "Jade") %>%
   mutate(Treatment = case_when(fungicide_ai == "control" ~ "control_yield",
                                TRUE ~ "FungicideTreated_yield")) %>%
   group_by(location, Treatment) %>%
   summarise(
      trial_ref = trial_ref,
      location = location,
      year = year,
      Yield = mean(grain_yield.t.ha., na.rm = TRUE),
      .groups = "drop"
   ) %>%
   distinct() %>%
   pivot_wider(names_from = Treatment, values_from = Yield) %>%
   mutate(Diff = FungicideTreated_yield - control_yield) %>%
   mutate(percent = (Diff / FungicideTreated_yield) * 100) %>%
   select(trial_ref,
          location,
          year,
          control_yield,
          FungicideTreated_yield,
          percent,
          Diff)
```

### FAO mungbean data

An important consideration for why to carry out work on mungbean diseases is the value the crop provides. 
Let's pull in data from the FAOSTAT website for the area of mungbean crops harvested.

```{r FAO_data_inquiry}
beans <- read.csv(here("data/FAOSTAT_data_7-6-2020.csv"))

str(beans)

beans %>%
   filter(Item == "Beans, dry",
          Element == "Area harvested") %>%
   select(Year, Value) %>%
   ggplot(aes(y = Value, x = Year)) +
   geom_point() +
   geom_smooth()
```

### In-crop rainfall
First an inspection of all rainfall within the season
```{r season_rainfall}
source("R/add_lat_longs.R") # code adds the latitude- and longitude to PM_MB_dat
source("R/crop_rain.R")

# Obtain rainfall from bomrang
PM_MB_dat$sum_rain <-
   apply(PM_MB_dat, 1, function(x) {
      crop_rain(
         latitude = x["lat"],
         longitude = x["lon"],
         start = x["planting_date"],
         end = x["harvest_date"]
      )
   })

# plot yield vs rainfall
PM_MB_dat %>%
   ggplot(aes(y = grain_yield.t.ha., x = sum_rain)) + 
   geom_point()
```

```{r lm_total}
summary(lm(grain_yield.t.ha. ~ sum_rain, data = PM_MB_dat))
```

```{r early_season_rain}
PM_MB_dat$early_rain <-
   apply(PM_MB_dat, 1, function(x) {
      crop_rain(
         latitude = x["lat"],
         longitude = x["lon"],
         start = x["planting_date"],
         end = x["first_sign_disease"]
      )
   })

PM_MB_dat %>%
   ggplot(aes(y = grain_yield.t.ha., x = early_rain)) + 
   geom_point()
```

```{r lm_early_rain}
summary(lm(grain_yield.t.ha. ~ early_rain, data = PM_MB_dat))
```



```{r late_rain}
PM_MB_dat$late_rain <-
   apply(PM_MB_dat, 1, function(x) {
      crop_rain(
         latitude = x["lat"],
         longitude = x["lon"],
         start = x["first_sign_disease"],
         end = x["harvest_date"]
      )
   })

PM_MB_dat %>%
   ggplot(aes(y = grain_yield.t.ha., x = late_rain)) + 
   geom_point()
```

```{r lm_late_rain}
summary(lm(grain_yield.t.ha. ~ late_rain, data = PM_MB_dat))
```


```{r mid_rain}
PM_MB_dat$mid_rain <-
   apply(PM_MB_dat, 1, function(x) {
      crop_rain(
         latitude = x["lat"],
         longitude = x["lon"],
         start = ymd(x["planting_date"]) + days(0),
         end = ymd(x["planting_date"]) + days(63)
      )
   })

PM_MB_dat %>%
   ggplot(aes(y = grain_yield.t.ha., x = mid_rain)) + 
   geom_point()
```

```{r lm_mid_rain}
summary(lm(grain_yield.t.ha. ~ mid_rain, data = PM_MB_dat))
```