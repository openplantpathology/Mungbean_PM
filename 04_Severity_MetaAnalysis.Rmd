---
output: html_document
editor_options: 
  chunk_output_type: inline
---

# Powdery mildew severity Meta-analysis  

An additional question to our main aim: does spray schedule have a similar effect on disease severity?

This model will be similar to the grain yield meta-analysis and use the main variables:

   - *Powdery mildew severity* the response variable (1-9 scale)

   - *Trial*, which resolves combinations of categorical random variables: 
      i) year  
      ii) location  
      iii) row spacing  
      iv) cultivar  
      
   - *spray_management* a moderator to evaluate the difference in effect size attributed to fungicide application timing.  
   
   - *id* random variable indicating each treatment is independent


<br>  

Load libraries and data  
```{r MEsummary_Libraries2, echo=TRUE,results='hide'}
if (!require("pacman"))
   install.packages("pacman")
pacman::p_load(tidyverse,
               kableExtra,
               bomrang,
               RColorBrewer,
               metafor,
               here,
               netmeta,
               multcomp,
               dplyr,
               flextable,
               gam)

source(here("R/reportP.R"))

# Data
PM_dat_D <-
   read.csv("cache/PM_disease_clean_data.csv", stringsAsFactors = FALSE)
```

<br>  
<br>  


### Define Trial
```{r define_trial}
PM_dat_D <-
   PM_dat_D %>%
   mutate(trial = paste(trial_ref,
                        year,
                        location,
                        host_genotype,
                        row_spacing,
                        sep = "_")) 
```

### Inspect PM severity for normality
Given the meta-analysis assumes powdery mildew severity observations to be a univariate normal distubution $Y_i = N(\mu , \sigma)$, with a mean $\mu$ and standard deviation $\sigma$. We need to inspect severity for a normality.
```{r sev_hist}
hist(PM_dat_D$PM_final_severity)
summary(PM_dat_D$PM_final_severity)
```
We can see here that powdery mildew severity observations are skewed towards the top of the scale, eight and nine in this case.

Traditionally disease severity is `log` transformed due to it being more likely to be skewed to the lower disease severity scores. In this case if we `log()` transformed the response it would increase the skew towards higher disease severity.

We can improve the normality by transforming the effect size, disease severity, by squaring.
```{r}
hist(PM_dat_D$PM_final_severity^2)
summary(PM_dat_D$PM_final_severity^2)
```

### Transform severity response
As variance is proportional to the mean we square the variance as well.
```{r square_severity}
PM_dat_D$yi_square <- PM_dat_D$PM_final_severity ^2
PM_dat_D$vi_square <- (PM_dat_D$vi +1)^2
```
_Note: Here I added 1 to the variance before it was squared. This is because squaring numbers below one makes the number smaller or remain zero. This does not change the meta-analysis mean estimates but does increase heterogeneity and tao._  

Let us also transform the severity onto a percentage scale so we can compare the results of meta-analyses with no transformation, squared severity, and percent severity.

```{r}
# Disease response ratio
# create column giving the respective disease severity in the control 
PM_dat_D$yi_C <- unlist(apply(PM_dat_D, 1, function(x1){
   
   mean(PM_dat_D[PM_dat_D$trial == x1[["trial"]] &
               PM_dat_D$spray_management == "control", "PM_final_severity"])
}))

# Calculate response ratio
PM_dat_D$yi_RR <- PM_dat_D$PM_final_severity/PM_dat_D$yi_C
hist(PM_dat_D[PM_dat_D$spray_management != "control", "yi_RR"])

# Log response ratio 
PM_dat_D$yi_LR <- log(PM_dat_D$yi_RR)
hist(PM_dat_D[PM_dat_D$spray_management != "control", "yi_LR"])

# Percent severity conversion
# define ordinal conversion from scale to proportion
s1 <- 0
s2 <- 0.33*0.5
s3 <- 0.5*0.87
s4 <- 0.66*0.75
s5 <- 0.66*0.87
s6 <- 0.66*1
s7 <- 0.75*1
s8 <- 1*0.87
s9 <- 1*1
x <- c(s1, s2, s3, s4, s5, s6, s7, s8, s9)
y <- c(1:9)
a = data.frame(x,y)
plot(a)

# fit a curve using a gam with spline value 0.2
g1 <- gam(x ~ s(y,spar = 0.1))

# View plot of gam
plot(x = predict(g1, data.frame(y= seq(1,9, by =0.1))), y= seq(1,9, by =0.1))
points(x,y,col = "red", pch = 16)

# predict values for dataset
new_sev <- predict(object =  g1, 
                   newdata = data.frame(y = PM_dat_D[,"PM_final_severity"])
                   )
# inspect distribution
hist(new_sev)
PM_dat_D$yi_percent <- new_sev 

# Conversion of variance
# Here I add the variance and mean severity and predict the conversion value
# then subtract the mean severity to obtain the difference as the sample variance
PM_dat_D$vi_percent  <- predict(object =  g1, 
                   newdata = data.frame(y = PM_dat_D[,"vi"] + PM_dat_D[,"PM_final_severity"])
                   ) - PM_dat_D$yi_percent

# compare untransformed variance to transformed variance
summary(PM_dat_D$vi)
summary(PM_dat_D$vi_percent)

# scale to 100% 
PM_dat_D$yi_percent  <- PM_dat_D$yi_percent * 100
PM_dat_D$vi_percent  <- PM_dat_D$vi_percent * 100

# scale to 100% 
PM_dat_D$L_yi_p  <- log(PM_dat_D$yi_percent + 1 )
PM_dat_D$L_vi_p  <- log(PM_dat_D$vi_percent +1 )
```

<br>  
<br>  
<br>  

*****

## Disease severity spray schedule meta-analysis  
First lets look at the results of the meta-analysis without transformation
```{r Metafor-Sev-analysis, cache=TRUE}
PMsev_mv <- rma.mv(
   yi = PM_final_severity,
   vi,
   mods = ~ spray_management,
   method = "ML",
   random = list( ~ spray_management | trial, ~ 1 | id),
   struct = "UN",
   control = list(optimizer = "optim"),
   data = PM_dat_D
)
summary(PMsev_mv)
```

All spray schedules were effective at lowering the disease severity at the end of the season.
`Recommended_plus` reduced powdery mildew incidence the most, however `Early` sprays are estimated as more effective than single `late` sprays and not significantly different to single `recommended` sprays at reducing powdery mildew severity assessed the end of the season. This does not reflect the results of the yield analysis.  

Next lets assess the square transformed severity
```{r Metafor-Sev-analysis, cache=TRUE}
PMsev_mvSQ <- rma.mv(
   yi = yi_square,
   V = vi_square,
   mods = ~ spray_management,
   method = "ML",
   random = list( ~ spray_management | trial, ~ 1 | id),
   struct = "UN",
   control = list(optimizer = "optim"),
   data = PM_dat_D
)

summary(PMsev_mvSQ)
```
This meta-analysis is more in-line with estimates from the yield meta-analysis. `Early` sprays are not effective at reducing powdery mildew severity and two or more sprays had higher efficacy than single sprays. Recommended sprays were the most effective spray timing at reducing disease severity.  


Finally lets assess the percent severity
```{r Metafor-Sev-analysis, cache=TRUE}
PMsev_mvPer <- rma.mv(
   yi = L_yi_p,
   V = L_vi_p,
   mods = ~ spray_management,
   method = "ML",
   random = list( ~ spray_management | trial, ~ 1 | id),
   struct = "UN",
   control = list(optimizer = "optim"),
   data = PM_dat_D
)

summary(PMsev_mvPer)
# Intecep <- coef(PMsev_mvPer)[1]
# ((coef(PMsev_mvPer)[2:6]+ Intecep)/100)* median(PM_dat_D$PM_final_severity) - (Intecep/100*median(PM_dat_D$PM_final_severity))
```
Model does not converge we will proceed with the square transformed severity

<br>  
<br>  
<br>  

### Disease severity moderator contrasts 

Calculate the treatment contrasts

```{r sevContrasts}
source("R/simple_summary.R") #function to provide a table that includes the treatment names in the contrasts

intercept <-PMsev_mvSQ$b[1,1]
z <- PMsev_mvSQ$zval[1]

contrast_Ssum <-
   simple_summary(summary(glht(PMsev_mvSQ, linfct = cbind(
      contrMat(rep(1, 6), type = "Tukey")
   )), test = adjusted("none")))

contrast_Ssum[6:15,] %>%
   mutate(coefficients = sqrt(coefficients + intercept) - sqrt(intercept),
          StdErr = sqrt(StdErr + intercept) - sqrt(intercept),
          Zvalue = sqrt(Zvalue + z) - sqrt(z))%>%
   flextable()%>%
   autofit()
```

<br>  
<br>  
<br>  

```{r plotsevContrasts}
par(mar = c(5, 13, 4, 2) + 0.1)
plot(glht(PMsev_mvSQ, linfct = cbind(contrMat(rep(
   1, 6
), type = "Tukey"))), yaxt = 'n')
axis(
   2,
   at = seq_along(contrast_Ssum$contrast),
   labels = rev(contrast_Ssum$contrast),
   las = 2,
   cex.axis = 0.8
)
```

`Recommended_plus` limited disease severity significantly better than any other spray treatment. 
Early sprays were not effective in decreasing disease severity.
Two spray treatments were significantly better than a single application, but the timing of the fungicide application was more critical.  

<br>  
<br>  
<br>  

### Meta-analysis summary table
```{r metafor_results}
# obtain number of treatments included in each moderator variable
k5 <-
   as.data.frame(table(PM_dat_D$spray_management)) %>%
   filter(Freq != 0) %>%
   pull(Freq)

k6 <-
   as.data.frame(table(PM_dat_D$trial_ref, PM_dat_D$spray_management)) %>%
   filter(Freq != 0) %>%
   group_by(Var2) %>%
   summarise(n()) %>%
   pull()

intercept <- PMsev_mvSQ$b[1,1]

# create data.frame
results_mv <- data.frame(
   Moderator = c(
      "Intercept / No Spray control",
      "Early",
      "Late",
      "Late+",
      "Recommended",
      "Recommended+"
   ),
   N = k5,
   k = k6,
   Effect = ifelse(PMsev_mvSQ$b == intercept, sqrt(intercept),
                   round(
                      sqrt(PMsev_mvSQ$b + intercept) - sqrt(intercept), 4
                   )),
   se = round(
      sqrt(
         ifelse(PMsev_mvSQ$b == intercept, intercept,
                PMsev_mvSQ$b + intercept) + PMsev_mvSQ$se) -
         sqrt(
            ifelse(PMsev_mvSQ$b == intercept, intercept,
                   PMsev_mvSQ$b + intercept)),
      4),
   CI_lower = round(sqrt(PMsev_mvSQ$ci.lb + intercept) - sqrt(intercept), 4),
   CI_upper = round(sqrt(PMsev_mvSQ$ci.ub + intercept) - sqrt(intercept), 4),
   z_val = round(PMsev_mvSQ$zval, 4),
   p_val = reportP(PMsev_mvSQ$pval, AsNumeric = FALSE, P_prefix = FALSE))

results_mv <- 
   results_mv %>%
   mutate(
   eff_bar = round(
      1 - (sqrt(intercept) + Effect) /
              sqrt(intercept), 
      4) * 100,
   eff_CI_high = round(
      1 - (sqrt(intercept) + CI_upper) / sqrt(intercept)
   , 4) * 100,
   eff_CI_low = round(
      1 - (sqrt(intercept) + CI_lower) / sqrt(intercept)
   , 4) * 100
   
)

# remove efficacy in control
results_mv[1,10:12] <- NA

# rename colnames to give table headings
colnames(results_mv)[c(1:4,6:12 )] <-
   c("Moderator",
     "N",
     "k",
     "mu",
     "CI_{L}",
     "CI_{U}",
     "Z",
     "P",
     "Efficacy",
     "Eff CI_lower",
     "Eff CI upper")

disease_estimates_table <-
   flextable(results_mv[c(2,5,6,3,4), c(1:7, 9:12)]) %>%
   align(j = 2:10, align = "center", part = "all") %>%
   fontsize(size = 8, part = "body") %>%
   fontsize(size = 10, part = "header") %>%
   italic(italic = TRUE, part = "header") %>%
   set_caption(
      "Table 3: Estimated powdery mildew severity mean difference ($u$) to the no spray control (intercept) for each spray schedule treatment. Estimates were back transformed using a square-root from the network meta-analysis of data obtained from grey literature reports of (k) field trials undertaken in Eastern Australia. P values indicate statistical significance in comparison to the intercept."
   ) %>%
   autofit() %>%
   footnote(
      i = 1,
      j = c(2:4,6:11),
      value = as_paragraph(
         c(
            "number of treatment means categorised to each spray schedule",
            "number of trials with the respective spray schedule",
            "estimated mean yield determined by the meta-analysis",
            
            "Lower range of the 95% confidence interval",
            "Upper range of the 95% confidence interval",
            "indicates the significance between each respective spray schedule and the no spray control (intercept)",
            "Fungicide spray schedule efficacy",
            "Lower range of the 95% confidence interval",
            "Upper range of the 95% confidence interval"
         )
      ),
      ref_symbols = letters[c(1:7,4,5)],
      part = "header",
      inline = TRUE
   )%>%
   add_header(Moderator = "",
              N = "",
              k = "",
              mu = "Effect Size",
              se = "Effect Size",
              `CI_{L}` = "Effect Size",
              `CI_{U}` = "Effect Size",
              P  = "Effect Size",
              Efficacy = "PM control",
              `Eff CI_lower` = "PM control",
              `Eff CI upper` = "PM control") %>%
   merge_h( part = "header")%>%
   hline_top(part="all", border = officer::fp_border(color = "black", width = 2) )

disease_estimates_table
```


```{r eval=FALSE, include=FALSE}
# Save table as a word document
doc <- officer::read_docx()
doc <- body_add_flextable(doc, value = disease_estimates_table)
print(doc, target = "paper/figures/Table3_severity_esimates.docx")
```

