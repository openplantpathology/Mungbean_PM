---
output: html_document
editor_options: 
  chunk_output_type: inline
---

# Powdery mildew severity Meta-analysis  

An additional question to our main aim: does spray schedule have a similar effect on disease severity?

This model will be similar to the grain yield meta-analysis and use the main variables:

   - *Powdery mildew severity* the response variable (1-9 scale)

   - *Trial*, which resolves combinations of categorical random variables: 
      i) year  
      ii) location  
      iii) row spacing  
      iv) cultivar  
      
   - *spray_management* a moderator to evaluate the difference in effect size attributed to fungicide application timing.  
   
   - *id* random variable indicating each treatment is independent


<br>  

Load libraries and data  
```{r MEsummary_Libraries2, echo=TRUE,results='hide'}
if (!require("pacman"))
   install.packages("pacman")
pacman::p_load(tidyverse,
               kableExtra,
               bomrang,
               RColorBrewer,
               metafor,
               here,
               netmeta,
               multcomp,
               dplyr,
               flextable)

source(here("R/reportP.R"))

# Data
PM_dat_D <-
   read.csv("cache/PM_disease_clean_data.csv", stringsAsFactors = FALSE)
```

<br>  
<br>  


### Define Trial
```{r define_trial}
PM_dat_D <-
   PM_dat_D %>%
   mutate(trial = paste(trial_ref,
                        year,
                        location,
                        host_genotype,
                        row_spacing,
                        sep = "_")) 
```

Inspect disease severity for a normality.
```{r sev_hist}
hist(PM_dat_D$PM_final_severity)
summary(PM_dat_D$PM_final_severity)
```
This meta-analysis assumes the effect size to be normally distributed, however, we can see here that it is skewed towards the top of the scale, eight and nine in this case.

Traditionally disease severity is log transformed due to it being more likely to be skewed to the lower disease severity scores. In this case if we `log()` transformed the response it would increase the skew towards higher disease severity.

We can improve the normality by transforming the effect size, disease severity, by squaring. As variance is proportional to the mean we square the variance aswell
```{r}
hist(PM_dat_D$PM_final_severity^2)
summary(PM_dat_D$PM_final_severity^2)
```

```{r}
# dat1 <- escalc(measure = "MN", yi = PM_final_severity., vi = vi, ni = replicates, data = PM_dat_D, slab = paste0(trial, spray_management))

PM_dat_D$yi_square <- PM_dat_D$PM_final_severity ^2
PM_dat_D$vi_square <- (PM_dat_D$vi +1)^2
```
Note: Here I added 1 to the variance before it was squared. This is because squaring numbers below one makes the number smaller or remain zero. This does not change the meta-analysis estimates but does increase tao
<br>  
<br>  
<br>  

*****

## Disease severity spray schedule meta-analysis  

```{r Metafor-Sev-analysis, cache=TRUE}
PMsev_mvSQ <- rma.mv(
   yi = yi_square,
   V = vi_square,
   mods = ~ spray_management,
   method = "ML",
   random = list( ~ spray_management | trial, ~ 1 | id),
   struct = "UN",
   control = list(optimizer = "optim"),
   data = PM_dat_D
)

summary(PMsev_mvSQ)
```

```{r Metafor-Sev-analysis, cache=TRUE}

PMsev_mv <- rma.mv(
   yi = PM_final_severity,
   vi,
   mods = ~ spray_management,
   method = "ML",
   random = list( ~ spray_management | trial, ~ 1 | id),
   struct = "UN",
   control = list(optimizer = "optim"),
   data = PM_dat_D
)
summary(PMsev_mv)
```

All spray schedules were effective at lowering the disease severity at the end of the season.
`Recommended_plus` reduced powdery mildew incidence the most.  

<br>  
<br>  
<br>  

### Disease severity moderator contrasts 

Calculate the treatment contrasts

```{r sevContrasts}
source("R/simple_summary.R") #function to provide a table that includes the treatment names in the contrasts

contrast_Ssum <-
   simple_summary(summary(glht(PMsev_mv, linfct = cbind(
      contrMat(rep(1, 6), type = "Tukey")
   )), test = adjusted("none")))

contrast_Ssum[6:15,] %>%
   mutate(coefficients = -sqrt(abs(coefficients)),
          StdErr = sqrt(StdErr))%>%
   flextable()%>%
   autofit()
```

<br>  
<br>  
<br>  

```{r plotsevContrasts}
par(mar = c(5, 13, 4, 2) + 0.1)
plot(glht(PMsev_mvSQ, linfct = cbind(contrMat(rep(
   1, 6
), type = "Tukey"))), yaxt = 'n')
axis(
   2,
   at = seq_along(contrast_Ssum$contrast),
   labels = rev(contrast_Ssum$contrast),
   las = 2,
   cex.axis = 0.8
)
```

`Recommended_plus` limited disease severity significantly better than any other spray treatment. 
`Late_plus` limited disease severity significantly better than a single `Late` application. 
This indicates that two spray treatments were significantly better than a single application, but the timing of the fungicide application was more critical.  

<br>  
<br>  
<br>  

### Meta-analysis summary table
```{r metafor_results}
# obtain number of treatments included in each moderator variable
k5 <-
   as.data.frame(table(PM_dat_D$spray_management)) %>%
   filter(Freq != 0) %>%
   pull(Freq)

k6 <-
   as.data.frame(table(PM_dat_D$trial_ref, PM_dat_D$spray_management)) %>%
   filter(Freq != 0) %>%
   group_by(Var2) %>%
   summarise(n()) %>%
   pull()

intercept <- PMsev_mvSQ$b[1,1]

# create data.frame
results_mv <- data.frame(
   Moderator = c(
      "Intercept / No Spray control",
      "Early",
      "Late",
      "Late+",
      "Recommended",
      "Recommended+"
   ),
   N = k5,
   k = k6,
   Effect = ifelse(PMsev_mvSQ$b == intercept, sqrt(intercept),
                   round(
                      sqrt(PMsev_mvSQ$b + intercept) - sqrt(intercept), 4
                   )),
   se = round(
      sqrt(
         ifelse(PMsev_mvSQ$b == intercept, intercept,
                PMsev_mvSQ$b + intercept) + PMsev_mvSQ$se) -
         sqrt(
            ifelse(PMsev_mvSQ$b == intercept, intercept,
                   PMsev_mvSQ$b + intercept)),
      4),
   CI_lower = round(sqrt(PMsev_mvSQ$ci.lb + intercept) - sqrt(intercept), 4),
   CI_upper = round(sqrt(PMsev_mvSQ$ci.ub + intercept) - sqrt(intercept), 4),
   z_val = round(PMsev_mvSQ$zval, 4),
   p_val = reportP(PMsev_mvSQ$pval, AsNumeric = FALSE, P_prefix = FALSE))

results_mv <- 
   results_mv %>%
   mutate(
   eff_bar = round(
      1 - (sqrt(intercept) + Effect) /
              sqrt(intercept), 
      4) * 100,
   eff_CI_high = round(
      1 - (sqrt(intercept) + CI_upper) / sqrt(intercept)
   , 4) * 100,
   eff_CI_low = round(
      1 - (sqrt(intercept) + CI_lower) / sqrt(intercept)
   , 4) * 100
   
)

# remove efficacy in control
results_mv[1,10:12] <- NA

# rename colnames to give table headings
colnames(results_mv)[c(1:4,6:12 )] <-
   c("Moderator",
     "N",
     "k",
     "mu",
     "CI_{L}",
     "CI_{U}",
     "Z",
     "P",
     "Efficacy",
     "Eff CI_lower",
     "Eff CI upper")

disease_estimates_table <-
   flextable(results_mv[c(2,5,6,3,4), c(1:7, 9:12)]) %>%
   align(j = 2:10, align = "center", part = "all") %>%
   fontsize(size = 8, part = "body") %>%
   fontsize(size = 10, part = "header") %>%
   italic(italic = TRUE, part = "header") %>%
   set_caption(
      "Table 3: Estimated powdery mildew severity mean difference ($u$) to the no spray control (intercept) for each spray schedule treatment. Estimates were calculated from a network meta-analysis of data obtained from grey literature reports of (k) field trials undertaken in Eastern Australia. P values indicate statistical significance in comparison to the intercept."
   ) %>%
   autofit() %>%
   footnote(
      i = 1,
      j = c(2:4,6:11),
      value = as_paragraph(
         c(
            "number of treatment means categorised to each spray schedule",
            "number of trials with the respective spray schedule",
            "estimated mean yield determined by the meta-analysis",
            
            "Lower range of the 95% confidence interval",
            "Upper range of the 95% confidence interval",
            "indicates the significance between each respective spray schedule and the no spray control (intercept)",
            "Fungicide spray schedule efficacy",
            "Lower range of the 95% confidence interval",
            "Upper range of the 95% confidence interval"
         )
      ),
      ref_symbols = letters[c(1:7,4,5)],
      part = "header",
      inline = TRUE
   )%>%
   add_header(Moderator = "",
              N = "",
              k = "",
              mu = "Effect Size",
              se = "Effect Size",
              `CI_{L}` = "Effect Size",
              `CI_{U}` = "Effect Size",
              P  = "Effect Size",
              Efficacy = "PM control",
              `Eff CI_lower` = "PM control",
              `Eff CI upper` = "PM control") %>%
   merge_h( part = "header")%>%
   hline_top(part="all", border = officer::fp_border(color = "black", width = 2) )

disease_estimates_table
```


```{r eval=FALSE, include=FALSE}
# Save table as a word document
doc <- officer::read_docx()
doc <- body_add_flextable(doc, value = disease_estimates_table)
print(doc, target = "paper/figures/Table3_severity_esimates.docx")
```

