---
output: html_document
editor_options: 
  chunk_output_type: inline
---

# Meta-analysis of powdery mildew severity

```{r MEsummary_Libraries2, message=FALSE, include=FALSE}
if (!require("pacman"))
   install.packages("pacman")
pacman::p_load(tidyverse,
               kableExtra,
               bomrang,
               RColorBrewer,
               metafor,
               here,
               netmeta,
               multcomp,
               dplyr,
               flextable)

if (!require("theme.usq"))
   devtools::install_github("adamhsparks/theme.usq")
library(theme.usq)
theme_set(theme_usq())
source(here("R/reportP.R"))

# Data
PM_dat_D <-
   read.csv("cache/PM_disease_clean_data.csv", stringsAsFactors = FALSE)
```



Inspect for a normal distribution of disease severity
```{r sev_hist}
hist(PM_dat_D$PM_final_severity)
```


Let's get started with the analysis by first finding the best model fit that answers our research question.

> When, in relation to PM establishes in the crop, should farmers begin spraying mungbean to obtain the highest fungicide efficacy for lowering disease severity: before PM establishing,  immediately after first sign of PM establishing, or after PM has become established in the crop. 

A secondary question to this aim is: does a second spray increase the efficacy?

To do this, in our model:

   - Powdery mildew severity 1-9 scale

   - Trial, which resolves combinations of categorical variables: year, location, row spacing, fungicide dose and cultivar; is set as a random intercept

### Define Trial
```{r define_trial}
PM_dat_D <-
   PM_dat_D %>%
   mutate(trial = paste(trial_ref,
                        year,
                        location,
                        host_genotype,
                        row_spacing,
                        sep = "_")) 
```


   - We will investigate the effect size of our treatment - spray management,


```{r Metafor-Sev-analysis}
PMsev_mv <- rma.mv(
   yi = PM_final_severity,
   vi,
   mods = ~ spray_management,
   method = "ML",
   random = list( ~ spray_management | trial, ~ 1 | id),
   struct = "UN",
   control = list(optimizer = "optim"),
   data = PM_dat_D
)

summary(PMsev_mv)
```

All spray schedules were effective at lowering the disease severity at the end of the season

```{r sevContrasts}
source("R/simple_summary.R") #function to provide a table that includes the treatment names in the contrasts

contrast_Ssum <-
   simple_summary(summary(glht(PMsev_mv, linfct = cbind(
      contrMat(rep(1, 6), type = "Tukey")
   )), test = adjusted("none")))

contrast_Ssum
```

```{r plotsevContrasts}
par(mar = c(5, 13, 4, 2) + 0.1)
plot(glht(PMsev_mv, linfct = cbind(contrMat(rep(
   1, 6
), type = "Tukey"))), yaxt = 'n')
axis(
   2,
   at = seq_along(contrast_Ssum$contrast),
   labels = rev(contrast_Ssum$contrast),
   las = 2,
   cex.axis = 0.8
)
```


```{r metafor_results}
# obtain number of treatments included in each moderator variable
k5 <-
   as.data.frame(table(PM_dat_D$trial, PM_dat_D$spray_management)) %>%
   filter(Freq != 0) %>%
   group_by(Var2) %>%
   summarise(n()) %>%
   pull()

# create data.frame
results_mv <- data.frame(
   moderator = c(
   "Intercept / No Spray control",
   "Early",
   "Recommended",
   "Recommended+",
   "Late",
   "Late+"
   ),
   N = PMsev_mv$g.levels.k,
   k = k5,
   Effect = round(PMsev_mv$b, 4),
   se = round(PMsev_mv$se, 4),
   CI_lower = round(PMsev_mv$ci.lb, 4),
   CI_upper = round(PMsev_mv$ci.ub, 4),
   z_val = round(PMsev_mv$zval, 4),
   p_val = reportP(PMsev_mv$pval, AsNumeric = FALSE, P_prefix = FALSE)
)

# rename colnames to give table headings
colnames(results_mv)[c(2:5, 7:10)] <-
   c("Treatment",
     "N",
     "k",
     "mu",
     "CI_{L}",
     "CI_{U}",
     "Z",
     "P")

disease_estimates_table <- 
   flextable(results_mv[c(2:6), c(1,3:8,10)]) %>%
   align(j = 3:8, align = "center", part = "all") %>%
   fontsize(size = 8, part = "body") %>%
   fontsize(size = 10, part = "header") %>%
   italic(italic = TRUE, part = "header") %>%
   set_caption("Table 3: Estimated powdery mildew severity mean difference ($u$) to the no spray control (intercept) for each spray schedule treatment. Estimates were calculated from a network meta-analysis of data obtained from grey literature reports of field trials undertaken in Eastern Australia. Z and P values indicate statistical significance in comparison to the intercept.") %>%
   autofit()

disease_estimates_table
```

Save table to a word document to use in manuscript
```{r eval=FALSE, include=FALSE}
# Save table as a word document
doc <- officer::read_docx()
doc <- body_add_flextable(doc, value = disease_estimates_table)
print(doc, target = "paper/figures/Table3_severity_esimates.docx")
```

