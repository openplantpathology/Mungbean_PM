# Trials considered for inclusion in meta-analysis

```{r MEsummary_Libraries, message=FALSE, echo=FALSE}
if (!require("pacman"))
   install.packages("pacman")
pacman::p_load(tidyverse, kableExtra, leaflet, htmltools, lubridate, here)

if (!require("theme.usq"))
   devtools::install_github("adamhsparks/theme.usq")
library(theme.usq)
theme_set(theme_usq()
)
```
Trials testing fungicide efficacy on powdery mildew in mungbean in the Grains Research and Development Corporation (GRDC) northern grains region were sourced for a meta-analysis.

Data was collected from a number of researchers from the Department of Agriculture and Primary Industries and the University of Southern Queensland and the National Growers Association.
We would like to acknowledge in particular Professor Malcolm Riley's and Dr. Sue Thompson's effort in establishing and coordinating early field trials between 2010 and 2014.


<br>
<br>
<br>


## Criteria for inclusion in meta-analysis  

   1. A field trial testing the efficacy of fungicide on powdery mildew afflicted mungbean plants.  
   2. Trial data needed to include:  
      i) Fungicide active ingredients.  
      ii) A demethylase inhibitor (DMI) fungicide.  
      iii) The date at which powdery mildew first appeared in the trial.  
      iv) Disease severity at the end of the growing seasons.  
      v) Fungicide application dates.  
      vi) Fungicide dose.  
      vii) Crop yield.  
      viii) Treatment means and accompanying variance.



<br>
<br>
<br>

## Import data and apply selection criteria  
### Import data from trials we have the raw data  
```{r import_dataRAW}
PM_MB_raw <-
   rbind(
      read.csv(
         here("cache/2010 PMmung Hermitage means.csv"),
         stringsAsFactors = FALSE
      ),
      read.csv(here("cache/2011 PMmung Herm means.csv"), stringsAsFactors = FALSE),
      read.csv(
         here("cache/2011 PMmung Kingaroy means.csv"),
         stringsAsFactors = FALSE
      ),
      read.csv(here("cache/AM1305_Goolhi_means.csv"), stringsAsFactors = FALSE),
      read.csv(
         here("cache/AM1304-MarysMount_means.csv"),
         stringsAsFactors = FALSE
      ),
      read.csv(
         here("cache/AM1303-Premer-Disease_means.csv"),
         stringsAsFactors = FALSE
      ),
      read.csv(
         here("cache/BB1305_Millmerran_means.csv"),
         stringsAsFactors = FALSE
      ),
      read.csv(here("cache/Herm_16_means.csv"), stringsAsFactors = FALSE),
      read.csv(here("cache/King_16_means.csv"), stringsAsFactors = FALSE),
      read.csv(here("cache/Fogerty_17_mean.csv"), stringsAsFactors = FALSE),
      read.csv(here("cache/Hermitage_17_mean.csv"), stringsAsFactors = FALSE),
      read.csv(here("cache/Wellcamp_18_mean.csv"), stringsAsFactors = FALSE),
      read.csv(here("cache/Hermitage_19_mean.csv"), stringsAsFactors = FALSE)
   )
write.csv(
   PM_MB_raw,
   file = here("cache/PM_Mungbean_SummaryOfTrialsWithRawData"),
   row.names = FALSE
)
```

<br>
<br>
<br>


### Import dataset of manual entries  
Import dataset which were manually entered from trial reports  
```{r import_dataMan}
PM_MB_man <-
   read.csv(here("cache/PM_Mungbean_DataManuallyEntered.csv"),
            stringsAsFactors = FALSE)
```

Bind datasets, data set compiled from raw trial data and data manually compiled from trial reports.  
```{r bind_data}
PM_MB_dat <-
   rbind(PM_MB_raw,
         PM_MB_man)
```

<br>
<br>
<br>

### Summary of all trials  
```{r data_summary, echo=FALSE, message=FALSE, warning=FALSE}
PM_MB_dat %>%
   arrange(year, location) %>%
   group_by(trial_ref) %>%
   summarise(
      Year = unique(year),
      Location = unique(location),
      `Replicates per treatment` = if (all(replicates[1] == replicates)) {
         as.character(replicates[1])
      } else{
         as.character(paste(min(replicates), "-", max(replicates)))
      },
      `Planting date` = unique(planting_date),
      `First sign of disease` = unique(first_sign_disease),
      `Fungicide treatments` = length(n_treatment),
   ) %>%
   arrange(Year) %>%
   kable(
      caption = "Description of Experiments",
      align = "c",
      col.names = c(
         "Unique Trial\nReference",
         "Year",
         "Location",
         "Replicates\nper treatments",
         "Planting date",
         "First sign\nof disease",
         "Fungicide\n treatments"
      )
   )  %>%
   kable_styling(fixed_thead = TRUE, full_width = TRUE) %>%
   column_spec(c(3, 5:6), width = "3cm") %>%
   scroll_box(height = "500px") 
```

<br>

### Experiment locations  

The following map displays experiment locations in the GRDC Northern Grains Region, which were considered for inclusion in this meta-analysis.  

```{r Experiment_locations, echo=FALSE}
experiment_sites <- data.frame(
   location = c(
      "Hermitage Research Station",
      "Red Vale & Kingaroy Research Station",
      "Gatton",
      "Emerald Agricultural College",
      "Bongeen 1 & 2",
      "NGA - Premer",
      "NGA - Millmerran",
      "NGA - Marys Mount",
      "NGA - Goolhi",
      "Missen Flats",
      "Wellcamp"
   ),
   lat = c(
      -28.215 ,
      -26.58,
      -27.56,
      -23.54,
      -27.51666,
      -31.43449,
      -27.923674,
      -31.0142,
      -31.00246,
      -27.905313,
      -27.564277
   ),
   lon = c(
      152.1003,
      151.83,
      152.32,
      148.19,
      151.450,
      150.0052,
      151.242706,
      150.05018,
      149.82507,
      151.9772,
      151.867879
   )
)

write.csv(experiment_sites,
          "cache/Mungbean_experiment_sites.csv",
          row.names = FALSE)

leaflet(experiment_sites) %>%
   addProviderTiles("Esri.WorldTopoMap") %>%
   setView(lat = -27.31,
           lng = 150.456,
           zoom = 5) %>%
   addMarkers(
      lng = ~ lon,
      lat = ~ lat,
      popup = ~ htmlEscape(location)
   )
```

<br>
<br>
<br>


## Subset data to selection criteria  

Let's apply the selection criteria our dataset.  
All trials identified for this meta-analysis reported: 

* fungicide active ingredient,
* dose,
* first sign of disease. 

Therefore no trials need to be removed to satisfy these criteria.  


Three trials omitted due to not reporting yields  
```{r TrialWithoutYield}
PM_MB_dat %>%
   filter(is.na(grain_yield.t.ha.)) %>%
   distinct(trial_ref, year, location)

PM_MB_dat <- PM_MB_dat %>%
   filter(!is.na(grain_yield.t.ha.))
```

<br>
<br>
<br>

One more was trial removed as it did not report disease severity.  
```{r TrialsWithotDisease}
PM_MB_dat %>%
   filter(is.na(PM_final_severity)) %>%
   distinct(trial_ref, year, location)

PM_MB_dat <- PM_MB_dat %>%
   filter(!is.na(PM_final_severity))
```

<br>
<br>
<br>

No trials from our subset need to be removed for not reporting fungicide application dates.  
```{r FungicideApplicationDates}
PM_MB_dat %>%
   group_by(trial_ref) %>%
   summarise(No_Record_Of_Fungicide_Application_Dates = all(is.na(fungicide_application_1)),
             .groups = 'drop') %>%
   filter(No_Record_Of_Fungicide_Application_Dates)
```

<br>
<br>
<br>

No trials from our subset need to be removed for not reporting fungicide dose.  
```{r FungicideDoseTrials}
PM_MB_dat %>%
   group_by(trial_ref) %>%
   summarise(No_Record_Of_Fungicide_Dose = all(is.na(dose_ai.ha)),
             .groups = 'drop') %>%
   filter(No_Record_Of_Fungicide_Dose)
```

<br>
<br>
<br>


We need to focus the meta-analysis on fungicides with the same mode of action.
Let's look at all the fungicides and retain the best represented fungicide group in the data.
```{r Fungicides}
PM_MB_dat %>%
   group_by(fungicide_ai, trial_ref) %>%
   summarise() %>%
   count(sort = TRUE) %>%
   rename(Trials = n) %>%
   ggplot(aes(x = reorder(fungicide_ai, Trials), y = Trials)) +
   xlab("Fungicide active ingredient") +
   ylab("N Trials") +
   geom_col() +
   scale_fill_usq() +
   ggtitle(label = "Number of trials in which the\nspecified fungicide was used") +
   scale_colour_usq() +
   coord_flip()
```

The demethylation inhibitors (DMI), tebuconazole and propiconazole, are used in the highest frequencies.
The DMIs have the same fungicide mode of action and are good candidates to be pooled in the meta-analysis.

Amistar Xtra and Custodia both contain strobilurin and triazole, however, because they contain differing dose ratios (inverted) pooling may not be appropriate.

Perhaps best way forward is to focus the meta-analysis on only the DMIs.
This can then be compared to an additional meta-analysis including azoxystrobin as a comparison.  

<br>
<br>
<br>

## Subset to trials containing DMI fungicides

```{r filterDMI_trials}
DMI_Trials <-
   PM_MB_dat %>%
   filter(fungicide_ai == "tebuconazole" |
             fungicide_ai == "propiconazole") %>%
   distinct(trial_ref) %>%
   pull()

PM_MB_dat <-
   PM_MB_dat[PM_MB_dat$trial_ref %in% DMI_Trials, ]
```

Now remove any non-DMI treatments or controls
```{r KeepOnlyDMI}
PM_MB_dat <-
   PM_MB_dat %>%
   filter(
      fungicide_ai == "control" |
         fungicide_ai == "tebuconazole" |
         fungicide_ai == "propiconazole"
   )
```


## Excluding variance
Following an inspection of the yield and disease variance we determined imputation was not suitable and therefore we must exlude trials that did not report variance.
For each analysis, yield and disease severity a separate data-set will be created, including only trials that report variance for the respective response variable

Four trials will be removed for our yield data set `PM_dat_Y` for not reporting yield variance.  
```{r TrialsWithVariance}
NoVar <- PM_MB_dat %>%
   mutate(No_Var = is.na(yield_error)) %>%
   filter(No_Var == TRUE) %>%
   distinct(trial_ref, year, location)
NoVar

PM_dat_Y <- PM_MB_dat %>%
   filter(!(trial_ref %in% NoVar$trial_ref))
```


Four trials will be removed for our disease severity data set `PM_dat_S` for not reporting yield variance.  
```{r TrialsWithVariance_D}
NoVar <- PM_MB_dat %>%
   mutate(No_Var = is.na(disease_error)) %>%
   filter(No_Var == TRUE) %>%
   distinct(trial_ref, year, location)
NoVar

PM_dat_D <- PM_MB_dat %>%
   filter(!(trial_ref %in% NoVar$trial_ref))
```


We will retain the following trials, which only contain DMI fungicides. 
However, we won't remove non-DMI fungicides just yet, we will do this before the analysis.

```{r Final_Trials_For_Inclusion}
PM_MB_dat %>%
   filter(fungicide_ai == "tebuconazole" |
             fungicide_ai == "propiconazole") %>%
   mutate(MA_analysis = case_when(
      is.na(yield_error & disease_error) == FALSE ~ "Yield and Disease",
      is.na(yield_error) == FALSE & 
         is.na(disease_error) ~ "Yield",
      is.na(disease_error) == FALSE & 
         is.na(yield_error) ~ "Disease",
      TRUE ~ "Nil"
   )) %>%
   distinct(trial_ref, location, year, MA_analysis) %>%
   arrange(year) 
```

<br>
<br>
<br>
<br>

### Classify dataset variables  

Finally, we are going to define the class of each variable in the data, retaining only the variables relevant to the analysis. 

```{r classifyData}
source("R/classify_PM_data.R")

# classify yield data
PM_dat_Y <- 
   classify_PM_data(PM_dat_Y)

#classify disease data
PM_dat_D <- 
   classify_PM_data(PM_dat_D)
```



## Classifying spray schedule  

First are going to calculate the time between the first sign of disease and the fungicide applications.  

```{r clustered_fungicide_applications}
# Yield data
PM_dat_Y %<>%
   mutate(fungicide_timing_1 = fungicide_application_1 - first_sign_disease) %>%
   mutate(fungicide_timing_2 = fungicide_application_2 - fungicide_application_1) %>%
   mutate(fungicide_timing_3 = fungicide_application_3 - fungicide_application_2)

# Disease data
PM_dat_D %<>%
   mutate(fungicide_timing_1 = fungicide_application_1 - first_sign_disease) %>%
   mutate(fungicide_timing_2 = fungicide_application_2 - fungicide_application_1) %>%
   mutate(fungicide_timing_3 = fungicide_application_3 - fungicide_application_2)

```

To ensure sufficient number of replicates, we will bin the continuous variable into three categorical variables relating to when the first fungicide application was made, relative to the first sign of disease.  

These categorical variables are named:
   - **Early**: First fungicide application was prior to first sign of disease. 
   - **Recommended**: First fungicide application was applied on the day powdery mildew was observed, or within three days of first sign. 
   - **Late**: First fungicide application was four or more days after first sign of disease being observed. 
   
The number of sprays need also be defined.

```{r TreatmentTable}
data.frame(
   TreatmentName = c(
      "Early",
      "Recommended",
      "Late",
      "EarlyPlus",
      "RecommendedPlus",
      "LatePlus"
   ),
   n_sprays = rep(c("Single", "Two - Three"), each = 3),
   DaysRelativeToFirstSign = c(
      "Prior to first sign of Powdery Mildew",
      "1 - 3 days after first sign of Powdery Mildew",
      "7 - 8 days after first sign of Powdery Mildew"
   )
) %>%
   kable()
```

Simplify the clusters for the yield data-set
```{r simple_Y_clusters}
PM_dat_Y <- PM_dat_Y %>%
   mutate(
      spray_management = case_when(
         fungicide_timing_1 < 0 &
            is.na(fungicide_application_2) &
            is.na(fungicide_application_3) ~ "Early",
         fungicide_timing_1 >= 0 &
            fungicide_timing_1 < 4 &
            is.na(fungicide_application_2) &
            is.na(fungicide_application_3) ~ "Recommended",
         fungicide_timing_1 >= 4 &
            is.na(fungicide_application_2) &
            is.na(fungicide_application_3) ~ "Late",
         fungicide_timing_1 < 0 &
            !is.na(fungicide_application_2) ~ "Early_plus",
         fungicide_timing_1 >= 0 &
            fungicide_timing_1 < 4 &
            !is.na(fungicide_application_2) ~ "Recommended_plus",
         fungicide_timing_1 >= 4 &
            !is.na(fungicide_application_2) ~ "Late_plus",
         TRUE ~ "Other"
      )
   )

PM_dat_Y[PM_dat_Y$fungicide_ai == "control",
          c(
             "fungicide_timing_1",
             "fungicide_timing_2",
             "fungicide_timing_3",
             "spray_management"
          )] <- "control"
```


Simplify the clusters
```{r simple_D_clusters}
PM_dat_D <- PM_dat_D %>%
   mutate(
      spray_management = case_when(
         fungicide_timing_1 < 0 &
            is.na(fungicide_application_2) &
            is.na(fungicide_application_3) ~ "Early",
         fungicide_timing_1 >= 0 &
            fungicide_timing_1 < 4 &
            is.na(fungicide_application_2) &
            is.na(fungicide_application_3) ~ "Recommended",
         fungicide_timing_1 >= 4 &
            is.na(fungicide_application_2) &
            is.na(fungicide_application_3) ~ "Late",
         fungicide_timing_1 < 0 &
            !is.na(fungicide_application_2) ~ "Early_plus",
         fungicide_timing_1 >= 0 &
            fungicide_timing_1 < 4 &
            !is.na(fungicide_application_2) ~ "Recommended_plus",
         fungicide_timing_1 >= 4 &
            !is.na(fungicide_application_2) ~ "Late_plus",
         TRUE ~ "Other"
      )
   )

PM_dat_D[PM_dat_D$fungicide_ai == "control",
          c(
             "fungicide_timing_1",
             "fungicide_timing_2",
             "fungicide_timing_3",
             "spray_management"
          )] <- "control"
```

Now to view the number break-down of the `spray_management` treatments in the yield and disease severity data-sets

```{r tableSprayManagement_Y}
table(PM_dat_Y$spray_management)
```


```{r tableSprayManagement_Y}
table(PM_dat_D$spray_management)
```


'Early_plus' treatments are few in number, these treatments will have too few comparisons with other treatments in the meta-analysis to provide accurate results. Therefore we will remove 'Early_plus' from the analysis.

```{r simpler_clusters_remove}
PM_dat_Y <-
   PM_dat_Y %>%
   filter(spray_management != "Early_plus") %>%
   select(-c(fungicide_timing_1, # remove the following columns which no longer have use
             fungicide_timing_2,
             fungicide_timing_3,
             fungicide_application_1,
             fungicide_application_2,
             fungicide_application_3,
             fungicide_application_4,
             fungicide_application_5,
             fungicide_application_6,
             fungicide_application_7,
             ))

PM_dat_D <-
   PM_dat_D %>%
   filter(spray_management != "Early_plus") %>%
   select(-c(fungicide_timing_1, # remove the following columns which no longer have use
             fungicide_timing_2,
             fungicide_timing_3,
             fungicide_application_1,
             fungicide_application_2,
             fungicide_application_3,
             fungicide_application_4,
             fungicide_application_5,
             fungicide_application_6,
             fungicide_application_7,
             ))
```



## Standardise Variance

All the variance types need to be converted to sample variance. 
First we will start by standardising yield variance according to the method reported by [Nugugi et.al (2011)](https://apsjournals.apsnet.org/doi/10.1094/PHYTO-08-10-0221).

### Yield variance standardisation
```{r StandardiseYieldVariance}
PM_dat_Y <-
   PM_dat_Y %>%
   mutate(
      vi =
         case_when(
            Y_error_type == "stdev" ~ yield_error ^ 2,
            Y_error_type == "lsd (P=0.05)" ~
               (replicates * ((yield_error / 1.96) ^ 2) / 2) / replicates
         ),
      spray_management = fct_relevel(spray_management, sort)
   ) %>%
   select(-c(yield_error,
             Y_error_type))

```


### Disease severity variance standardisation
```{r StandardiseSeverityVariance}
PM_dat_D <-
   PM_dat_D %>%
   mutate(
      vi =
         case_when(
            D_error_type == "stdev" ~ disease_error ^ 2,
            D_error_type == "lsd (P=0.05)" ~
               (replicates * ((disease_error / 1.96) ^ 2) / 2) / replicates
         ),
      id = row_number(),
      spray_management = fct_relevel(spray_management, sort)
   ) %>%
   select(-c(disease_error,
             D_error_type))

```




```{r saveData01}
write.csv(PM_dat_Y, file = "cache/PM_yield_clean_data.csv", row.names = FALSE)
write.csv(PM_dat_D, file = "cache/PM_disease_clean_data.csv", row.names = FALSE)
save(PM_MB_dat, PM_dat_D, PM_dat_Y, file = here("cache/ImportDataAndSelectTrials01.Rdata"))
```

