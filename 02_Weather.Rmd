# Weather data

The mungbean DSS determines the need to spray on:  
   1. The presence of the disease
   2. The forecasted maximum temperatures in the next seven days
   3. The number of days over the next seven days with rainfall
   
Below I am plotting the mean maximum temperatures over 7 days during the growing season at each mungbean trial site.
The vertical lines indicate when powdery mildew was first observed in that season.
Variation may exist in the sowing date of each trial.

```{r import_libraries_&_data}
library(ggplot2)
library(dplyr)
source("R/import_data.R")
PM.dat <- import_data()  # importing means yield and disease severity for each treatment within each powdery mildew trial on mungbean
source("R/year2day.r")
source("R/gg_color_hue_function.R")

cols1 <- gg_color_hue(4)

# import data from SILO interpolated datasets downloaded from the QLD longpaddock website
silo_war_Tmax <- read.csv("./data/silo_war_Tmax.csv")
silo_king_Tmax <- read.csv("./data/silo_king_Tmax.csv")
silo_gatton_Tmax <- read.csv("./data/silo_gatton_Tmax.csv")
silo_emerald_Tmax <- read.csv("./data/silo_emerald_Tmax.csv")

```


Lets have a look at the climate for the main field experiment sites

### Kingaroy historical weather
```{r Kingaroy_weather, echo=FALSE}
# Smoothing temperatures by taking a rolling7 day average
max_T <- vector()
min_T <- vector()
for (i in 1:length(silo_king_Tmax[, 1])) {
   max_T <- c(max_T, mean(silo_king_Tmax$max_temp[i:(i + 7)]))
   min_T <- c(min_T, mean(silo_king_Tmax$min_temp[i:(i + 7)]))
}

king_Tm_aver <-
   data.frame(
      location = "Kingaroy",
      date = as.Date(silo_king_Tmax$date),
      max_T,
      min_T,
      daily_rain = silo_king_Tmax$daily_rain
   )

# Add columns for Year and date to data
king_Tm_aver$year <- substr(king_Tm_aver$date, start = 1, stop = 4)
king_Tm_aver$day <- sapply(king_Tm_aver$date,year2day)
   


# Create data subset of powdery mildew data means for the first sign of the disease by location
PM.dat_sum <- as.data.frame(do.call(rbind,
                   by(PM.dat, PM.dat$trial_ref, function(x){
                      c(location = unique(as.character(x$location)),
                        year = unique(as.character(x$year)),
                        first_sign = unique(as.character(x$first_sign_disease)),
                        day = as.numeric(unique(sapply(x$first_sign_disease,year2day))))
                   }
                      )), stringsAsFactors = FALSE)

King_FS <- PM.dat_sum[PM.dat_sum$location == "Kingaroy",]
King_FS$day <- as.numeric(King_FS$day)


king_Tm_aver[king_Tm_aver$year == "2002"|
                king_Tm_aver$year == "2010"|
                king_Tm_aver$year == "2011"|
                king_Tm_aver$year == "2012"|
                king_Tm_aver$year == "2016", ] %>%
   ggplot(aes(x = day)) +
   geom_line(aes(y = max_T, colour = year)) +
   #geom_smooth(method = "lm", aes(y = max_T), colour = "darkred")+
   geom_line(aes(y = min_T, colour = year)) +
   #geom_smooth(method = "lm", aes(y = min_T), colour = "darkblue")+
   labs(x = "Date", y = "Daily maximum temperature averaged over 7 days",
        title = "Maximum and minimum daily temperatures in Kingaroy") +
   scale_x_continuous(
      limits = c(0, 200),
      labels = c(subset(king_Tm_aver, year == 2016)$date[c(1, 50, 100, 150, 200)]),
      breaks = c(1, 50, 100, 150, 200)
   ) +
   theme(
      panel.grid.major = element_line(colour = "grey80"),
      panel.grid.minor = element_line(colour = "grey50"),
      panel.background = element_rect(fill = NA)
   ) +
   geom_vline(
      xintercept = King_FS$day[1],
      size = 1,
      colour = cols1[1],
      linetype = "dotted"
   ) +
   geom_vline(
      xintercept = King_FS$day[2],
      size = 1.5,
      colour = cols1[2],
      linetype = "dotted"
   ) +
   geom_vline(
      xintercept = King_FS$day[3],
      size = 1,
      colour = cols1[3],
      linetype = "dashed"
   ) +
   geom_area(aes(y = daily_rain, fill = year), alpha = 0.5) +
   scale_y_continuous(limits = c(0, 40),sec.axis = dup_axis(name = "Rainfall (mm)"))
#   scale_x_continuous(limits = c(1,180),
#                      breaks = c(1,32,(31+29),(31+29+31),(31+29+31+30),(31+29+31+30+31),(31+29+31+30+31+30)),
#                      labels = c("2012-Jan-01","2012-Feb-01","2012-Mar-01","2012-Apr-01","2012-May-01","2012-Jun-01","2012-Jul-01"))
```

### Hermitage historical weather
```{r Hermitage_weather, echo=FALSE}
# ______  Hermitage  _______
max_T <- vector()
min_T <- vector()
for (i in 1:length(silo_war_Tmax[, 1])) {
   max_T <- c(max_T, mean(silo_war_Tmax$max_temp[i:(i + 7)]))
   min_T <- c(min_T, mean(silo_war_Tmax$min_temp[i:(i + 7)]))
}


war_Tm_aver <-
   data.frame(
      location = "Hermitage",
      date = as.Date(silo_war_Tmax$date),
      max_T,
      min_T,
      daily_rain = silo_war_Tmax$daily_rain
   )


# Add columns for Year and date to data
war_Tm_aver$year <- substr(war_Tm_aver$date, start = 1, stop = 4)
war_Tm_aver$day <- sapply(war_Tm_aver$date,year2day)
   

# Create data subset of powdery mildew data means for the first sign of the disease by location

Herm_FS <- PM.dat_sum[PM.dat_sum$location == "Hermitage",]
Herm_FS$day <- as.numeric(Herm_FS$day)




ggplot(subset(war_Tm_aver, year == levels(factor(Herm_FS$year))),
       aes(day)) +
   geom_line(aes(y = max_T, colour = year)) +
   #geom_smooth(method = "lm", aes(y = max_T), colour = "darkred")+
   geom_line(aes(y = min_T, color = year)) +
   #geom_smooth(method = "lm", aes(y = min_T), colour = "darkblue")+
   labs(x = "Date", y = "Daily maximum temperature averaged over 7 days",
        title = "Maximum and minimum daily temperatures in Hermitage") +
   theme(
      panel.grid.major = element_line(colour = "grey80"),
      panel.grid.minor = element_line(colour = "grey50"),
      panel.background = element_rect(fill = NA)
   ) +
   geom_vline(
      xintercept = Herm_FS$day[1],
      size = 1,
      colour = cols1[1],
      linetype = "dotted"
   ) +
   geom_vline(
      xintercept = Herm_FS$day[2],
      size = 1.5,
      colour = cols1[2],
      linetype = "dotted"
   ) +
   geom_vline(
      xintercept = Herm_FS$day[3],
      size = 1,
      colour = cols1[3],
      linetype = "dashed"
   ) +
   geom_area(aes(y = daily_rain, fill = year), alpha = 0.5) +
   scale_y_continuous(limits = c(0, 45),sec.axis = dup_axis(name = "Rainfall (mm)")) +
   scale_x_continuous(
      limits = c(1, 180),
      breaks = c(
         1,
         32,
         (31 + 29),
         (31 + 29 + 31),
         (31 + 29 + 31 + 30),
         (31 + 29 + 31 + 30 + 31),
         (31 + 29 + 31 + 30 + 31 + 30)
      ),
      labels = c(
         "Jan-01",
         "Feb-01",
         "Mar-01",
         "Apr-01",
         "May-01",
         "Jun-01",
         "Jul-01"
      )
   )

```

### Gatton historical weather
```{r Gatton_weather, echo=FALSE}
# ______  Gatton  _______
max_T <- vector()
min_T <- vector()
for (i in 1:length(silo_gatton_Tmax[, 1])) {
   max_T <- c(max_T, mean(silo_gatton_Tmax$max_temp[i:(i + 7)]))
   min_T <- c(min_T, mean(silo_gatton_Tmax$min_temp[i:(i + 7)]))
}



# put maximum, minimum temperatures into a dataframe corresponding with their corresponding date
Gat_Tm_aver <-
   data.frame(
      location = "Gatton",
      date = as.Date(silo_gatton_Tmax$date),
      max_T,
      min_T,
      daily_rain = silo_gatton_Tmax$daily_rain
   )



# Add columns for Year and date to data
# Add columns for Year and date to data
Gat_Tm_aver$year <- substr(Gat_Tm_aver$date, start = 1, stop = 4)
Gat_Tm_aver$day <- sapply(Gat_Tm_aver$date,year2day)
   

# Create data subset of powdery mildew data means for the first sign of the disease by location

Gatton_FS <- PM.dat_sum[PM.dat_sum$location == "Gatton",]
Gatton_FS$day <- as.numeric(Gatton_FS$day)



ggplot(subset(Gat_Tm_aver, year == 2012),
       aes(day)) +
   geom_line(aes(y = max_T, colour = year)) +
   geom_line(aes(y = min_T, colour = year)) +
   labs(x = "Date", y = "Daily maximum temperature averaged over 7 days",
        title = "Maximum and minimum daily temperatures in Gatton") +
   theme(
      panel.grid.major = element_line(colour = "grey80"),
      panel.grid.minor = element_line(colour = "grey50"),
      panel.background = element_rect(fill = NA)
   ) +
   geom_vline(xintercept = Gatton_FS$day,
              colour = "green",
              size = 1) +
   geom_area(aes(y = daily_rain, fill = year), alpha = 0.5) +
   scale_y_continuous(sec.axis = dup_axis(name = "Rainfall (mm)")) +
   scale_x_continuous(
      limits = c(1, 180),
      breaks = c(
         1,
         32,
         (31 + 29),
         (31 + 29 + 31),
         (31 + 29 + 31 + 30),
         (31 + 29 + 31 + 30 + 31),
         (31 + 29 + 31 + 30 + 31 + 30)
      ),
      labels = c(
         "2012-Jan-01",
         "2012-Feb-01",
         "2012-Mar-01",
         "2012-Apr-01",
         "2012-May-01",
         "2012-Jun-01",
         "2012-Jul-01"
      )
   )

```
