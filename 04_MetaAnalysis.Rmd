---
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r MEsummary_Libraries2, message=FALSE, include=FALSE}
if (!require("pacman"))
   install.packages("pacman")
pacman::p_load(tidyverse,
               kableExtra,
               bomrang,
               RColorBrewer,
               metafor,
               here,
               netmeta,
               multcomp)

if (!require("theme.usq"))
   devtools::install_github("adamhsparks/theme.usq")
library(theme.usq)
theme_set(theme_usq())
source(here("R/reportP.R"))

# Data
load("cache/PreliminaryData.Rdata"
)

PM_MB_dat <-
   read.csv("cache/PM_MB_clean_data.csv", stringsAsFactors = FALSE)
```

# Grain yield meta-analysis

Let's get started with the analysis by first finding the best model fit that answers our research question.

> When, in relation to PM establishes in the crop, should farmers begin spraying mungbean to mitigate yield loss: before PM establishing, immediately after first sign of PM establishing, or after PM has become established in the crop. 

A secondary question to this aim is: given the time at which the first spray occurred does a second spray provide worthwhile yield protection.

To do this, in our model:

   - Grain yield is our response variable (t / ha)

   - Trial, which resolves combinations of categorical variables: year, location, row spacing, fungicide dose and cultivar; is set as a random intercept

### Define Trial
```{r define_trial}
PM_MB_dat <-
   PM_MB_dat %>%
   mutate(trial = paste(trial_ref,
                        year,
                        location,
                        host_genotype,
                        row_spacing,
                        sep = "_")) 
```

   - We will investigate the effect size of our treatment - spray management,


## metafor analysis

For the first grain yield meta-analysis will be an ARM based model using the `metafor` package [@Viechtbauer2010].

We are using the `spray_management` variable as a moderator and an interactive term to the `trial` random variable.

```{r Metafor-analysis}
PM_mv <- rma.mv(
   yi = grain_yield.t.ha.,
   vi,
   mods = ~ spray_management,
   method = "ML",
   random = list(~ spray_management | trial, ~ 1 | id),
   struct = "UN",
   control = list(optimizer = "optim"),
   data = PM_MB_dat
)

summary(PM_mv)
```

Let's try the model with an implied simpler variance-covariance matrix "compound symmetry" ("CS") to examine if unstructured matrix is suitable.
```{r}
PM_mv_cs <- rma.mv(
   yi = grain_yield.t.ha.,
   vi,
   mods = ~ spray_management,
   method = "ML",
   random = list(~ spray_management | trial, ~ 1 | id),
   struct = "CS",
   control = list(optimizer = "optim"),
   data = PM_MB_dat
)

anova(PM_mv, PM_mv_cs)
```

The test shows that the 'Full', more complicated model `PM_mv`, is a better fit and therefore we should keep the unstructured variance-covariance matrix.

The first table in the `PM_mv` output shows tau^2 (between trial variance) of each moderator random effects and the number of occurrences for each treatment in the analysis.
This effectively shows the heterogeneity between experiments for these particular treatments.


The tau^2 also gives us the heterogeneity between trials and indicates `Recommended_plus` showed the highest heterogeneity between experiments followed by `Late_plus`, `Late` then `Recommended`, with `Early` and the no-spray `control` showing the least heterogeneity.

The second table is in two parts (left and right). 
The left part, rho, is the correlation of variation between the specified treatments.
All comparisons were acceptable except for a comparison between `Early` and `Late_plus`, `0.000` rho.
`Early` and `Late_plus` treatments never occurred within the same trial, which is indicated by the right side of the table (hence the warning).  

In this result we can see that the `Early` treatment is not significantly different to the intercept, which in this case is the mean of the no spray `control`.
However the other treatments are significantly different from the no-spray control (intercept).
The $Q_M$ [omnibus test](http://www.metafor-project.org/doku.php/tips:models_with_or_without_intercept?s[]=anova) of moderators, shows the moderators significantly influence the model ($Q_M =$ `r PM_mv$QM` $,df =$ `r PM_mv$m`, `r reportP(PM_mv$QMp)`) and we can reject the null hypothesis ($H_0 : \beta_1 = \beta_2 = \beta_3 =\beta_4 = 0$) that there is no difference between the moderators [@Viechtbauer2010].
The analysis shows there is still a significant amount of residual heterogeneity ($Q_E =$ `r PM_mv$QE` $,df=$ `r PM_mv$k - PM_mv$m`, `r reportP(PM_mv$QEp)` ) not captured by the spray management moderator indicating other possible moderators which might influence grain yield.  

Let's present the meta-analysis results for the moderator variables in a forest style plot.
First Let's create a table of the results.

```{r metafor_results}
# obtain number of treatments included in each moderator variable
k5 <-
   as.data.frame(table(PM_MB_dat$trial, PM_MB_dat$spray_management)) %>%
   filter(Freq != 0) %>%
   group_by(Var2) %>%
   summarise(n()) %>%
   pull()

# create data.frame
results_mv <- data.frame(
   N = PM_mv$g.levels.k,
   k = k5,
   Effect = round(PM_mv$b, 4),
   se = round(PM_mv$se, 4),
   CI_lower = round(PM_mv$ci.lb, 4),
   CI_upper = round(PM_mv$ci.ub, 4),
   z_val = round(PM_mv$zval, 4),
   p_val = reportP(PM_mv$pval, AsNumeric = TRUE)
)

# adjust estimates to show absolute means
results_mv <-
   results_mv[2:6,] %>%
   mutate(Effect = Effect + results_mv$Effect[1]) %>%
   mutate(CI_lower = CI_lower + results_mv$CI_lower[1]) %>%
   mutate(CI_upper = CI_upper + results_mv$CI_upper[1]) %>%
   bind_rows(results_mv[1,]) %>%
   mutate(index = c(2:6, 1)) %>%
   arrange(index)

# rename colnames to give table headings
colnames(results_mv)[c(1:4, 6:9)] <-
   c("Treatment",
     "$N$",
     "$k$",
     "$\\mu$",
     "$CI_{L}$",
     "$CI_{U}$",
     "$Z$",
     "$P$")

# provide rownames for each moderator variable
row.names(results_mv) <- c(
   "Intercept / No Spray control",
   "$Early_{single}$",
   "$Recommended_{single}$",
   "$Recommended_{plus}$",
   "$Late_{single}$",
   "$Late_{plus}$"
)

kable(results_mv[, 2:9],
      align = "lcccccccc",
      booktabs = TRUE,
      caption = "Table ##: Estimated mean mungbean yields for each spray schedule treatment used for mitigating yield losses to powdery mildew in mungbean crops grown in eastern Australia. Yield estimates were calculated from the network meta-analysis of data obtained from grey literature reports. Z and P values indicate statistical significance in comparison to the intercept.")
```

Let's view these comparisons in a plot.

```{r metafor_plot}
results_mv %>%
   filter(Treatment != "control") %>%
   mutate(Treatment = factor(Treatment, levels = rev(
      c(
         "Early",
         "Recommended",
         "Recommended_plus",
         "Late",
         "Late_plus"
      )
   ))) %>%
   ggplot(aes(Treatment, `$\\mu$`)) +
   geom_hline(
      yintercept = seq(-0.05, 0.3, by = 0.05),
      color = usq_cols("usq charcoal"),
      linetype = 3
   ) +
   geom_hline(yintercept = 0) +
   geom_point(aes(size = 1 / se), shape = 15) +
   geom_linerange(aes(ymin = `$CI_{L}$`, ymax = `$CI_{U}$`)) +
   coord_flip() +
   #ggtitle("Mean spray schedule effect sizes\nand 95% confidence intervals")+
   ylab(expression(paste(
      "Mean yield difference to control (t ha" ^ -1, ")", sep = ""
   ))) +
   scale_x_discrete(
      "Moderator variable",
      labels = c(
         expression("Late"["plus"]),
         expression("Late"["single"]),
         expression("Recommended"["plus"]),
         expression("Recommended"["single"]),
         expression("Early"["single"])
      )
   )
ggsave("paper/figures/Fig2_means_difference.png",
       height = 3,
       dpi = 500)
```

Let's investigate the treatment contrasts

```{r PM_Mv_Contrast}
source("R/simple_summary.R") #function to provide a table that includes the treatment names in the contrasts
summary(glht(PM_mv, linfct = cbind(contrMat(rep(
   1, 6
), type = "Tukey"))), test = adjusted("none"))
contrast_Ssum <-
   simple_summary(summary(glht(PM_mv, linfct = cbind(
      contrMat(rep(1, 6), type = "Tukey")
   )), test = adjusted("none")))
contrast_Ssum
```

These contrasts can be viewed in a plot
```{r plotContrasts}
par(mar = c(5, 13, 4, 2) + 0.1)
plot(glht(PM_mv, linfct = cbind(contrMat(rep(
   1, 6
), type = "Tukey"))), yaxt = 'n')
axis(
   2,
   at = seq_along(contrast_Ssum$contrast),
   labels = rev(contrast_Ssum$contrast),
   las = 2,
   cex.axis = 0.8
)
```



### Profile plots

Let's inspect the profile plots to ensure the model is not over-fitted.
We expect to see the estimate align with the peak of the curve.
Also that the shape of the line is a curve.
Caution! this will take some time to run.

```{r profile_plots, eval=FALSE, message=FALSE, include=FALSE, results="hide"}
profile(PM_mv, tau2 = 1)
profile(PM_mv, tau2 = 2)
profile(PM_mv, tau2 = 3)
profile(PM_mv, tau2 = 4)
profile(PM_mv, tau2 = 5)
profile(PM_mv, tau2 = 6)
```



### Forest plot of trial treatment effect per trial
Let's look at the trial variability in this model with a forest plot
```{r forestP, eval=FALSE, fig.height=40, fig.width=17, include=FALSE}
# THIS NEEDS TO BE FIXED
source(here("R/change_labels.R"))
source(here("R/forest_rows.R"))

# Sort and arrange data-frame accordingly and produce a index vector to inform
# the order of each "Trial" on the plot
index1 <- PM_MB_dat %>%
   mutate(ID = seq_along(trial_ref)) %>%
   mutate(spray_management =
             factor(
                spray_management,
                levels = c(
                   "Early",
                   "Late",
                   "Recommended",
                   "Recommended_plus",
                   "Late_plus"
                )
             )) %>%
   arrange(desc(spray_management), location, desc(grain_yield.t.ha.)) %>%
   mutate(ID2 = order(ID)) %>%
   pull(ID2)

# Use forest rows function to return a list of where to place on the plot:
# sub-titles, each trial row, and summary prediction for each treatment.
# this list can be used below to reference where to plot each variable
rows1 <- forest_rows(
   head_row = 186,
   ord_var = PM_MB_dat$spray_management,
   index = index1,
   gap = 5,
   row_offset = -2
)

# A data-frame of meta-model coefficients used to produce the summary polygons
# for each treatment
polys <- data.frame(
   ref = change_labels(names(coef(PM_mv))),
   x = c(coef(PM_mv)[1], coef(PM_mv)[1] + coef(PM_mv)[2:6]),
   ci.lb = c(PM_mv$ci.lb[1], PM_mv$ci.lb[1] + PM_mv$ci.lb[2:6]),
   ci.ub = c(PM_mv$ci.ub[1], PM_mv$ci.ub[1] + PM_mv$ci.ub[2:6])
)[c(2, 5, 3, 4, 6, 1), ]
polys$rows <- rows1$pred_row - 1.5

forest1  <- metafor::forest(
   PM_mv,
   cex = 1.15 ,
   width = 5,
   #order = "fit",
   rows = rows1$trows - 1.5,
   ilab = cbind(
      PM_MB_dat$year,
      PM_MB_dat$row_spacing,
      PM_MB_dat$host_genotype,
      PM_MB_dat$dose
   ),
   ilab.xpos = c(-2.35, -2.1, -1.8, -1.4) + 1,
   slab = NA,
   xlim = c(-2, 4),
   ylim = c(5, 190),
   xlab = "Grain yield mean difference",
   addfit = FALSE,
   efac = c(0.2, 0.15, 0.2),
   at = seq(-0.5, 3, 0.5)
)

### code which puts lines and annotations on the plot, its a bit long...
source(here("R/add_annotations.R"))

```



****

## netmeta analysis

We can use the `netmeta` package to give a graphical representation of the pairwise comparisons.

Let's analyse the data again using a different statistical approach to see if our outcome with the `metafor` package was robust.
The `netmeta` package uses a frequentist approach to the analysis and focuses on the pairwise comparisons between treatments.

```{r netmeta-analysis}
datPM3 <- PM_MB_dat %>%
   group_by(trial, spray_management, n) %>%
   summarize(yi_mean = mean(grain_yield.t.ha.),
             vi_mean = mean(vi)) %>%
   ungroup()

PM_con <- pairwise(
   treat = spray_management,
   n = n,
   mean = yi_mean,
   sd = sqrt(vi_mean),
   studlab = trial,
   data = datPM3,
   sm = "MD"
)

net_con <- netmeta(TE,
                   seTE,
                   treat1,
                   treat2,
                   studlab,
                   data = PM_con,
                   sm = "MD")

summary(net_con)
```

Now let's visualise this as a forest plot.

```{r netmeta-forest}
forest(
   net_con,
   reference.group = 1,
   rightcols = c("effect", "ci", "Pscore"),
   rightlabs = "P-Score",
   small.values = "bad"
)
```

The `netmeta` analysis suggests the spray schedule commencing early are no different to any other treatment including the no spray `control`.
It estimates the mean is very similar to the recommended treatments.
The `Recommended_plus` and `Late_plus` treatments show higher mean estimates, however are not significantly different from the `Early` estimate.

```{r netgraphGW}
netgraph(
   net_con,
   plastic = FALSE,
   col = usq_cols("support orange"),
   thickness =  "number.of.studies",
   points = FALSE,
   col.points = usq_cols("usq charcoal"),
   cex.points = 1,
   number.of.studies = TRUE,
   cex.number.of.studies = 1,
   col.number.of.studies = "black",
   bg.number.of.studies = usq_cols("support orange"),
   multiarm = FALSE,
   col.multiarm = usq_cols("support turquiose"),
   pos.number.of.studies = 0.4
)
```

```{r}
netleague(net_con)

decomp.design(net_con)

netsplit(net_con)

nm1 <- netmeasures(net_con)

plot(
   nm1$meanpath,
   nm1$minpar,
   pch = "",
   xlab = "Mean path length",
   ylab = "Minimal parallelism"
)
text(nm1$meanpath, nm1$minpar, names(nm1$meanpath), cex = 0.8)
```



```{r Save_meta_data, eval=FALSE}
save(efficacy,
     PM_MB_dat,
     PM_mv,
     contrast_Ssum,
     file = here("cache/Meta-analysisData.Rdata"))
```


